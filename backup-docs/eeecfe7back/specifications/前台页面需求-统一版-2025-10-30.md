# 前台页面需求 - 统一版（/film、/gallery、/map、/admin）

版本：v2025-10-30
状态：草案（待你确认）

---

## 0. 术语与规则
- 启封：拆包装；统一用“启封”。
- 冲洗：统一使用“冲洗”（不使用“开发”表述）。
- 归档：最终完成阶段（扫描完成后点击归档）。
- 时间轴展示规则：仅展示“归档”状态的胶卷，按归档时间（archived_date）由近到远。按月份分组。
- 冲洗工艺库初始枚举：C-41 / E-6 / D-76 / XTOL / Rodinal / HC-110 / Other（可后续扩展）。
- 冲洗工艺库为结构化数据（可维护默认温度/稀释/时间；支持品类覆盖）。
- 冲洗票号（ticket_no）：采用“日期+序号”格式，例如 2025-10-30-001。
- 入库方式：当前仅“扫描入库”（scan），翻拍（copy）暂不启用；后续可扩展。
- 推拉（Push/Pull）：指在冲洗阶段对感光度的补偿处理（延长/缩短时间或改变稀释/温度），影响推荐时间；可作为可选字段记录。

---

## 1. /film 页面（两个视图）

### 1.1 视图一：时间轴视图（按时间浏览“我在什么时候拍了什么”）
- 目标：按完成作品呈现拍摄历史。
- 显示内容：仅显示“归档”状态的胶卷。
- 分组：按 archived_date 的年月分组。
- 排序：archived_date 倒序（由近到远）。
- 卡片信息：
  - 品类（品牌/系列/ISO/类型/格式）
  - 归档日期（archived_date）
  - 照片数量
  - 冲洗工艺摘要（来自冲洗记录的 wash_process）
  - 扫描仪摘要（scanner_id 对应的设备名）
- 交互：
  - 点击卡片 → 打开胶片条查看（或详情页）
  - 顶部/侧边筛选（可选）：品类、品牌、格式、类型、年份

### 1.2 视图二：品类视图（“我都有哪些胶卷，用了几卷，还剩几卷”）
- 目标：面向库存与品类使用追踪。
- 分组：按胶卷品类（film_stock）分组。
- 每个品类卡片信息：
  - 品牌/系列/ISO/类型/格式
  - 使用统计：
    - 归档：X 卷
    - 待处理：X 卷（待冲洗+待扫描）
    - 拍摄中：X 卷
    - 库存中：X 卷（入库/启封未拍完）
  - 最近一次使用时间、最近一次归档时间
- 交互：
  - 点击品类 → 进入品类详情页 `/film/stocks/:id`
  - 品类详情页包含：品类参数图文、特点、标准冲洗工艺时间（来自库）、本品类覆盖参数、使用历史（实例列表）

### 1.3 胶卷状态机与动作

| 阶段/状态 | 触发动作 | 必填字段 | 可选字段 | 结构化引用/约束 | 事件类型 |
|---|---|---|---|---|---|
| 入库（采购） | 新建胶卷 | stock_in_date | notes | — | purchase |
| 拍摄中 | 启封 | opened_date, camera_id | camera_lens, notes | camera_id→cameras | open |
| 待冲洗 | 拍摄完毕 | finished_date | notes | — | shoot_finished |
| 待扫描 | 冲洗完成（创建冲洗记录） | wash_order_id, washed_date, wash_process_id, wash_method | wash_vendor_id（third_party 必填）, wash_notes, push_pull | wash_order_id→wash_orders；wash_process_id→wash_processes；wash_method in {self, third_party}；wash_vendor_id→wash_vendors | wash_finished |
| 归档 | 扫描完成并归档 | archived_date, archive_method, scanner_id | scan_resolution, scan_bit_depth, scan_notes | archive_method 固定 scan；scanner_id→scanners | archived |

说明：
- 点击“冲洗完成”时，自动创建 `wash_orders` 并生成 `ticket_no=YYYY-MM-DD-XXX`。
- 时间轴只显示“归档”状态；品类视图显示所有状态并统计。

### 1.4 结构化实体（为冲洗时间标准与可追溯而设）
- wash_processes（冲洗工艺库，标准化）
  - id, name(C-41/E-6/D-76/XTOL/Rodinal/HC-110/Other), chemistry_family(color_negative/slide/bw)
  - default_temperature, default_dilution, default_time_sec, notes
- film_stock_process_overrides（品类-工艺参数覆盖）
  - id, film_stock_id, wash_process_id, temperature, dilution, time_sec, notes
- wash_vendors（冲洗商家）
  - id, name, contact?, notes
- wash_orders（冲洗记录/票号）
  - id, ticket_no(日期+序号), film_roll_id, wash_process_id, wash_method(self/third_party), wash_vendor_id?, washed_date, push_pull?, wash_notes
- scanners（扫描仪）
  - id, brand, model, notes
- film_roll_events（动作日志）
  - id, film_roll_id, type(purchase/open/shoot_finished/wash_finished/archived), occurred_at, operator, payload(JSON)

### 1.5 冲洗时间查询页（规划）
- 查询维度：胶卷品类（brand/series/ISO/format）+ 工艺（wash_process）+ 可选推拉（push/pull 档位）。
- 数据来源：`film_stock_process_overrides` 优先；无覆盖则回退 `wash_processes` 默认值。
- 结果：推荐温度/稀释/时间，并可列出历史 wash_orders 作为参考样本。

---

## 2. /gallery 页面（与现状一致，粒度与 /film 对齐）

### 2.1 视图模式
- 平铺视图：标准栅格；分页/懒加载；顶部模式切换按钮。
- 瀑布流视图：原生 CSS Grid Masonry，按长宽比自适配；懒加载。
- 随机模式：基于“胶卷暗盒”交互，随机选择胶卷并抽取若干张照片；点击进入全局 `PhotoPreview`。

### 2.2 筛选器
- 隐藏加密
- 胶卷类型（彩色负片/黑白/反转）
- 胶卷画幅（135/120/...）

### 2.3 预览
- 统一 `PhotoPreview`；点击地点显示迷你地图（只读）；默认 zoom=12。
- 旋转、沉浸模式（全屏）、键盘导航。

### 2.4 分页/加载
- 初始加载 + 滚动懒加载；错误与空态处理。

---

## 3. /map 页面

### 3.1 地图源与降级
- 默认 MapTiler 矢量；自动降级至栅格 PNG；兜底 OSM；最大显示 15x。
- 配额/限额管理与监控（已实现，文档化）。

### 3.2 标记与预览
- 一次性绘制全部可见照片（分页循环请求）。
- 标记点击打开 `PhotoPreview`；只显示有权限的照片。
- 标记样式统一为小圆点；移除自动 flyTo 干扰。

### 3.3 搜索与地址
- 地名搜索（MapTiler Geocoding），中英文支持。
- 逆地理编码，优先中文；港澳台处理“清理英中混合”。

### 3.4 管理动作（关联 /admin）
- 批量补录（历史未标点照片）：后台多选 → 统一选点 → 批量写入。
- 表单“解析地址”按钮（单张/批量上传、编辑表单均提供）。

---

## 4. /admin 管理后台（与现状一致，补全与 /film 的联动）

### 4.1 模块
- 照片管理：上传、批量上传、旋转、元数据编辑（含地点字段统一化）。
- 胶卷实例管理：列表、筛选、状态流转动作（启封、拍摄完毕、冲洗完成、归档）。
- 胶卷品类管理（film_stocks）：品牌/系列/ISO/类型/格式/图片。
- 相机管理、扫描仪管理、商家管理（wash_vendors）。
- 地图/地址工具：地址解析、坐标补录。

### 4.2 与 /film 的联动
- 胶卷状态动作：
  - 启封：opened_date + camera_id（必填）
  - 拍摄完毕：finished_date
  - 冲洗完成：创建 wash_order（生成 ticket_no），washed_date + wash_process_id + wash_method；若 third_party，wash_vendor_id 必填
  - 归档：archived_date + scanner_id（必填）；archive_method=scan
- 所有动作写入 film_roll_events，payload 存补充参数。

### 4.3 统计/查询（可选）
- 各状态卷数统计、常用工艺分布、常用扫描仪分布。
- 冲洗时间查询页入口：按品类+工艺+推拉，展示推荐参数与历史样本。

---

## 5. 数据字段对齐与命名（建议）
- 胶卷实例 film_rolls：
  - stock_in_date, opened_date, finished_date, archived_date
  - camera_id, scanner_id, status ∈ {stock_in, shooting, pending_wash, pending_scan, archived}
- 冲洗相关：
  - wash_orders：id, ticket_no(YYYY-MM-DD-###), film_roll_id, wash_process_id, wash_method(self/third_party), wash_vendor_id?, washed_date, push_pull?, wash_notes
  - wash_processes：id, name, chemistry_family, default_temperature, default_dilution, default_time_sec, notes
  - film_stock_process_overrides：id, film_stock_id, wash_process_id, temperature, dilution, time_sec, notes
  - wash_vendors：id, name, contact?, notes
- 扫描相关：
  - scanners：id, brand, model, notes；归档时 scanner_id 必填
  - 归档扩展：archive_method=scan, scan_resolution?, scan_bit_depth?, scan_notes?
- 事件日志：film_roll_events（type, occurred_at, payload）

---

## 6. 验收清单（初版）
- /film 时间轴仅展示“归档”，按 archived_date 倒序，按月分组。
- /film 品类视图显示品类统计（归档/待处理/拍摄中/库存中），并可进入品类详情页。
- 状态流转四个动作的参数填写与校验（启封、拍摄完毕、冲洗完成、归档）。
- 冲洗记录创建：生成 ticket_no（日期+序号）；third_party 必选商家。
- 工艺/时间结构化：wash_processes + film_stock_process_overrides。
- 归档仅 scan 分支；要求 scanner_id；时间轴卡片显示工艺与扫描摘要。
- /gallery 三视图、筛选、预览、懒加载与现状一致并文档化。
- /map 三源降级、标记权限、搜索与中文地址、回归清单化。
- /admin 动作与 /film 联动；事件日志落库。

---

## 7. 待确认事项
1) 工艺库是否先导入初始参数（温度/稀释/时间）？初版可给“参考值”，后续按实际修订。
2) ticket_no 的每日编号是否从 001 递增并按日重置？
3) 品类详情页里“冲洗时间查询”是否展示默认与覆盖两层，并可按推拉筛选？
4) 时间轴卡片是否需要显示“拍摄起止时间”（若有 finished/opened）？
