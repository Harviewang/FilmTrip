# /film 模块 需求说明（时间轴视角 + 品类视角）

版本：v2025-10-30（草案）
状态：待确认

---

## 1. 目标与范围
- 目标：提供胶片摄影在“时间线维度”和“品类维度”的双视角浏览与管理，覆盖状态流转、冲洗记录、扫描归档的关键链路。
- 范围：
  - 时间轴视图（按归档时间展示已完成作品）
  - 品类视图（按胶卷品类聚合，兼顾库存与使用追踪）
  - 状态机动作：启封、拍摄完毕、冲洗完成、归档
  - 冲洗记录（票号）与工艺库（结构化）

---

## 2. 用户故事（关键用例）
1) 我想按时间回顾我最近完成了哪些胶卷（只看“归档”的）。
2) 我想按胶卷品类查看我用过多少卷、还剩多少、哪些在处理中。
3) 我想把一卷从“入库（采购）”到“归档”的全过程规范记录，避免多卷混淆。
4) 我想创建冲洗记录并生成票号，区分不同胶卷和底片。
5) 我想在品类详情页查看标准冲洗时间与我历史的冲洗记录样本。

---

## 3. 状态机与动作

### 3.1 状态定义
- stock_in（入库/采购）
- shooting（拍摄中）
- pending_wash（待冲洗）
- pending_scan（待扫描）
- archived（归档）

仅 archived 出现在“时间轴视图”。

### 3.2 动作与字段
| 动作 | 从 → 到 | 必填 | 可选 | 约束/说明 |
|---|---|---|---|---|
| 启封 | stock_in → shooting | opened_date, camera_id | camera_lens, notes | 统一术语“启封”；进入“拍摄中” |
| 拍摄完毕 | shooting → pending_wash | finished_date | notes | — |
| 冲洗完成 | pending_wash → pending_scan | washed_date, wash_process_id, wash_method | wash_vendor_id(third_party必填), wash_notes, push_pull | 点击后自动创建 wash_order 与 ticket_no（日期+序号） |
| 归档 | pending_scan → archived | archived_date, archive_method=scan, scanner_id | scan_resolution, scan_bit_depth, scan_notes | 目前仅扫描入库；翻拍后续扩展 |

所有动作写入 `film_roll_events`，payload 存补充参数。

---

## 4. 数据模型与字段

### 4.1 胶卷实例 film_rolls（新增/对齐字段）
- id, film_stock_id, status
- stock_in_date（入库/采购时间）
- opened_date（启封时间）
- finished_date（拍摄完毕时间）
- archived_date（归档时间）
- camera_id, scanner_id
- notes

### 4.2 冲洗相关结构
- wash_processes（冲洗工艺库，结构化维护）
  - id, name(C-41/E-6/D-76/XTOL/Rodinal/HC-110/Other), chemistry_family(color_negative/slide/bw)
  - default_temperature, default_dilution, default_time_sec, notes
- film_stock_process_overrides（品类-工艺覆盖）
  - id, film_stock_id, wash_process_id, temperature, dilution, time_sec, notes
- wash_vendors（冲洗商家）
  - id, name, contact?, notes
- wash_orders（冲洗记录/票号）
  - id, ticket_no(YYYY-MM-DD-###), film_roll_id, wash_process_id, wash_method(self/third_party), wash_vendor_id?, washed_date, push_pull?, wash_notes

### 4.3 扫描相关
- scanners：id, brand, model, notes
- 归档扩展：archive_method=scan, scan_resolution?, scan_bit_depth?, scan_notes?

### 4.4 事件日志 film_roll_events
- id, film_roll_id, type(purchase/open/shoot_finished/wash_finished/archived), occurred_at, operator, payload(JSON)

---

## 5. 交互与页面

### 5.1 时间轴视图（/film?view=time）
- 列表：仅显示 archived 卷，按 archived_date 倒序；按月分组。
- 卡片字段：品类（品牌/系列/ISO/类型/格式）、归档日期、照片数、冲洗工艺徽标、扫描仪摘要。
- 交互：点击卡片 → 胶片条查看器/详情。
- 筛选（可选）：品牌、系列、格式、类型、年份。

### 5.2 品类视图（/film?view=stock）
- 分组：按 film_stocks 聚合；
- 统计：归档/待处理（待冲洗+待扫描）/拍摄中/库存中；最近使用时间；
- 交互：点击品类 → `/film/stocks/:id` 详情页；详情页包含工艺标准与覆盖、实例列表与冲洗样本链接。

### 5.3 状态动作入口
- 在 /admin 或 /film 的卡片/详情中提供动作按钮：启封、拍摄完毕、冲洗完成、归档；
- 动作弹窗按“必填/可选”规则校验；提交后刷新列表与统计。

---

## 6. 边界条件与校验
- 时间轴只展示 archived；其余状态不出现。
- wash_method=third_party 时，wash_vendor_id 必填。
- 归档时 scanner_id 必填；archive_method 固定 scan。
- ticket_no：按日从 001 递增；避免重复（同日同号需校验唯一性）。
- 状态流转不可跳级（必须按动作顺序），回退需手动处理并记录事件。

---

## 7. 与其他模块的联动
- /gallery：预览与随机模式共用 `PhotoPreview`；归档后的照片在图库可见。
- /map：归档照片参与地图标记；权限过滤一致。
- /admin：提供动作与参数维护页面（工艺库/商家/扫描仪）。

---

## 8. API 草案（示例）
- GET /api/film?view=time → { groups: [{ month: '2025-10', rolls: [...] }] }
- GET /api/film?view=stock → { stocks: [{ stock: {...}, stats: {...}, lastUsedAt, lastArchivedAt }] }
- POST /api/filmRolls/:id/open { opened_date, camera_id }
- POST /api/filmRolls/:id/finish { finished_date }
- POST /api/filmRolls/:id/wash-finish { washed_date, wash_process_id, wash_method, wash_vendor_id? }
- POST /api/filmRolls/:id/archive { archived_date, scanner_id, scan_resolution?, scan_bit_depth?, scan_notes? }
- GET /api/wash-processes, POST /api/wash-processes
- GET /api/wash-orders?film_roll_id=...

---

## 9. 验收清单
- 时间轴只显示归档卷；按月分组、倒序；卡片字段完整。
- 品类视图统计准确；可进入详情页；展示工艺标准与覆盖。
- 四个状态动作校验规则落地；事件日志记录完整。
- ticket_no 生成规则正确且唯一。
