# /map 模块 需求说明（地图与标记）

版本：v2025-10-30（草案）
状态：待确认

---

## 1. 目标与范围
- 提供统一稳定的地图浏览体验：矢量 → 栅格 → OSM 自动降级，最大显示 15x。
- 展示全部可见照片标记，点击进入统一的 `PhotoPreview`。

---

## 2. 地图源与降级
- 默认 MapTiler 矢量样式；
- 降级顺序：MapTiler 栅格 PNG → OSM 栅格；
- 配额/限额检测与自动切换；
- Service Worker 瓦片缓存（7天TTL，1000瓦片）；
- 月初恢复为矢量。

---

## 3. 标记/交互
- 首屏分页循环请求，合并渲染全部可见照片；
- 标记样式统一（小圆点）；
- 点击标记 → `PhotoPreview`；
- 权限过滤：仅展示有权限的照片资源。

---

## 4. 搜索与地址
- 地名搜索（MapTiler Geocoding），支持中英文；
- 逆地理编码：优先中文（本地映射与清理港澳台英中混合）。

---

## 5. 管理动作联动
- 批量补录（后台）：多选 → 统一选点 → 批量写入；
- 单张/批量上传、编辑表单提供“解析地址”按钮。

---

## 6. 边界条件
- OSM CORS 处理与兜底；
- 大量标记的性能优化（节流/聚合可选）；
- 地图源失效时的可用性保障（提示与重试）。

---

## 7. 与其他模块联动
- /gallery：标记预览统一；
- /film：时间轴与品类视图不直接依赖地图，但归档作品会出现在地图。
- /admin：地址与坐标管理、批量补录工具。

---

## 8. API 草案
- GET /api/map/photos?page&limit
- GET /api/geocode/reverse?lat&lng
- GET /api/geocode/search?q

---

## 9. 验收清单
- 三源自动降级与配额管理可用；
- 标记一次性加载正确，权限过滤生效；
- 搜索与逆地理编码稳定；
- 批量补录工具链路通畅。