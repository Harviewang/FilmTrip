# 表单状态管理最佳实践

## 📋 问题背景

在多个表单（上传、编辑、批量上传等）共存的组件中，经常出现以下问题：

1. **状态污染**：一个表单的操作影响另一个表单的状态
2. **重复代码**：每个表单都需要独立的初始化、重置逻辑
3. **难以维护**：状态分散，难以统一管理

## ✅ 解决方案

### 1. 使用 `useFormState` Hook（推荐）

适用于单个表单的场景。

```jsx
import { useFormState } from '../hooks/useFormState';

const MyComponent = () => {
  // 定义表单初始值
  const initialValues = {
    title: '',
    description: '',
    file: null,
    is_protected: false
  };

  // 使用Hook管理表单状态
  const [form, formHandlers] = useFormState(initialValues);

  // 更新单个字段
  const handleInputChange = (field, value) => {
    formHandlers.setField(field, value);
  };

  // 重置表单
  const handleReset = () => {
    formHandlers.reset();
  };

  return (
    <form>
      <input 
        value={form.title} 
        onChange={(e) => handleInputChange('title', e.target.value)} 
      />
      <button onClick={handleReset}>重置</button>
    </form>
  );
};
```

### 2. 使用 `useMultipleForms` Hook

适用于同一组件中有多个表单的场景。

```jsx
import { useMultipleForms } from '../hooks/useFormState';

const PhotoManagement = () => {
  const { forms, handlers } = useMultipleForms({
    // 上传表单
    upload: {
      title: '',
      description: '',
      file: null,
      is_protected: false
    },
    // 编辑表单
    edit: {
      title: '',
      description: '',
      is_protected: false
    },
    // 批量上传表单
    batch: {
      film_roll_id: '',
      files: [],
      is_protected: false
    }
  });

  const handleUpload = async () => {
    // 使用 forms.upload 访问上传表单数据
    console.log(forms.upload);
    
    // 提交后重置
    handlers.upload.reset();
  };

  const handleEdit = async () => {
    // 使用 forms.edit 访问编辑表单数据
    console.log(forms.edit);
    
    // 提交后重置
    handlers.edit.reset();
  };

  // 编辑时，填充表单数据
  const handleEditClick = (photo) => {
    handlers.edit.replace({
      title: photo.title,
      description: photo.description,
      is_protected: photo.is_protected
    });
  };

  return (
    <div>
      {/* 上传表单 */}
      <UploadForm 
        form={forms.upload} 
        onChange={handlers.upload.setField}
      />
      
      {/* 编辑表单 */}
      <EditForm 
        form={forms.edit}
        onChange={handlers.edit.setField}
      />
    </div>
  );
};
```

## 🎯 核心优势

### 1. **状态隔离**
每个表单的状态完全独立，互不干扰。

### 2. **代码复用**
统一的表单管理逻辑，减少重复代码。

### 3. **易于维护**
状态管理逻辑集中，便于调试和维护。

### 4. **类型安全**
通过JSDoc注释提供完整的类型提示。

## 📝 使用指南

### 初始化表单

```jsx
// 定义初始值
const initialValues = {
  name: '',
  email: '',
  age: 0,
  avatar: null
};

// 使用Hook
const [form, handlers] = useFormState(initialValues);
```

### 更新字段

```jsx
// 方式1：单个字段更新
handlers.setField('name', 'John');

// 方式2：批量更新
handlers.setFields({
  name: 'John',
  email: 'john@example.com'
});
```

### 重置表单

```jsx
// 重置为初始值
handlers.reset();

// 重置为指定值
handlers.reset({ name: 'Default Name' });
```

### 完整替换

```jsx
// 完全替换表单状态（适用于编辑场景）
const photo = { title: 'Photo 1', description: 'Desc' };
handlers.replace(photo);
```

## 🔄 迁移指南

### 从传统方式迁移

**之前的代码：**
```jsx
const [uploadForm, setUploadForm] = useState({
  title: '',
  file: null
});

const resetUploadForm = () => {
  setUploadForm({
    title: '',
    file: null
  });
};

// 更新字段
setUploadForm({ ...uploadForm, title: 'New Title' });
```

**迁移后的代码：**
```jsx
const [uploadForm, uploadHandlers] = useFormState({
  title: '',
  file: null
});

// 重置表单
uploadHandlers.reset();

// 更新字段
uploadHandlers.setField('title', 'New Title');
```

## ⚠️ 注意事项

### 1. 初始值定义
确保初始值与表单字段完全对应，避免遗漏字段。

```jsx
// ❌ 不好：遗漏字段
const [form, handlers] = useFormState({
  name: '',
  // 缺少 email 字段
});

// ✅ 好：完整的初始值
const [form, handlers] = useFormState({
  name: '',
  email: '',
  age: 0
});
```

### 2. 文件上传字段
文件类型的字段初始值应为 `null` 而不是空字符串。

```jsx
const [form, handlers] = useFormState({
  title: '',
  file: null,  // ✅ 文件字段使用 null
  avatar: null // ✅ 图片字段使用 null
});
```

### 3. 布尔值字段
布尔值字段初始值应该是 `false` 而不是空字符串。

```jsx
const [form, handlers] = useFormState({
  is_protected: false,  // ✅ 布尔值使用 false
  is_public: false
});
```

## 🎨 实际应用示例

参考项目中的 `frontend/src/views/PhotoManagement.jsx` 文件，查看完整的使用示例。

## 📚 相关文档

- [React Hooks 官方文档](https://react.dev/reference/react)
- [useCallback Hook](https://react.dev/reference/react/useCallback)
- [useState Hook](https://react.dev/reference/react/useState)

