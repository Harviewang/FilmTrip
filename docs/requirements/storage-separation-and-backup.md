# 存储分离和备份需求

## 日期
2025-11-13

## 需求概述

### 1. 存储路径分离 ✅ 已实现

#### 当前存储结构
- **照片（胶片底片扫描）**: 
  - 本地存储：`/uploads/` 目录
  - 又拍云存储：使用 `origin_bucket` 和 `origin_path` 字段（通过又拍云直传）
  - 路径格式：`{prefix}/{shortCode}.{ext}` 或 `{prefix}/{hash}.{ext}`（已优化）

- **相机图片**: 
  - 存储路径：`/uploads/cameras/`
  - 文件名格式：`{timestamp}-{random}.{ext}`
  - **状态**：✅ 已独立存储，不会与照片混淆

- **胶卷品类图片**（包装图/卷体图）:
  - 存储路径：`/uploads/filmStocks/`
  - 文件名格式：`{timestamp}-{random}.{ext}`
  - **状态**：✅ 已独立存储，不会与照片混淆

- **胶片底片照片**（原始扫描）:
  - 存储路径：`/uploads/Film_roll/roll_{id}/photos/`
  - **状态**：✅ 已独立存储，不会与照片混淆

#### 结论
✅ **存储路径已完全分离，不会混淆**

### 2. 迁移又拍云建议 ⚠️ 待规划

#### 当前状态
- ✅ 照片已支持又拍云存储（直传）
- ❌ 相机图片：仍使用本地存储
- ❌ 胶卷品类图片：仍使用本地存储
- ❌ 胶片底片照片：仍使用本地存储

#### 建议方案
**方案1：相机和胶卷图片迁移到又拍云**（推荐）
- 优点：
  - 统一存储方案，便于管理
  - 利用CDN加速，提升访问速度
  - 减少本地服务器存储压力
- 缺点：
  - 需要改造上传接口
  - 需要数据迁移
- 实施步骤：
  1. 扩展又拍云服务，支持相机/胶卷图片上传
  2. 添加新的bucket或路径前缀（如 `cameras/`、`filmStocks/`）
  3. 改造上传接口，支持又拍云直传
  4. 数据迁移：将现有图片迁移到又拍云

**方案2：保持现状**（胶片底片照片除外）
- 优点：
  - 无需改造
  - 相机和胶卷图片通常较小，本地存储足够
- 缺点：
  - 存储方案不统一
  - 无法利用CDN加速

#### 推荐决策
**建议方案1**：将相机和胶卷品类图片迁移到又拍云
- **胶片底片照片**：建议保持本地存储或单独bucket（用户建议）
- **相机图片**：迁移到又拍云（独立路径：`cameras/{id}.{ext}`）
- **胶卷品类图片**：迁移到又拍云（独立路径：`filmStocks/{id}.{ext}`）

---

### 3. 元数据备份机制 ⚠️ 待实施（需求池）

#### 需求描述
所有元数据定期存档，方便服务器或CDN挂了随时恢复。

#### 备份范围
1. **数据库备份**
   - `photos` 表：所有照片元数据
   - `cameras` 表：相机信息
   - `film_stocks` 表：胶卷品类信息
   - `film_rolls` 表：胶卷实例信息
   - `storage_files` 表：又拍云文件信息
   - `storage_actions` 表：存储操作日志

2. **文件路径映射**
   - 照片：`origin_bucket` + `origin_path` + `filename`
   - 相机：`image` 字段（本地路径或又拍云路径）
   - 胶卷品类：`package_image` + `cartridge_image`（本地路径或又拍云路径）

3. **关联关系**
   - 照片与胶卷、相机、专辑的关联关系
   - 文件哈希值（用于去重和验证）

#### 备份方案

**方案1：数据库导出 + 文件列表导出**
- 定期导出SQLite数据库文件
- 导出文件路径列表（JSON格式）
- 存储到本地备份目录或云存储

**方案2：结构化JSON导出**
- 导出完整的数据库记录为JSON
- 包含文件路径、哈希值、关联关系
- 便于快速恢复和验证

**方案3：增量备份**
- 每日增量备份（只备份变更记录）
- 每周全量备份
- 减少存储空间

#### 实施建议

**技术方案**：
```javascript
// backend/scripts/backup-metadata.js
// 1. 导出数据库为JSON
// 2. 导出文件路径映射
// 3. 计算文件哈希值（可选）
// 4. 压缩并上传到云存储（可选）
```

**备份频率**：
- 每日备份（凌晨执行）
- 保留最近30天的备份
- 每月保留一个完整备份

**备份存储**：
- 本地备份目录：`backend/backups/`
- 云存储备份（可选）：阿里云OSS、又拍云等

**恢复机制**：
```javascript
// backend/scripts/restore-metadata.js
// 1. 从备份文件恢复数据库
// 2. 验证文件完整性（通过哈希值）
// 3. 修复缺失的文件引用
```

---

### 4. 后台新增功能检查 ✅ 已检查

#### 相机管理
- ✅ `POST /api/cameras` - 创建相机（支持图片上传）
- ✅ `PUT /api/cameras/:id` - 更新相机（支持图片更新）
- ✅ `DELETE /api/cameras/:id` - 删除相机（检查关联照片）
- **状态**：功能正常，无问题

#### 胶卷品类管理
- ✅ `POST /api/filmStocks` - 创建胶卷品类（支持包装图/卷体图上传）
- ✅ `PUT /api/filmStocks/:id` - 更新胶卷品类（支持图片更新）
- ✅ `DELETE /api/filmStocks/:id` - 删除胶卷品类（检查关联胶卷实例）
- **状态**：功能正常，无问题

#### 照片管理
- ✅ `POST /api/photos` - 单张上传（支持又拍云直传）
- ✅ `POST /api/photos/batch` - 批量上传（支持又拍云直传）
- ✅ `PUT /api/photos/:id` - 更新照片信息
- ✅ `DELETE /api/photos/:id` - 删除照片
- **状态**：功能正常，无问题

#### 发现的问题 ⚠️

**问题1：filmStockController.js 第414行使用 `insert` 执行 UPDATE**
```javascript
// 当前代码（第414行）
const result = insert(
  `UPDATE film_stocks SET ... WHERE id = ?`,
  [...]
);
```
**影响**：虽然功能可能正常，但语义不正确，应该使用 `update` 方法。

**修复建议**：
```javascript
// 应改为
const result = update(
  `UPDATE film_stocks SET ... WHERE id = ?`,
  [...]
);
```

**问题2：filmStockController.js 第478行使用 `insert` 执行 DELETE**
```javascript
// 当前代码（第478行）
const result = insert('DELETE FROM film_stocks WHERE id = ?', [id]);
```
**影响**：虽然功能可能正常，但语义不正确，应该使用 `deleteRecord` 方法。

**修复建议**：
```javascript
// 应改为
const result = deleteRecord('DELETE FROM film_stocks WHERE id = ?', [id]);
```

---

## 总结

### ✅ 已完成
1. **存储路径分离**：相机、胶卷、照片已完全分离存储
2. **后台功能检查**：功能正常，但有代码规范问题（待修复）

### ⚠️ 待实施（需求池）
1. **相机和胶卷图片迁移到又拍云**：建议迁移，统一存储方案
2. **元数据备份机制**：建议实施，每日备份，支持快速恢复
3. **代码规范修复**：`filmStockController.js` 中的 `insert` 误用问题

### 📋 优先级
1. **P0（紧急）**：代码规范修复（filmStockController.js）
2. **P1（高）**：元数据备份机制
3. **P2（中）**：相机和胶卷图片迁移到又拍云

---

**最后更新**：2025-11-13  
**状态**：需求文档已创建，待实施

