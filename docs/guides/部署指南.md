# FilmTrip Vercel 部署指南

## 🎯 部署概览

FilmTrip 采用前后端分离架构，支持 Vercel 平台的无服务器部署方式。

### 技术架构
- **前端**: React + Vite + Tailwind CSS
- **后端**: Node.js + Express (Serverless Functions)
- **数据库**: PostgreSQL (推荐 Supabase)
- **文件存储**: Vercel 临时存储 + 云存储服务

---

## 📋 部署前准备

### 1. 账号准备
- **Vercel 账号**: [vercel.com](https://vercel.com) 
- **GitHub 账号**: 用于代码托管
- **数据库服务**: 推荐以下之一
  - [Supabase](https://supabase.com) (推荐)
  - [Railway](https://railway.app)
  - [PlanetScale](https://planetscale.com)
  - [Neon](https://neon.tech)

### 2. 代码准备
```bash
# 确保代码已推送到 GitHub
git add .
git commit -m "准备部署"
git push origin main
```

### 3. 数据库准备
1. 创建 PostgreSQL 数据库实例
2. 执行 `backend/database/` 目录下的 SQL 文件初始化表结构
3. 记录数据库连接信息

---

## 🚀 部署步骤

### 第一步：部署后端 API

#### 1. 创建后端项目
1. 登录 [Vercel Dashboard](https://vercel.com/dashboard)
2. 点击 "New Project"
3. 选择 "Import Git Repository"
4. 找到并选择你的 FilmTrip 仓库

#### 2. 配置后端项目
- **Project Name**: `filmtrip-backend`
- **Framework Preset**: `Other`
- **Root Directory**: `backend`
- **Build Command**: `npm install`
- **Output Directory**: 留空
- **Install Command**: `npm install`

#### 3. 设置环境变量
在 Environment Variables 部分添加：

```env
# 数据库配置
DB_HOST=your-database-host
DB_PORT=5432
DB_NAME=your-database-name  
DB_USER=your-database-user
DB_PASSWORD=your-database-password

# 应用配置
NODE_ENV=production
JWT_SECRET=your-super-secret-jwt-key-here

# CORS 配置 (稍后填入前端域名)
FRONTEND_URL=https://your-frontend-domain.vercel.app

# 文件上传配置
UPLOAD_PATH=/tmp/uploads
MAX_FILE_SIZE=10485760
```

#### 4. 部署后端
1. 点击 "Deploy" 开始部署
2. 等待部署完成
3. 记录后端域名 (例如: `filmtrip-backend.vercel.app`)

### 第二步：部署前端应用

#### 1. 创建前端项目
1. 在 Vercel Dashboard 点击 "New Project"
2. 再次选择同一个 GitHub 仓库
3. 这次配置前端

#### 2. 配置前端项目
- **Project Name**: `filmtrip-frontend`
- **Framework Preset**: `Vite`
- **Root Directory**: `frontend`
- **Build Command**: `npm run build`
- **Output Directory**: `dist`
- **Install Command**: `npm install`

#### 3. 设置环境变量
```env
# API 配置 (使用上一步的后端域名)
VITE_API_BASE_URL=https://filmtrip-backend.vercel.app
```

#### 4. 部署前端
1. 点击 "Deploy" 开始部署
2. 等待部署完成
3. 记录前端域名 (例如: `filmtrip-frontend.vercel.app`)

### 第三步：更新后端 CORS 配置

1. 回到后端项目的 Settings → Environment Variables
2. 更新 `FRONTEND_URL` 变量：
   ```env
   FRONTEND_URL=https://filmtrip-frontend.vercel.app
   ```
3. 在 Deployments 页面重新部署后端

---

## 🌐 自定义域名配置

### 方案一：子域名方案 (推荐)

假设你的域名是 `example.com`：

#### 1. 配置前端域名
1. 在前端项目 Settings → Domains 添加：`www.example.com`
2. 按照 Vercel 提示配置 DNS

#### 2. 配置后端域名  
1. 在后端项目 Settings → Domains 添加：`api.example.com`
2. 按照 Vercel 提示配置 DNS

#### 3. DNS 配置示例
在域名服务商添加以下记录：
```
类型: CNAME, 主机记录: www, 记录值: cname.vercel-dns.com
类型: CNAME, 主机记录: api, 记录值: cname.vercel-dns.com  
类型: A, 主机记录: @, 记录值: 76.76.19.61
```

#### 4. 更新环境变量
- 前端项目：
  ```env
  VITE_API_BASE_URL=https://api.example.com
  ```
- 后端项目：
  ```env
  FRONTEND_URL=https://www.example.com
  ```

### 方案二：路径代理方案

如果只想使用一个域名，可以配置路径代理：

1. 前端项目添加域名：`example.com`
2. 在前端项目根目录创建 `vercel.json`：
   ```json
   {
     "rewrites": [
       {
         "source": "/api/(.*)",
         "destination": "https://filmtrip-backend.vercel.app/api/$1"
       }
     ]
   }
   ```
3. 更新前端环境变量：
   ```env
   VITE_API_BASE_URL=https://example.com
   ```

---

## 🔧 优化配置

### 1. 性能优化

#### Vercel 配置优化
在项目根目录创建 `vercel.json`：
```json
{
  "functions": {
    "backend/index.js": {
      "maxDuration": 30
    }
  },
  "headers": [
    {
      "source": "/api/(.*)",
      "headers": [
        {
          "key": "Cache-Control",
          "value": "s-maxage=60, stale-while-revalidate"
        }
      ]
    }
  ]
}
```

#### 前端性能优化
```json
{
  "buildCommand": "npm run build",
  "outputDirectory": "dist",
  "installCommand": "npm ci --only=production"
}
```

### 2. 安全配置

#### 环境变量安全
- 使用强随机密码作为 `JWT_SECRET`
- 数据库密码使用复杂字符组合
- 定期更换敏感密钥

#### HTTPS 配置
Vercel 自动提供 HTTPS，但建议：
- 启用 HSTS
- 配置 CSP 头部
- 使用安全的 Cookie 设置

---

## 🚨 常见问题解决

### 1. 部署失败
**检查项目**：
- [ ] `package.json` 脚本命令正确
- [ ] 所有依赖都在 `dependencies` 中
- [ ] 无语法错误和导入错误

**查看日志**：
- 在 Vercel Dashboard → Functions 查看错误日志
- 检查构建过程输出

### 2. 数据库连接失败
**检查配置**：
- [ ] 数据库连接字符串正确
- [ ] 数据库允许外部连接
- [ ] 防火墙设置允许 Vercel IP

**测试连接**：
```bash
# 本地测试数据库连接
node -e "
const { Pool } = require('pg');
const pool = new Pool({
  connectionString: 'your-connection-string'
});
pool.query('SELECT NOW()', (err, res) => {
  console.log(err ? err : res.rows[0]);
  pool.end();
});
"
```

### 3. CORS 错误
**检查设置**：
- [ ] `FRONTEND_URL` 环境变量正确
- [ ] 前端域名拼写正确
- [ ] 协议 (http/https) 匹配

**调试方法**：
```javascript
// 临时允许所有来源（仅调试用）
app.use(cors({
  origin: '*', // 生产环境请改为具体域名
  credentials: true
}));
```

### 4. 静态文件 404
**检查路径**：
- [ ] 文件上传路径配置正确
- [ ] 静态文件服务配置正确
- [ ] 云存储服务配置正确

### 5. 函数超时
**优化建议**：
- 增加 `maxDuration` 设置
- 优化数据库查询
- 使用连接池
- 实现请求缓存

---

## 📊 监控和维护

### 1. 性能监控
- **Vercel Analytics**: 查看访问统计和性能指标
- **Functions 日志**: 监控 API 响应时间和错误率
- **数据库监控**: 监控数据库连接数和查询性能

### 2. 自动化部署
```yaml
# .github/workflows/deploy.yml
name: Deploy to Vercel
on:
  push:
    branches: [ main ]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
```

### 3. 备份策略
- **数据库备份**: 使用数据库服务的自动备份功能
- **代码备份**: GitHub 仓库作为代码备份
- **配置备份**: 定期导出 Vercel 项目配置

---

## 📋 部署检查清单

### 部署前检查
- [ ] 代码已推送到 GitHub
- [ ] 数据库已创建并初始化
- [ ] 环境变量已准备
- [ ] 域名已准备（如需要）

### 部署过程检查
- [ ] 后端项目创建成功
- [ ] 后端环境变量配置正确
- [ ] 后端部署成功
- [ ] 前端项目创建成功
- [ ] 前端环境变量配置正确
- [ ] 前端部署成功

### 部署后验证
- [ ] 前端页面可以正常访问
- [ ] API 接口响应正常
- [ ] 数据库连接正常
- [ ] 文件上传功能正常
- [ ] 用户登录功能正常

### 域名配置检查（如适用）
- [ ] DNS 记录配置正确
- [ ] SSL 证书自动生成
- [ ] 域名解析正常
- [ ] HTTPS 重定向正常

---

## 🎉 部署完成

恭喜！你的 FilmTrip 应用已经成功部署到 Vercel。

### 访问地址
- **前端应用**: https://your-frontend-domain
- **后端 API**: https://your-backend-domain/api
- **管理后台**: https://your-frontend-domain/login

### 下一步
1. 测试所有功能是否正常
2. 配置监控和告警
3. 设置定期备份
4. 优化性能和安全设置

---

## 📚 相关资源

- [Vercel 官方文档](https://vercel.com/docs)
- [Supabase 文档](https://supabase.com/docs)
- [FilmTrip 项目文档](./README.md)

---

**版本**: v2.0 | **更新日期**: 2024年 | **适用项目**: FilmTrip

