# 🎞 FilmTrip 项目讨论纪要（2025-11-06）

> ⚠️ **提示**：核心结论已沉淀到知识库《docs/knowledge-base/best-practices/CDN与地图加速讨论纪要-2025-11-06.md》，本文件保留原始逐条记录。

## 🧭 一、会议背景

本次讨论围绕 **FilmTrip（个人胶片相册系统）** 的上线准备展开，重点聚焦以下几个主题：

- CDN（优拍云）接入与调试策略  
- 图片上传与水印处理逻辑  
- 图片 MD5 查重与文件唯一性  
- 地图标记聚合与缩放逻辑优化  
- 分享功能的交互与性能设计  
- 整体性能优化与 1.0 版本上线计划  

目标是在不浪费流量的前提下完成上线版本，实现图片展示、水印保护、地图聚合与分享体验的基础闭环。

---

## 🧩 二、问题点与讨论过程

### 1️⃣ CDN 接入与调试策略

**问题：**
- 如何在调试阶段避免浪费 CDN 流量？  
- 优拍云（UpYun）提供的开发者免费额度如何合理利用？  
- 是否启用整站加速还是仅图片加速？  

**讨论过程：**
- 当前拥有约 15GB 的存储与等额的 CDN 免费额度。  
- 担心本地调试频繁触发外网访问。  
- 建议区分调试与生产环境：  
  - **开发环境**：使用本地文件存储；  
  - **生产环境**：接入优拍云 CDN，仅加速图片与地图瓦片。  

**结论方案：**
- 调试阶段仅使用本地资源，避免额度浪费。  
- 上线后启用 CDN，限定范围为图片与地图瓦片资源。  
- 后续可评估是否升级为整站加速（目前暂不需要）。  

---

### 2️⃣ 图片上传与水印逻辑

**问题：**
- 水印是上传时添加还是 CDN 动态生成？  
- 是否影响原图？  
- 优拍云是否提供水印与防盗链功能？

**讨论过程：**
- CDN 动态水印机制只在分发时叠加，不修改原图。  
- 优拍云具备 **图片处理 + 水印 + 防盗链** 功能，开发者有免费额度。  
- 讨论了两种方案：  
  1. 上传时预先生成多版本（含水印 / 缩略图）；  
  2. CDN 动态生成展示版本。

**结论方案：**
- **首选：** 使用 CDN 动态水印，不影响原图；可随时调整或关闭。  
- **备选：** 上传阶段生成带水印副本，命名规则示例：`<hash>_wm.jpg`。  
- 原图始终保持纯净，仅管理员可访问。

---

### 3️⃣ 图片 MD5 查重与唯一性设计

**问题：**
- 如何防止重复上传相同图片？  
- CDN 是否自带去重？

**讨论过程：**
- CDN 仅负责分发，不提供文件内容查重。  
- 前端可在上传前计算 MD5 值。  
- 上传时先在数据库校验 hash 是否存在。

**结论方案：**
- **前端** 计算 MD5 → 发送到后端验证 → 若存在则复用文件 ID。  
- **后端** 存储文件表字段：  
  - `id`（UUID）  
  - `md5`  
  - `cdn_url`  
  - `created_at`  
- 避免重复上传，节省存储和流量。

---

### 4️⃣ 地图瓦片与聚合逻辑

**问题：**
- 地图上存在上千个标记点，如何避免加载卡顿？  
- 聚合策略按网格还是行政区划？  
- 缩放级别如何对应不同聚合层级？

**讨论过程：**
- 采用 **按视野加载（viewport-based loading）** 策略：  
  - 前端只加载当前可视范围的标记；  
  - 地图缩放或移动时重新请求该范围数据。  
- 聚合方式对比：  
  - **动态网格聚合**：通用、高效；  
  - **行政区划聚合**：贴近地理语义但实现复杂。  
- Zoom 级别层次建议：  

| Zoom | 聚合层级 | 说明 |
|------|------------|------|
| 3–5  | 国家级 | 显示国家概览 |
| 6–8  | 省级 | 按省份聚合 |
| 9–12 | 市级 | 城市聚合 |
| 13–15| 街道级 | 具体标记点 |

**结论方案：**
- **短期（1.0）**：动态网格聚合 + 按视野加载。  
- **中期（2.0）**：接入行政区划边界数据。  
- **长期（3.0）**：支持时间轴与轨迹动画展示拍摄路径。

---

### 5️⃣ 分享逻辑与交互设计

**问题：**
- 分享到社交平台时是否自动加水印与说明文字？  
- 用户是否可以自定义样式？

**讨论过程：**
- CDN 仅负责分发，不参与生成分享图。  
- 分享图可由后端或前端生成两种方式：  
  1. 上传阶段生成水印版图片；  
  2. 分享时即时生成（base64 合成或 API 请求）。  
- 用户可选择是否添加水印或分享说明。

**结论方案：**
- 上传阶段生成带水印副本，分享时直接引用。  
- 分享说明文字模板可配置，例如：  
  > 📷 拍摄于 {city}，来自 FilmTrip 胶片计划。

---

### 6️⃣ 性能与流量优化策略

**问题：**
- 如何降低瓦片与图片加载的流量消耗？  
- 是否能多服务商组合以节省额度？

**讨论过程：**
- 当前采用多层地图资源策略：  
  1. **MapTiler**：主供应商（矢量瓦片 + 坐标转换）；  
  2. **GeoMaplay**：备用；  
  3. **OSM**：兜底层。  
- 地图仅加载当前视野瓦片。  
- 用户操作时分批次加载（渐进呈现）。

**结论方案：**
```
MapTiler (优先)
    ↓
GeoMaplay (备选)
    ↓
OSM (兜底)
```
- 图片与瓦片走 CDN，主站内容保持独立。  
- 热门区域可预加载缓存，提升体验。

---

## 🚀 四、结论与后续计划

| 阶段 | 任务 | 负责人 | 状态 |
|------|------|----------|------|
| 阶段一 | CDN 接入与上传逻辑（含水印规则） | 王海伟 | ✅ 已明确方案 |
| 阶段二 | 地图聚合与按范围加载 | 王海伟 | 🧩 开发中 |
| 阶段三 | 分享逻辑与文案模板 | 王海伟 | 🔧 待完善 |
| 阶段四 | 性能优化与缓存策略 | 王海伟 | ⏳ 1.0 后进行 |

**最终目标：**  
> 当日发布可用的 FilmTrip v1.0，  
> 支持图片上传、CDN 加速、水印保护、地图聚合、社交分享。

---

## 📎 附录：关键结论摘要

- ✅ **CDN 接入范围：** 图片 + 地图瓦片  
- ✅ **水印策略：** 动态水印为主，上传生成为辅  
- ✅ **查重机制：** 前端 MD5 校验 + 后端复核  
- ✅ **地图聚合：** 动态网格聚合 + 视野加载  
- ✅ **分享逻辑：** 上传阶段生成分享图，带水印文字  
- ✅ **性能优化：** 分层加载 + 多服务商备份结构  
