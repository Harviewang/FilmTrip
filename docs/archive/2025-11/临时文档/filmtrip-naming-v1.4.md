# 🎞 FilmTrip 命名与短链规范 v1.4（统一版）

> ⚠️ **注意**：本临时稿件的内容已于 2025-11-06 汇总到正式规范《docs/specifications/命名与短链规范.md》。后续更新请以正式规范为准，本文件仅保留历史记录。

> 本规范定义了 **FilmTrip** 系统中 “胶卷（Film）—卷（Roll）—照片（Frame）” 三个层级的命名、标识、文件命名及短链规则，确保数据结构清晰、唯一且可扩展。

## 🧩 1. 层级结构

```
Film（胶卷型号）
 └── Roll（某一卷）
      └── Frame（某一帧）
```

## 🧱 2. 各层字段定义与编号规则

| 层级 | 主键 | 编号（code） | 短码（short） | UUID | 是否人工命名 | 唯一性 | 说明 |
|------|------|--------------|----------------|------|----------------|----------|------|
| **Film** | id (自增) | ✅ 例如 `KD-G200-135` | ✅ 2 位 Base62（例 `aZ`） | 可选 | ❌ 自动生成 | 全局唯一 | 胶卷型号（品牌+系列+ISO+画幅） |
| **Roll** | id (自增) | ❌ 无编号 | ✅ 3 位 Base62（例 `vn6`） | 可选 | ❌ 自动生成 | 全局唯一 | 胶卷实例（某卷） |
| **Frame** | uuid (主键) | ❌ 无编号 | ✅ 5 位 Base62（例 `aZ3kQ`） | ✅ 主键 | ❌ 自动生成 | 全局唯一 | 照片帧，绑定实际文件 |

## 🔢 3. 命名逻辑与含义

### 3.1 Film 编号（code）
- 结构：`{BRAND2}-{SER1}{ISO}-{FORMAT}`  
- 例：`KD-G200-135`（Kodak Gold 200, 135胶卷）  
- 规则：  
  - `BRAND2`：品牌两字母（Kodak=KD, Fujifilm=FJ, Ilford=IL, etc）  
  - `SER1`：系列首字母（Gold=G, Portra=P, HP5=H）  
  - `ISO`：感光度数字  
  - `FORMAT`：135 / 120 / 220 / 4x5 / APS 等  

### 3.2 Roll 与 Frame
- 无人工编号，系统自动生成短码。  
- 短码均为 Base62 编码（0–9, a–z, A–Z），定长：
  - Film：2 位  
  - Roll：3 位  
  - Frame：5 位  
- 每层短码全局唯一，不回收、不复用。

## 🌐 4. URL 与路由规则

### 4.1 统一短链入口
FilmTrip 所有短链均位于根路径：

| 层级 | 短码长度 | 示例 | 打开内容 |
|------|-----------|--------|-----------|
| Film | 2 | `/aZ` | 打开胶卷型号页 |
| Roll | 3 | `/vn6` | 打开该卷信息页 |
| Frame | 5 | `/aZ3kQ` | 打开照片预览页 |

### 4.2 匹配逻辑
- 系统优先匹配保留路径：`/map` `/gallery` `/film` `/api` 等；
- 其他根路径字符串按长度识别层级；
- 所有模块（gallery/map/film）点击进入预览时，都 `pushState('/{short}')`；
- 关闭预览时 `popState()` 返回原模块页。

### 4.3 分享逻辑
- 所有分享按钮均复制短链 URL；
- 原链接（如 `/gallery?photo=uuid`）应跳转或重写为 `/aZ3kQ`。

## 💾 5. 文件与存储结构

### 5.1 文件命名
```
{uuid}.{ext}
例：ff80c9e6-5c3e-4bdc-a0c1-c47e2a04b0bd.jpg
```

### 5.2 文件分桶存储（前缀分层）
为避免单目录文件过多，UUID 按前缀分层存放：
```
/storage/frames/ff/80/c9/ff80c9e6-5c3e-4bdc-a0c1-c47e2a04b0bd.jpg
```
- 前 3 组（`ff`、`80`、`c9`）为子目录；
- 每层 256 种可能，共 16,777,216 桶；
- 适合上百万文件的高性能访问。

### 5.3 版本与格式
同一 Frame 可有多个版本（RAW / WEB / THUMB）：
```
/storage/raw/{uuid}.tif
/storage/web/{uuid}.jpg
/storage/thumb/{uuid}.jpg
```

Frame 表中记录版本信息：
```sql
version ENUM('RAW','WEB','THUMB')
```

## 🧮 6. 去重与复用逻辑

| 场景 | 结果 |
|------|------|
| 同一文件再次上传 | 系统计算哈希（SHA256），发现已存在 → 返回原短码、uuid 不变 |
| 不同文件内容 | 创建新 Frame → 新 uuid、新短码 |
| 删除后重新上传相同文件 | 恢复原 Frame（同短码） |
| 同卷不同帧号 | 允许共存，短码仍唯一 |

Frame 表建议添加：
```sql
file_hash CHAR(64) UNIQUE
deleted_at DATETIME NULL
```

这样系统可以：
- 检测重复上传；
- 支持逻辑删除；
- 允许旧文件“复活”而短码不变。

## 🧭 7. 字段摘要表

| 表 | 主键 | 关键字段 | 唯一索引 | 外键 | 备注 |
|------|------|------------|------------|------------|------------|
| `films` | id | code, short | short | — | 胶卷型号表 |
| `rolls` | id | short, film_id | short | film_id | 胶卷实例 |
| `frames` | uuid | short, roll_id, file_hash | short, file_hash | roll_id | 照片帧 |

## 📘 8. 总结

> - **编号（code）**：仅 Film 层使用，可读语义（例 KD-G200-135）  
> - **短码（short）**：三层均有，用于分享与访问（例 aZ / vn6 / aZ3kQ）  
> - **UUID**：仅 Frame 层使用，为数据库与文件主键  
> - **文件路径**：按 UUID 前缀分桶，命名 `{uuid}.{ext}`  
> - **去重逻辑**：通过文件哈希检测重复上传  
> - **URL 统一在根路径**，按短码长度自动识别层级  

## 📂 9. 示例全集

| 类型 | 示例 | URL | 文件路径 |
|------|------|------|------|
| Film | KD-G200-135 | `/aZ` | — |
| Roll | (auto) | `/vn6` | — |
| Frame | (auto) | `/aZ3kQ` | `/frames/ff/80/c9/ff80c9e6-5c3e-4bdc-a0c1-c47e2a04b0bd.jpg` |

## ✳️ 附注：命名哲学
> - Film 代表“胶卷定义”，需要有语义编号。  
> - Roll / Frame 代表“实例”，只需唯一标识即可。  
> - shortcode 是统一的、全局可解析的身份；  
> - UUID 是持久、安全的技术主键；  
> - 所有设计均追求“**语义清晰 + 系统唯一 + 分享简洁**”。
