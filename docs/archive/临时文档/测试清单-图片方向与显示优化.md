# 测试清单 - 图片方向与显示优化

## 修复内容概述

### 1. 后端图片方向处理
- ✅ 单个上传增加 `withMetadata(false)` 和 size1024/size2048 派生图
- ✅ 所有派生图统一使用 `sharp.rotate()` 自动应用EXIF方向
- ✅ 移除EXIF元数据，防止前端二次旋转

### 2. 前端图片方向处理
- ✅ LazyImage组件：移除 `autoOrientation` 和 `imageOrientation: 'from-image'`
- ✅ Photos列表页：移除瀑布流和平铺模式中的orientation处理
- ✅ PhotoPreview组件：移除 `imageOrientation: 'from-image'`

### 3. 照片列表优化
- ✅ 平铺模式：添加 `object-center` 确保居中裁切，添加 `bg-gray-100` 作为加载背景
- ✅ 瀑布流模式：简化span计算，直接使用元数据计算高度，移除动态调整逻辑

### 4. 大图预览优化
- ✅ 标准模式：动态计算max-height为 `viewportH - infoHeight - 120px`，避免与EXIF信息重叠
- ✅ 沉浸模式：max-height保持95vh
- ✅ 旋转功能：添加平滑过渡动画（0.5s cubic-bezier）

---

## 测试场景

### A. 图片上传测试

#### A1. 单张上传 - 横向图片
1. 进入照片管理页面
2. 选择一张**横向图片**（如4:3或16:9）
3. 使用单张上传功能
4. ✅ 检查：上传后图片方向正确，不歪斜

#### A2. 单张上传 - 竖向图片
1. 进入照片管理页面
2. 选择一张**竖向图片**（如3:4或9:16）
3. 使用单张上传功能
4. ✅ 检查：上传后图片方向正确，不歪斜

#### A3. 单张上传 - 带EXIF方向的图片
1. 准备一张**带EXIF Orientation标签的图片**（如iPhone拍摄的竖图，EXIF=6）
2. 使用单张上传
3. ✅ 检查：
   - 后端生成的thumbnail、size1024、size2048都是正确方向
   - 前端显示不会二次旋转

#### A4. 批量上传
1. 选择多张图片（横向、竖向、带EXIF的混合）
2. 使用批量上传功能
3. ✅ 检查：所有图片方向都正确

---

### B. 照片列表显示测试

#### B1. 平铺模式 - 混合图片
1. 进入Gallery页面（/gallery）
2. 切换到**平铺模式**（四宫格图标按钮）
3. ✅ 检查：
   - 所有卡片高度一致（4:3比例）
   - 图片居中裁切，不变形
   - 横向图片裁切两侧，竖向图片裁切上下
   - 鼠标悬停时有放大效果

#### B2. 瀑布流模式 - 混合图片
1. 在Gallery页面切换到**瀑布流模式**（三列图标按钮）
2. ✅ 检查：
   - 横向图片显示为横向（较矮）
   - 竖向图片显示为竖向（较高）
   - 列与列之间高度自动平衡，不堆积在某一列
   - 加载更多时布局不跳跃

#### B3. 切换视图模式
1. 在平铺和瀑布流之间切换多次
2. ✅ 检查：
   - 切换流畅，无闪烁
   - 图片不重复加载
   - 加密图片的锁图标保持正确显示

---

### C. 大图预览测试

#### C1. 标准模式 - 横向图片
1. 在Gallery页面点击一张**横向图片**
2. 进入大图预览（默认标准模式）
3. ✅ 检查：
   - 图片显示在页面中央
   - 图片下方有EXIF信息区域
   - **图片与EXIF信息不重叠**
   - 图片不超出视口范围
   - 图片方向正确

#### C2. 标准模式 - 竖向图片
1. 点击一张**竖向图片**
2. 进入大图预览
3. ✅ 检查：
   - 竖图显示为竖向
   - EXIF信息在图片下方，不重叠
   - 图片在容器中垂直居中

#### C3. 沉浸模式
1. 在大图预览中，**点击图片**切换到沉浸模式
2. ✅ 检查：
   - UI和EXIF信息全部隐藏
   - 图片占据95vh高度，几乎全屏
   - 再次点击返回标准模式

#### C4. 旋转功能 - 横向图片
1. 打开横向图片大图预览
2. 点击右上角**旋转按钮**（↻图标）
3. 连续点击4次，每次旋转90度
4. ✅ 检查：
   - 每次旋转都有**平滑动画**（0.5秒）
   - 旋转0° → 90° → 180° → 270° → 0°
   - 旋转后图片在容器中自动适配，不超出边界
   - EXIF信息保持在底部，不受影响

#### C5. 旋转功能 - 竖向图片
1. 打开竖向图片大图预览
2. 旋转90度和270度
3. ✅ 检查：
   - 竖图旋转90度后变为横向
   - 旋转180度仍是竖向（倒置）
   - 每次旋转动画流畅

#### C6. 左右切换照片
1. 在大图预览中，点击左右箭头或按键盘方向键
2. ✅ 检查：
   - 切换到下一张照片
   - 旋转角度重置为0°
   - 新照片方向正确

---

### D. 响应式测试

#### D1. 移动端 - 列表
1. 使用手机或调整浏览器宽度到 < 640px
2. 查看Gallery页面
3. ✅ 检查：
   - 平铺模式自动变为单列
   - 瀑布流模式变为单列或双列
   - 卡片间距适中

#### D2. 移动端 - 大图预览
1. 在移动端打开大图预览
2. ✅ 检查：
   - 标准模式下图片适配屏幕，EXIF信息可见且不重叠
   - 沉浸模式下图片占满屏幕
   - 旋转按钮可点击，功能正常

---

### E. 边界情况测试

#### E1. 非常大的图片
1. 上传一张**分辨率极高**的图片（如8000x6000）
2. ✅ 检查：
   - 上传不卡顿（后端sharp处理）
   - 列表中使用size1024显示
   - 大图预览使用size2048显示
   - 方向正确

#### E2. 非常小的图片
1. 上传一张**分辨率很小**的图片（如200x150）
2. ✅ 检查：
   - 不会被放大失真（withoutEnlargement: true）
   - 方向正确

#### E3. 正方形图片
1. 上传一张1:1正方形图片
2. ✅ 检查：
   - 平铺模式下裁切为4:3
   - 瀑布流模式下保持1:1
   - 大图预览显示完整

#### E4. 加密图片
1. 标记一张照片为加密
2. 非管理员访问
3. ✅ 检查：
   - 列表中显示锁图标和提示
   - 点击不进入大图预览
   - 管理员登录后可正常查看

---

## 性能测试

### P1. 加载速度
1. Gallery页面加载20张照片
2. ✅ 检查：
   - 首屏加载时间 < 2秒
   - 懒加载触发正常（滚动到接近底部时加载更多）
   - 图片从模糊到清晰过渡流畅

### P2. 内存占用
1. 在Gallery页面滚动加载100+张照片
2. 打开Chrome DevTools -> Performance Monitor
3. ✅ 检查：
   - 内存占用增长平稳
   - 无内存泄漏

---

## 回归测试（确保没有破坏现有功能）

### R1. 照片上传的其他字段
1. 上传照片时填写标题、描述、相机、地点等信息
2. ✅ 检查：所有字段正常保存

### R2. 下拉刷新
1. 在Gallery页面下拉触发刷新
2. ✅ 检查：刷新后照片列表更新

### R3. 照片加密功能
1. 管理员标记照片为加密/非加密
2. ✅ 检查：状态切换正常

---

## 测试结果记录

### 执行日期：YYYY-MM-DD
### 测试人员：

| 测试项 | 结果 | 备注 |
|--------|------|------|
| A1. 单张上传-横向 | ⬜ Pass / ❌ Fail | |
| A2. 单张上传-竖向 | ⬜ Pass / ❌ Fail | |
| A3. 单张上传-EXIF | ⬜ Pass / ❌ Fail | |
| A4. 批量上传 | ⬜ Pass / ❌ Fail | |
| B1. 平铺模式 | ⬜ Pass / ❌ Fail | |
| B2. 瀑布流模式 | ⬜ Pass / ❌ Fail | |
| B3. 切换视图 | ⬜ Pass / ❌ Fail | |
| C1. 标准模式-横向 | ⬜ Pass / ❌ Fail | |
| C2. 标准模式-竖向 | ⬜ Pass / ❌ Fail | |
| C3. 沉浸模式 | ⬜ Pass / ❌ Fail | |
| C4. 旋转-横向 | ⬜ Pass / ❌ Fail | |
| C5. 旋转-竖向 | ⬜ Pass / ❌ Fail | |
| C6. 左右切换 | ⬜ Pass / ❌ Fail | |
| D1. 移动端-列表 | ⬜ Pass / ❌ Fail | |
| D2. 移动端-预览 | ⬜ Pass / ❌ Fail | |
| E1. 极大图片 | ⬜ Pass / ❌ Fail | |
| E2. 极小图片 | ⬜ Pass / ❌ Fail | |
| E3. 正方形图片 | ⬜ Pass / ❌ Fail | |
| E4. 加密图片 | ⬜ Pass / ❌ Fail | |
| P1. 加载速度 | ⬜ Pass / ❌ Fail | |
| P2. 内存占用 | ⬜ Pass / ❌ Fail | |
| R1. 其他字段 | ⬜ Pass / ❌ Fail | |
| R2. 下拉刷新 | ⬜ Pass / ❌ Fail | |
| R3. 加密功能 | ⬜ Pass / ❌ Fail | |

---

## 已知限制

1. **旋转是前端视觉旋转**：用户旋转图片后，刷新页面会恢复原始方向（不保存到数据库）
2. **瀑布流span计算基于估算列宽300px**：不同屏幕尺寸可能略有偏差
3. **EXIF信息预留空间120px**：如果EXIF信息过多，可能需要调整

---

## 测试通过标准

- 所有A、B、C类测试项必须Pass
- D、E、P、R类测试项至少90% Pass
- 无严重Bug（页面崩溃、功能完全不可用）
- 无明显性能问题（加载超过5秒、卡顿明显）

