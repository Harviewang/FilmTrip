# 地图照片分布展示方案（简约 / 美观 / 高性能）

本文档面向 FilmTrip 项目，提供 3 套可落地的地图交互方案。目标是在标记所有拍摄地点的同时保持界面清爽、交互顺畅，并兼顾弱网/移动端性能。

## 使用方诉求
- 需要在地图上标记所有拍摄地点，但不希望因为数量太多导致界面密密麻麻。
- 希望不同缩放层级自动升级语义：同一地点在更低 zoom 下代表国家/省份/城市/区县/社区/街道，在最高 zoom 才落到具体拍摄点。
- 地图文案优先使用中文地名，配合拍摄时间（年/月）帮助理解旅程节奏。
- 整体交互需简洁、美观、响应快，并且适配移动端及较慢网络环境。

## 共性设计原则
- **渐进加载**：只请求当前视口或当前层级所需的数据，避免一次性传输全部照片坐标。
- **多级语义**：随缩放逐层揭示信息，从“宏观分布”过渡到“具体拍摄点”，并保证过渡动画顺滑。
- **离线缓存**：后端预聚合统计，前端利用缓存或 IndexedDB 减少重复请求。
- **Fallback 友好**：所有方案都允许在低带宽下仅展示聚合标记，而将高清摄影作品延迟加载。

---

## 方案 A：分层聚合圆圈 + 漏斗式细化
> 借鉴 Google Photos / Mapbox Photo Explorer，通过不同级别的聚合圆圈展示分布，逐层展开。

### 交互体验
- **Zoom 3–5**：国家/地区级大号圆圈，中心显示代表图 + 数量。
- **Zoom 6–8**：省份/州级中号圆圈，保持数量提示，圆圈边缘用渐变表示密度。
- **Zoom ≥9**：城市/区县级小圈，点击后在地图侧边浮层展示照片网格；继续放大到 ≥13 时转换为单个拍摄点。
- 圆圈点击 → 地图 `flyTo` + 打开侧边预览；预览内可快速跳转到详细照片页。

### 技术实现
- **前端**：Leaflet + `supercluster`（Mapbox 官方库）或 `@changba/leaflet-supercluster`。每个缩放级别定义聚合阈值，使用自定义 `L.DivIcon` 渲染圆圈和代表图。
- **后端**：
  - 定期离线计算多级聚合（国家/省/市）并缓存，或在请求时调用 `supercluster` 的 Node 版本（输入统一的照片 GeoJSON）。
  - 聚合结果中附带中文地名（如 `region_name_cn`）以及时间范围（最早/最近拍摄时间），用于渲染“上海市 · 2022-2024”等描述。
  - 返回字段示例：
    ```json
    {
      "level": "province",
      "center": [31.2, 121.5],
      "count": 120,
      "cover": "/photos/preview/123.jpg",
      "region_name_cn": "中国 · 上海市",
      "time_span": { "start": "2022-04-11", "end": "2024-02-06" },
      "photos": [{ "id": "...", "thumbnail": "...", "lat": ..., "lng": ... }]
    }
    ```
- **性能优化**：
  - 聚合层级切换时仅请求对应级别数据（视口 + zoom）。
  - 使用 `prefetch`：在 zoom 5 时提前请求 zoom 6 的聚合，保证动画顺滑。
  - 图片统一走 CDN 或压缩版（320px）作预览。

### 适用场景
- 数据量大、覆盖面广，希望“点 → 圆圈 → 预览”连贯体验。
- 需要在不同层级展示数量统计、代表图，并支持移动端单手操作。

---

## 方案 B：蜂窝热力 + 局部展开
> 在宏观层级用六边形/方格热力图突出密集区域，点击任意蜂窝后以弹层展示该区域照片。

### 交互体验
- **Zoom 3–8**：使用蜂窝热力（Hexbin）展示密度，颜色从浅灰过渡到品牌主色，界面干净，易看出热点。
- **点击蜂窝**：地图放大并在蜂窝范围添加轻描边，同时开启右侧“胶片条”或底部滑板展示照片缩略图。
- **Zoom ≥9**：切换为散点或小型聚合（mini cluster），保持密度信息，但避免完全遮挡。

### 技术实现
- **前端**：
  - Leaflet + `leaflet-d3` 或 deck.gl 的 `HexagonLayer`（若未来迁移到 Mapbox/MapLibre 更顺手）。
  - 点击蜂窝时按蜂窝 ID 请求照片列表，并在浮层中显示。
- **后端**：
  - 预先对照片坐标进行 geohash 或 H3 编码（不同分辨率代表不同缩放级别）。
  - 每个蜂窝聚合附带中文标签（`label_cn`）和时间范围（该区域首尾拍摄时间），方便在浮层中展示如“广州天河区 · 2019-2024”。
  - 接口示例：`GET /map/heat?zoom=6&bbox=...`，返回 `{ "cells": [{ "id": "h3id", "count": 45, "center": [...], "bounds": [...], "label_cn": "中国 · 上海市", "time_span": {"start": "...", "end": "..."}}] }`。
- **性能优化**：
  - 热力层使用 canvas 渲染，减少 DOM。
  - 仅在蜂窝被展开时请求其内照片，控制每次加载数量（如 50 条）。
  - 可缓存常用 zoom 的蜂窝结果，结合 `ETag` 或 Redis。

### 适用场景
- 重点展示“哪里最常拍照”，强调密度/趋势。
- 适合拍摄地点集中在少数城市，但每城照片很多，且希望界面极简。

---

## 方案 C：时间轴驱动的地图焦点
> 结合照片拍摄时间，用户滚动时间轴时地图自动移动并显示对应区域聚合。

### 交互体验
- 页面分两列：左侧竖向时间轴（按年份/月份聚合），右侧 Leaflet 地图。
- 滚动到某个时间段 → 地图自动 `flyTo` 该阶段拍摄最多的城市，并展示小型聚合或单点。
- 用户可点击地图上的聚合展开照片，也可以在时间轴上筛选特定年份查看分布。
- 在高 zoom 下仍支持单点预览，但默认保持时间轴上下文。

### 技术实现
- **前端**：
  - React + IntersectionObserver 监听时间轴卡片进入视口时触发地图跳转。
  - 地图使用普通散点或小型聚合（例如 `leaflet.markercluster` 的轻量配置）。
  - 加入 `requestAnimationFrame` 节流，避免频繁飞行动画。
- **后端**：
  - 提供 `GET /map/timeline` 接口，返回按时间分组的地理聚合（中文地名为主，附带时间）：
    ```json
    [
      {
        "year": 2023,
        "month": 5,
        "topLocations": [
          {
            "name": "渝中区",
            "displayName": "中国 · 重庆市 · 渝中区",
            "center": [29.55, 106.57],
            "count": 34,
            "time_span": { "start": "2023-05-02", "end": "2023-05-07" },
            "photoIds": [...]
          }
        ]
      }
    ]
    ```
  - 单点照片详情沿用现有 `/photos` 接口。
- **性能优化**：
  - 时间轴卡片懒加载缩略图，地图点位一次加载 1~2 个主地点即可。
  - 对手机端启用“点击时间卡片才飞行”的模式，避免滚动触发过多动画。

### 适用场景
- 想强调“拍摄旅程”或时间脉络，让用户按年份回顾拍摄足迹。
- 照片数量大但希望控制地图上同时显示的点位，维持简洁。

---

## 方案对比
| 方案 | 视觉密度 | 交互复杂度 | 实现工作量 | 适合数据量 | 特色 |
| --- | --- | --- | --- | --- | --- |
| A 分层聚合 | ★★☆ | ★★☆ | ★★★ | 10k+ 点 | 通用、与现有地图逻辑兼容 |
| B 蜂窝热力 | ★☆☆ | ★★ | ★★ | 5k–20k 点 | 强调密度热点、界面极简 |
| C 时间轴 | ★★ | ★★★ | ★★☆ | 1k–10k 点 | 强化故事线、空间+时间结合 |

---

## 推荐落地路径
1. **确定主目标**：若主打探索与统计，优先方案 A；若强调热点与简约视觉，选方案 B；若突出旅程回顾，选方案 C。
2. **数据准备**：对现有照片表补充坐标精度、行政区划字段（国家/省/市），方便各方案直接聚合。
3. **原型验证**：先在 `/map/lab` 或 Storybook 中快速实现一个静态 Demo（假数据），对比视觉效果后再接入真实接口。
4. **渐进上线**：保留当前地图页为基础体验，并在导航中提供“探索模式”入口（比如 `/map/explore`），逐步替换。

以上方案都可与现有 Leaflet 栈兼容，成本主要在后端聚合与动画打磨。根据数据规模和品牌调性选择其一后，我们可以进一步细化组件拆分、接口契约和测试计划。欢迎继续讨论。 
