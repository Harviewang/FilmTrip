# FilmTrip 文档 vs 代码 差异清单（2025-10-30）

状态：仅记录差异与影响范围，不做代码修改；用于后续开发同步更改。

---

## P0（必须优先）

### 1) API 返回格式未按统一规范
- 文档要求：避免 `data.data`；列表返回使用业务复数字段名（如 `photos`、`filmStocks`）+ `pagination`；详情返回单数字段（如 `photo`）。参考：`docs/specifications/API规范-统一版.md`。
- 现状：多数接口仍返回 `{ success, data, pagination }`，未按资源名展开（如照片列表）。
- 影响范围：
  - 后端：所有资源型控制器/路由的返回结构（照片、胶卷、胶卷品类、相机、扫描仪、统计等）。
  - 前端：`services/api.js` 的数据解包、各页面/组件的数据字段读取与空态/错误处理逻辑。
  - 文档：接口示例需与最终返回结构保持一致。
- 变更建议：
  - 新增返回字段命名（如 `photos`、`filmStocks` 等）逐步替代 `data`；保留 `data` 过渡期（兼容字段）并标记弃用计划。

### 2) 地图搜索与地理编码路由不一致
- 文档草案：`GET /api/geocode/search?q`、`GET /api/map/photos?page&limit`（见 `docs/eeecfe7back/specifications/map-需求说明-2025-10-30.md`）。
- 现状：地图搜索在 `GET /api/map/search`；已存在 `/api/geocode/reverse` 与 `/api/geocode/reverse-maptiler`，但缺少 `geocode/search`；地图照片分页未单列 `/api/map/photos`。
- 影响范围：
  - 后端：`backend/routes/map.js`、`backend/routes/geocode.js` 路由命名与职责拆分；新增 `GET /api/geocode/search` 与 `GET /api/map/photos`。
  - 前端：`frontend/src/pages/Map/*` 调用路径与参数；`MapPicker`、`PhotoPreview` 中地名搜索/逆地理的统一封装与调用。
  - 文档：将既有 `/api/map/search` 对齐/标注为兼容别名或淘汰路径。
- 变更建议：
  - 新增 `geocode/search` 并保留旧 `map/search` 兼容期；新增 `map/photos` 提供分页/聚合结果（对齐草案）。

### 3) 胶卷生命周期与冲洗链路未落地
- 文档草案：状态流转（启封/拍摄完毕/冲洗完成/归档）、事件日志 `film_roll_events`、冲洗相关表（`wash_processes`、`wash_vendors`、`wash_orders`）、动作 API（如 `POST /api/filmRolls/:id/wash-finish`）。见 `docs/eeecfe7back/specifications/film-需求说明-2025-10-30.md`、`admin-需求说明-2025-10-30.md`。
- 现状：未发现上述表结构、动作路由与管理端表单校验。
- 影响范围：
  - 数据库：新增/迁移表与约束；状态机与事件日志；票号生成（YYYY-MM-DD-###）。
  - 后端：新增动作 API、幂等/锁控制、字段校验（必填/可选/依赖关系）。
  - 前端：`/admin` 对应动作表单、校验与回退；`/film` 时间轴仅展示 `archived` 卷；品类视图统计与详情页工艺覆盖。
  - 文档：API 样例、校验规则、验收清单同步。
- 变更建议：
  - 分阶段：先落地事件与四个动作 API，再扩展工艺/商家/订单维护。

---

## P1（重要）

### 4) 前端导航命名与视角不一致
- 文档：公共浏览入口 `/gallery`、`/film`（时间轴/品类双视角）、`/map`。
- 现状：存在 `/gallery`、`/film-rolls`、`/map`；`/film` 双视角（`view=time|stock`）未落地。
- 影响范围：
  - 前端：路由与页面改名/重定向（`/film-rolls` → `/film`），视角切换与 URL 查询参数。
  - 文档：导航结构、截图与路径说明。
- 变更建议：
  - 保留 `/film-rolls` → 301/前端重定向至 `/film`；新页支持双视角。

### 5) 地图智能降级与缓存策略未完全实现
- 文档：MapTiler 矢量→栅格→OSM 自动降级；配额检测（403）；月初自动恢复；Service Worker 瓦片缓存（7天TTL/1000瓦片）。
- 现状：前端已接入多瓦片源与部分降级逻辑；未见 SW 瓦片缓存与“月初自动恢复”的实现；缺统一错误提示与配额状态持久化。
- 影响范围：
  - 前端：新增 Service Worker；配额状态持久化（localStorage/IndexedDB）；错误提示组件；月初重置逻辑。
  - 后端：无强制改动；可选提供健康检查接口。
  - 文档：补充实现细节与异常场景说明。
- 变更建议：
  - 引入 SW 缓存瓦片（仅公共栅格源）；封装 Map 资源管理器，统一降级与恢复策略。

### 6) /gallery 加密过滤与随机策略对齐
- 文档：默认“隐藏加密图片”，localStorage 持久化，三视图（平铺/瀑布流/随机）一致生效；随机模式可支持“全局随机/带胶卷随机”。
- 现状（已对齐）：
  - 加密：后端按加密状态控制 URL 暴露；前端“隐藏加密”开关已持久化到 localStorage，并在三视图一致生效。
  - 随机：已临时调整为“一次性全局随机6张，受右上角筛选控制”，替代原“先随机选卷再抽帧”的方案。
- 影响范围：
  - 前端：`/gallery` 三视图的过滤逻辑；随机模式的抽取策略与筛选联动；隐藏加密状态持久化（已完成）。
  - 文档：用户指南与需求池说明已同步临时方案与长期方向（全局 vs 带胶卷）。
- 后续（长期）：
  - 如需，UI 提供“全局随机/带胶卷随机”模式切换（但当前不必）。

### 7) 地名搜索与中文增强链路未统一
- 文档：优先中文、混合英文名清理、本地映射；`geocode/search` 与 `geocode/reverse` 统一。
- 现状：仅有 `reverse` 相关接口；缺 `geocode/search`；中文清洗策略未集中封装。
- 影响范围：
  - 后端：新增 `GET /api/geocode/search`，输出标准五级字段（country/province/city/district/township）。
  - 前端：`MapPicker`、地图页搜索、`PhotoPreview` 迷你地图入口中的地址搜索统一改造。
  - 文档：搜索参数与返回格式示例同步。
- 变更建议：
  - 后端提供统一中文增强与清洗；前端只消费统一输出。

### 8) 统计接口细节核对
- 文档：仪表板、趋势、存储、活跃热力图。
- 现状：后端已有 `/api/stats/dashboard|trends|storage|activity/heatmap`；需核对字段与分页/筛选参数一致性。
- 影响范围：
  - 后端：返回字段名与文档示例的对齐。
  - 前端：`/admin/dashboard` 数据适配。
  - 文档：示例最终定稿。

---

## P2（兼容/优化）

### 9) 前端 API 基址与环境一致性
- 文档：统一 BASE_URL 与 `/api` 前缀管理。
- 现状：部分管理视图写死 `http://localhost:3001` 或直连路径，未统一走 `API_CONFIG`。
- 影响范围：
  - 前端：`FilmRollManagement.jsx`、`PhotoManagement.jsx`、`FilmStockManagement.jsx`、`CameraManagement.jsx` 等接口调用路径统一。
  - 文档：开发/生产环境配置说明。
- 变更建议：
  - 全量替换为 `API_CONFIG`；通过代理/环境变量控制。

### 10) 画幅/类型筛选体验
- 文档：`film_type`、`film_format` 作为筛选；前端筛选器/布局规则。
- 现状：后端已支持查询参数；前端筛选 UI 与布局优化未完整实现。
- 影响范围：
  - 前端：筛选器组件、状态与 URL 同步、布局适配（masonry/grid span）。
  - 文档：筛选项与行为说明。

### 11) 统一预览与迷你地图
- 文档：`PhotoPreview` 统一；点击地点弹出只读迷你地图（zoom=12），沉浸/标准一致逻辑。
- 现状：`PhotoPreview` 已统一；迷你地图弹窗需核对是否在各入口一致实现。
- 影响范围：
  - 前端：迷你地图弹层复用、资源释放、键盘/触摸交互一致。
  - 文档：交互细节与边界条件描述。

### 12) Trip/主题入口占位
- 文档：新增一级入口（先显示“建设中”）。
- 现状：未见入口。
- 影响范围：
  - 前端：导航与路由占位；文案、空态。
  - 文档：路径与迭代计划。

---

## 附：对应文件/模块速查（部分示例）
- 后端路由/控制器：`backend/routes/*.js`、`backend/controllers/*.js`、`backend/index.js`
- 前端页面/服务：`frontend/src/pages/*`、`frontend/src/views/*`、`frontend/src/services/api.js`、`frontend/src/config/api.js`
- 文档规范与需求：`docs/specifications/*`、`docs/eeecfe7back/specifications/*`

---

备注：执行时建议采用“兼容迁移”策略——新增符合规范的返回字段/新路由并保留旧字段/旧路由一段时间，前端逐步切换，确认稳定后移除旧接口与解析分支。