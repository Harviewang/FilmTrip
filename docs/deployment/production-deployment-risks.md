# 生产环境直接部署风险评估

## ⚠️ 直接部署到 filmtrip.cn 的风险

### 🔴 高风险项

#### 1. **服务中断风险**
- **风险**：如果部署失败，可能导致生产环境服务完全中断
- **影响**：用户无法访问 `filmtrip.cn` 和 `api.filmtrip.cn`
- **缓解措施**：
  - 在低峰期（如凌晨）部署
  - 准备快速回滚方案
  - 先部署到测试域名验证

#### 2. **数据丢失风险**
- **风险**：如果数据库迁移或配置错误，可能导致数据丢失
- **影响**：照片、用户数据可能丢失
- **缓解措施**：
  - 部署前完整备份数据库
  - 测试环境先验证所有操作
  - 保留旧版本代码可快速回滚

#### 3. **又拍云配置错误**
- **风险**：如果又拍云配置错误（bucket、密钥、回调URL等），可能导致：
  - 图片无法上传
  - 图片无法显示
  - 回调失败，照片记录不更新
- **影响**：核心功能（照片上传/显示）完全失效
- **缓解措施**：
  - 先在测试环境完整测试又拍云流程
  - 确保生产环境又拍云配置正确
  - 保留本地存储作为降级方案

#### 4. **域名和SSL证书问题**
- **风险**：如果域名配置或SSL证书有问题，可能导致：
  - 域名无法访问
  - HTTPS证书过期或无效
  - CDN域名无法访问
- **影响**：整个网站无法访问
- **缓解措施**：
  - 部署前检查SSL证书有效期
  - 检查DNS解析是否正确
  - 测试所有域名（filmtrip.cn、api.filmtrip.cn、img.filmtrip.cn）

#### 5. **ECS服务器资源不足**
- **风险**：如果服务器内存、磁盘空间不足，可能导致：
  - 部署失败
  - 服务崩溃
  - 响应缓慢
- **影响**：服务不稳定或完全无法运行
- **缓解措施**：
  - 部署前检查服务器资源使用情况
  - 清理不必要的文件
  - 确保有足够的磁盘空间和内存

### 🟡 中等风险项

#### 6. **依赖服务冲突**
- **风险**：ECS上运行的其他服务可能受影响
- **影响**：其他服务可能无法正常运行
- **缓解措施**：
  - 确认端口冲突（3001、3002等）
  - 确认环境变量不冲突
  - 确认进程管理方式（PM2、systemd等）

#### 7. **代码兼容性问题**
- **风险**：新代码可能不兼容当前服务器环境（Node版本、系统库等）
- **影响**：部署后代码无法运行
- **缓解措施**：
  - 确认服务器Node版本（建议 >= 18）
  - 确认系统依赖已安装
  - 测试环境先验证

#### 8. **环境变量配置错误**
- **风险**：生产环境变量配置错误可能导致功能异常
- **影响**：部分功能无法正常工作
- **缓解措施**：
  - 完整检查所有环境变量
  - 确保生产环境变量已正确配置
  - 部署前验证配置

### 🟢 低风险项

#### 9. **性能问题**
- **风险**：新代码可能存在性能问题
- **影响**：响应速度变慢
- **缓解措施**：
  - 部署后监控性能指标
  - 准备性能优化方案

#### 10. **用户体验影响**
- **风险**：部署过程中可能出现短暂的服务中断
- **影响**：用户可能看到错误页面
- **缓解措施**：
  - 在低峰期部署
  - 部署时间尽量短（使用快速部署方案）

---

## 📋 部署前必须检查的清单

### ✅ ECS服务器状态检查

#### 1. 服务器资源
- [ ] CPU使用率 < 80%
- [ ] 内存使用率 < 80%
- [ ] 磁盘空间 > 20%（至少5GB可用）
- [ ] 网络连接正常

#### 2. 运行中的服务
- [ ] 检查当前运行的Node.js进程
- [ ] 检查端口占用情况（3001、3002等）
- [ ] 确认没有端口冲突
- [ ] 检查其他服务的状态

#### 3. 系统环境
- [ ] Node.js版本 >= 18
- [ ] npm版本正常
- [ ] 系统依赖已安装
- [ ] 防火墙规则正确

#### 4. 代码和环境
- [ ] 代码已推送到Git仓库
- [ ] 生产环境变量已配置
- [ ] `.env` 文件已更新为生产配置
- [ ] 数据库连接正常

### ✅ 又拍云配置检查

- [ ] 生产bucket已创建并配置
- [ ] 生产环境操作员和密钥已配置
- [ ] 表单API密钥已配置
- [ ] CDN域名已绑定（img.filmtrip.cn）
- [ ] SSL证书已配置
- [ ] 样式已配置（thumb、preview、large）
- [ ] 回调URL已配置（https://api.filmtrip.cn/api/storage/callback）

### ✅ 域名和DNS检查

- [ ] filmtrip.cn DNS解析正确
- [ ] api.filmtrip.cn DNS解析正确
- [ ] img.filmtrip.cn DNS解析正确
- [ ] SSL证书有效（所有域名）
- [ ] 测试访问所有域名

### ✅ 备份和回滚准备

- [ ] 数据库已完整备份
- [ ] 代码已打tag（可回滚）
- [ ] 环境变量已备份
- [ ] 准备回滚脚本
- [ ] 准备降级方案（禁用又拍云，使用本地存储）

---

## 🚀 推荐的部署策略

### 方案A：灰度部署（推荐）

1. **第一步**：部署到测试域名（filmtrip.imhw.top）
   - 验证所有功能正常
   - 验证又拍云集成正常
   - 测试1-2天

2. **第二步**：低峰期部署到生产环境
   - 选择低峰期（如凌晨2-4点）
   - 快速部署
   - 立即验证核心功能

3. **第三步**：监控和验证
   - 监控服务状态
   - 检查日志
   - 验证用户反馈

### 方案B：快速部署（不推荐）

直接部署到生产环境，但必须：
- 完成所有检查清单
- 准备快速回滚方案
- 在低峰期部署
- 部署后立即验证

---

## 🔧 部署后验证清单

### 立即验证（5分钟内）

- [ ] 访问 https://filmtrip.cn 正常
- [ ] 访问 https://api.filmtrip.cn/api/health 正常
- [ ] 登录管理后台正常
- [ ] 上传一张测试照片成功
- [ ] 照片显示正常（检查CDN URL）
- [ ] 照片回调收到并更新数据库

### 持续监控（1小时内）

- [ ] 检查后端日志，无严重错误
- [ ] 检查前端控制台，无严重错误
- [ ] 检查服务器资源使用正常
- [ ] 检查又拍云控制台，上传正常
- [ ] 测试所有核心功能

---

## 📞 紧急回滚方案

### 如果部署失败，立即执行：

1. **恢复代码**
   ```bash
   git checkout <previous-tag>
   npm install
   pm2 restart all
   ```

2. **恢复环境变量**
   ```bash
   # 恢复之前的 .env 文件
   cp .env.backup .env
   pm2 restart all
   ```

3. **禁用又拍云（临时方案）**
   ```bash
   # 在 .env 中设置
   UPYUN_DIRECT_UPLOAD_ENABLED=false
   UPYUN_IMAGE_PROCESSING_ENABLED=false
   pm2 restart all
   ```

4. **检查服务状态**
   ```bash
   pm2 status
   pm2 logs
   ```

---

## 💡 建议

### ✅ 推荐做法

1. **先部署到测试环境**验证所有功能
2. **低峰期部署**，减少对用户的影响
3. **准备回滚方案**，确保可以快速恢复
4. **完整备份**，包括代码、数据库、环境变量
5. **监控部署后状态**，及时发现问题

### ❌ 不推荐做法

1. **高峰期直接部署**到生产环境
2. **没有备份**就部署
3. **没有测试**就部署
4. **没有回滚方案**就部署
5. **同时部署前后端**（应该先部署后端，再部署前端）

---

**⚠️ 最重要：部署前必须完成所有检查清单，并准备回滚方案！**

