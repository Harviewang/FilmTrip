# CMT-20251028-003: 地图中文地点增强第一阶段实现

## 任务概述
实现地图中文地点增强功能的上传联动部分（M-4、M-5），包括地图选点、地址解析、表单集成等核心功能。

## 完成时间
2025-10-28

## 完成内容

### 1. M-4: 地址解析服务 ✅
**目标**：提供坐标 ↔ 省/市/区/街道（五级）解析服务

**实现内容**：
- ✅ `/api/geocode/reverse`：统一调用 MapTiler Geocoding API；解析 `country/province/city/district/township` + `latitude/longitude`
- ✅ `parseMapTilerContext`：适配国内多层结构、直辖市和国外地址
- ✅ 翻译策略：优先使用 MapTiler 返回中文；若字段为英文且带 `country_code`，使用内置映射表翻译；必要时调用第三方 API（预留）
- ✅ 数据缓存：后端缓存用户确认过的地址，减少重复解析
- ✅ 日本地址适配：支持 `municipal_district/neighbourhood/quarter` 等 designation

**测试结果**：
- 中国深圳：五级地址 ✅
- 日本熊本：五级地址 ✅
- 日本沖縄：三级（无区划分）✅
- 澳大利亚悉尼：五级地址 ✅
- 美国纽约：省/市/区 ✅

### 2. M-5: 上传联动 ✅
**目标**：上传/编辑表单通过选点写入地址字段

**实现内容**：
- ✅ 新增 `MapPicker` 组件（frontend/src/components/MapPicker.jsx）
  - MapLibre 地图、OSM 瓦片、点击/拖拽选点、手动解析按钮、定位控件、按需销毁
- ✅ 上传/批量上传表单集成：选点 → 调用解析 → 回填 `country/province/city/district/township` + 坐标
- ✅ 移除 `location_name` 字段输入，改用解析结果
- ✅ UI 调整：二维网格布局、弹窗宽度 max-w-3xl、输入体验优化
- ✅ 前端错误修复：MapPicker 白屏、Gallery page 参数类型、错误处理

### 3. 前台地址显示 ✅
- 修改 `PhotoPreview.jsx`：拼接并展示完整中文地址；点击位置是进入下一阶段（M-6）基础
- 修改 `photoController.js`：API 返回包含 `district/township`

## 遗留问题
- ⏳ M-6 预览小地图尚未实现（下一阶段）
- ⏳ 城市翻译映射扩展（日本/美国等）
- ⏳ 批量补录工具待实现（为未标点照片补录坐标）
- ⏳ 底图中文化预留
- ⏳ 需求池新增：确认 `location_name` 字段是否淘汰

## 技术债务
- OSM 瓦片速率限制 → 需监控 429、准备降级方案
- 翻译映射表维护成本 → 后续补充更多国家或接入在线翻译
- MapPicker 可抽象成通用组件，方便 M-6/批量补录复用

## Git 提交
```
2f5ded7 docs: 添加MapTiler地址解析最佳实践文档
1d54c21 fix: MapPicker 组件按需销毁并缓存解析结果
ac610de feat(M-5): 优化地图选点器用户体验
bde0d93 fix: 修复地图选点器问题
dac604c fix: 修复Gallery页面page参数类型错误
72a98b1 fix: 完善日本地址解析支持municipal_district
03a85c2 feat: 完善前台地址显示格式
41d0a51 fix: 添加district和township字段到API返回
```

## 验收情况
- [x] M-4 地址解析服务：全球五级解析、翻译策略、缓存
- [x] M-5 上传/编辑联动：地图选点、字段回填、UI 调整
- [x] 前台地址显示：拼接展示
- [ ] M-6 预览小地图（待下一阶段）
- [ ] 城市翻译扩展、批量补录、底图中文化（后续任务）

## 测试说明
- 上传单张：选点 → 解析 → 回填 → 保存 → 前台展示中文地址
- 批量上传：选点 → 回填 → 提交；批量上传仍保留 `location_name` ——待后续批量选点改造
- 中/日/澳/美 地址分别验证
- 错误处理：地图初始化失败、解析失败时提示并保留手动输入

## 明日计划
1. 完成 M-6 预览小地图（点击省/市/区打开迷你地图，zoom=12）
2. 扩充城市翻译映射或评估翻译服务
3. 设计批量补录工具草案
4. 记录 `location_name` 字段退役方案（已入需求池）

---
本阶段聚焦于“地图选点 → 五级地址 → 坐标”主链路，形成可复用的解析服务与前端组件，为后续预览小地图、批量补录等需求打基础。
