# CMT-20251028-002: 地图中文地点增强（计划）

## 关联需求
- 新需求：为地图/照片上传提供中文省市区街道映射与坐标联动
- 受影响模块：照片上传（PhotoManagement）、照片预览（PhotoPreview）、MapLibre 地图视图、后端照片接口

## 目标与范围
1. **地址解析**：提供坐标 ↔ 省/市/区/街道（五级）的双向解析；统一沿用 `country/province/city/district/township` + `latitude/longitude` 字段。
2. **上传/编辑联动**：上传或批量上传时，通过“地图选点 → 解析 → 确认”流程写入上述字段；不再提供纯文本地址解析入口。
3. **预览小地图**：PhotoPreview 中点击省/市/区字段才按需加载 MapLibre，展示中文标签与定位标记，默认 `zoom = 12`，列表视图不加载。

## 任务拆解
| 编号 | 模块 | 任务摘要 | 负责人 | 状态 | 备注 |
| --- | --- | --- | --- | --- | --- |
| M-4 | 地图·地址解析 | 坐标↔五级中文地址解析服务 | Codex→AI助手 | ⏳ 待开始 | MapTiler API 为主，预留 Geomaply 备选；结果回写五级字段 + 坐标 |
| M-5 | 地图·上传联动 | 上传/编辑表单地图选点→解析回填 | AI助手 | ⏳ 待开始 | 流程：选点→调用解析接口→用户确认→写入数据库 |
| M-6 | 地图·预览小地图 | PhotoPreview 点击地点打开迷你地图 | AI助手 | ⏳ 待开始 | 按需加载 MapLibre，默认 zoom=12，展示中文地址与标记 |
| BP | 最佳实践文档 | `docs/knowledge-base/best-practices/地图中文地点增强最佳实践-2025-10-28.md` | Codex | ✅ 已创建 | 统一记录解析/联动/翻译方案 |

## 前置准备
- [ ] 清洗现有照片地理信息，统计中文/英文/缺失情况
- [ ] 准备中文行政区划数据（离线库 + MapTiler API，预留 Geomaply 备选）
- [ ] 设计上传交互流程（选点→解析→确认），明确后端接口及返回结构

## 验收标准（草案）
- ✅ 上传/编辑时通过地图选点可自动补全省/市/区/街道并生成坐标
- ✅ 预览页点击省/市/区显示迷你地图（中文标注、准确定位）
- ✅ MapLibre 地图根据新的中文字段显示正确信息
- ✅ 旧数据兼容：无省市区/英文地址时给出提示，并支持手动补齐

## 里程碑计划
- **Day 1**：完成数据源选型/准备、接口设计评审（M-4）
- **Day 2-3**：实现上传/编辑联动逻辑并回填历史数据（M-5）
- **Day 4**：完成小地图组件与 E2E 测试，更新文档（M-6）

## 风险与应对
- **行政区划数据量大** → 优先离线缓存常用省市区，提供懒加载或分级查询
- **解析依赖外部服务** → 缓存用户确认的结果，MapTiler 失败时预留 Geomaply/人工输入兜底
- **迷你地图性能** → MapLibre 按需加载，关闭弹窗及时销毁实例

## 翻译策略
- 优先使用 MapTiler 返回的中文文本。
- 若文本为英文且存在 `country_code`，通过内置映射表翻译常见国家/地区名称；必要时调用第三方翻译 API 作为兜底。

## 后续计划（中期）
- `/map` 页面按照片坐标批量打点，必要时引入聚合或分级加载。
- 支持通过后台工具对未标点照片进行批量补录。
- 评估底图中文化方案（MapTiler 中文瓦片或 Geomaply）并确定实施时机。

---
（待开发完成后补充开发总结、自测结果、审计记录等内容）
