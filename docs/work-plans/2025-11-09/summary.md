# 2025-11-09 工作计划

## 1. 用户原始需求与决策
- 用户强调 **CDN 是上线前的首要任务**：照片上传后必须直接存储到指定的优拍云（UpYun）空间，而非保存在服务器本地。
- 分享体验需要优化：生成带水印的分享图、提供统一文案模板，并在前端入口中正确引用。
- 补齐 **胶卷详情页**：为每卷胶卷提供独立页面，展示基础信息与关联照片，方便分享与导航。
- 用户确认 **任务分工**：CDN 上传链路由 Codex 执行；分享图/水印与胶卷页面交由 Windsurf 处理，保持互不阻塞。
- 文档《docs/文档整理问题清单-2025-11-06.md》属临时记录，整理完成后可移除，不再构成新增任务。

## 2. 任务拆解
| 编号 | 模块 | 任务摘要 | 负责人 | 目标状态 | 备注 |
| --- | --- | --- | --- | --- | --- |
| NAMING-1 | 基础设施 | 落地命名与存储规范：数据库字段、哈希去重、短链生成、三层目录规划 | Codex (GPT-5) | 进行中 | 方案详见《docs/design/命名与存储方案-落地计划.md》 |
| CDN-1 | 文件分发 | 在命名规范基础上接入 UpYun：上传改为直传对象存储，支持凭证配置与失败回退 | Codex (GPT-5) | 待开始 | 依赖 NAMING-1 完成；参考需求池 `环境感知资源访问层` |
| CDN-2 | 文件分发 | 分享图与水印：封装动态水印/多版本生成策略，前端引用带水印版本，保留原图给管理员 | Windsurf (Claude Sonnet) | 待开始 | 需求池中“图片处理优化方案”“CDN 动态水印封装”“分享模板” |
| ROLL-1 | 前端体验 | 构建胶卷详情页：后端接口与前端页面展示卷信息、照片列表、分享入口 | Windsurf (Claude Sonnet) | 待开始 | 需求池 `胶卷全生命周期管理` |
| ROLL-2 | 前端体验 | 胶卷聚合页 + 实例生命周期设计：提供胶卷介绍、实例列表、状态时间轴与分享入口 | Windsurf (Claude Sonnet) | 待开始 | 参照今日讨论的 Film/roll 结构（聚合页 + 生命周期）；与 Cursor 的命名/CDN 改造脱耦 |
| SL-1 | 前端短链 | Gallery（含随机视图）、时间轴、地图入口统一使用短链分享/跳转，`PhotoPreview` 支持解析 `/s/{code}` 并回写浏览器地址 | Codex (GPT-5) | 待开始 | 需更新路由、分享按钮与复制逻辑；与 NAMING-1 输出的字段对齐 |
| SL-2 | 前端短链 | 旧链接兼容与 SEO：保留 `?photo=uuid` 回溯解析，新增短链路由中间件，并在文档/帮助中说明新老链接差异 | Codex (GPT-5) | 待开始 | 同步更新《docs/specifications/命名与短链规范.md》《docs/specifications/需求文档-统一版.md》中的前台行为描述 |

## 3. 验收清单（Codex）
- [ ] NAMING-1：所有上传记录具备哈希、短链、版本字段，去重逻辑和目录规则符合规范；迁移脚本与文档齐全。
- [ ] CDN-1：命名规范稳定后，接入 UpYun 直传并通过环境切换、自测回退验证。
- [ ] CDN-2：可生成或调用带水印的分享图，分享按钮引用正确版本并附带模板文案。
- [ ] ROLL-1：胶卷页可访问、展示完整数据并支持分享，旅程/随机入口指向一致。
- [ ] ROLL-2：胶卷聚合页展示品牌/介绍/素材，实例列表可筛选并链接到生命周期页；生命周期页含状态时间轴、照片列表、分享入口，保持与现有懒加载/加密逻辑一致。
- [ ] SL-1：Gallery/时间轴/地图等入口默认展示短链，点击任意照片均跳转 `/s/{code}`；`PhotoPreview` 可解析短链并更新地址栏，分享/复制操作全部使用短链。
- [ ] SL-2：旧 `?photo=` 链接可兼容跳转至短链；路由、帮助文档与规范已同步更新，SEO/分享说明明确新老链接差异。

## 4. 遗留事项
- Windsurf 与 Cursor 的交叉约定：
  - Windsurf 仅消费 Cursor 暴露的 `photo.imageUrl`、`short_code` 等字段，不自行生成图片或改命名逻辑。
  - 胶卷页的分享入口、实例列表应等待 NAMING/CDN 完成短链和 UpYun 输出后再接入，当前可先使用后端返回的占位字段。
  - 若新增接口字段（如生命周期状态、短链），需遵循命名规范并在文档中标注，避免后续冲突。
- 追踪事项：待 NAMING-1 完成后，更新分享与胶卷页面的接口字段列表并同步至 Windsurf。
- 今日新增遗留：
  - `/map` 页面短链偶发失效（地址栏仍停留 `/map`），需加调试日志诊断。
  - 胶卷素材命名/存储未完全按规范：`film_stocks.type` 仍为中文，素材未归档到 `docs/knowledge-base/assets/`，未生成短码命名约定。
  - 文档/帮助/测试记录尚未更新前台短链说明（SL-2 待完成）。

## 5. 审计记录
- 待开始（Codex）

## 6. 当日总结与下一步
- 当日主要进展：
  - 执行 NAMING-1 数据库迁移脚本，新增 file_hash/storage_variant/short_code 等字段并建立触发器。
  - 后端接入 `storage/namingService`，批量上传与单张上传均支持哈希去重、短链生成与统一响应结构。
  - 补充 `backend/scripts/backfill-photo-identifiers.js`，回填历史照片哈希/短链/路径并记录 1 条哈希冲突待人工复核。
  - 前端后台管理页适配短链：统一通过 `SHORT_LINK_PREFIX` 解析显示，提供复制能力，并同步展示存储元数据字段。
  - 新增 `backend/logs/short-links.log` 日志链路，短链生成（含重复上传）均记录 SHA256/MD5 与对象路径，便于后续审计；规范文档已补充。
- 下一步：
  - @backend 完成上传响应在前端的字段适配，与 Windsurf 协调短链呈现方案。
  - @database/@devops 根据冲突日志分析重复文件并制定处理策略。
  - @reviewer 准备 NAMING-1 自查清单，确认文档与代码字段保持一致。
  - 调试 `/map` 短链地址栏问题，补齐日志和测试记录。
  - 整理胶卷素材命名规范与归档策略，更新文档与脚本。
  - 完成 SL-2：文档/帮助文案同步短链说明，记录前台回归结果。

---
*工作流程版本：v2025.10.28-workflow04；执行角色：Codex (GPT-5)、Windsurf (Claude Sonnet)。*
