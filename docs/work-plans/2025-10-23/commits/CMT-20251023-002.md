# 提交 CMT-20251023-002

> 实现照片旋转功能(初版)

---

## 1. 关联任务
- B-1: 数据库添加`rotation`字段,后端Sharp处理
- B-2: 前端添加旋转UI(单张上传、编辑、批量上传)
- B-3: 修复旋转预览溢出问题
- B-4: 创建`ImageRotateControl`组件简化UI

---

## 2. 用户意见

**用户需求**:
> "上传竖着的照片也变成横的了,如果你没有办法自动识别照片方向,可以让我在上传/编辑的时候进行调整"

**后续反馈**:
1. "点击旋转按钮旋转后图片溢出图片展示范围了,遮挡底部的按钮了"
2. "旋转后保存,管理列表的图片并没有发生变化"
3. "旋转后保存回到前台页面,只看到页面展示区域变化了,但是图片没有被旋转"
4. "我认为旋转可以在预览图上放2个按钮,左转和右转即可,不需要这么麻烦放4个按钮"

---

## 3. 开发总结

### 3.1 数据库字段 (B-1)

**修改**:
```sql
ALTER TABLE photos ADD COLUMN rotation INTEGER DEFAULT 0;
```

**说明**:
- `rotation`: 存储旋转角度(0/90/180/270)
- 默认值为0(不旋转)

### 3.2 后端处理 (B-1)

**uploadPhoto函数修改**:
```javascript
const rotation = req.body.rotation ? parseInt(req.body.rotation) : 0;

// 保存到数据库
INSERT INTO photos (..., rotation) VALUES (..., ?)
```

**uploadPhotosBatch函数修改**:
```javascript
const rotation = req.body[`rotation_${i}`] ? parseInt(req.body[`rotation_${i}`]) : 0;
```

**初版方案** (后续被废弃):
- 前端CSS transform实现视觉旋转
- 后端只存储rotation值
- **问题**: 只是视觉效果,刷新后失效

### 3.3 前端UI - 初版4按钮 (B-2)

**单张上传/编辑弹窗**:
```jsx
<div>
  <Label>照片方向</Label>
  <div className="flex gap-2">
    <Button onClick={() => setRotation(0)}>原始</Button>
    <Button onClick={() => setRotation(90)}>90°</Button>
    <Button onClick={() => setRotation(180)}>180°</Button>
    <Button onClick={() => setRotation(270)}>270°</Button>
  </div>
</div>
```

**批量上传**:
- 每张照片独立的旋转按钮组

**问题**:
- 4个按钮太占空间
- 不够直观

### 3.4 修复预览溢出 (B-3)

**问题**: 旋转后图片溢出预览容器,遮挡底部按钮

**解决方案**:
```jsx
<div 
  className="relative flex items-center justify-center"
  style={{
    width: '400px',
    height: '400px',
    maxWidth: rotation === 90 || rotation === 270 ? '300px' : '400px',
    maxHeight: rotation === 90 || rotation === 270 ? '500px' : '400px'
  }}
>
  <img
    src={previewUrl}
    style={{
      transform: `rotate(${rotation}deg)`,
      maxWidth: '100%',
      maxHeight: '100%'
    }}
  />
</div>
```

### 3.5 ImageRotateControl组件 (B-4)

**创建新组件**: `frontend/src/components/ImageRotateControl.jsx`

```jsx
export default function ImageRotateControl({ rotation = 0, onChange }) {
  return (
    <div className="flex items-center gap-2">
      <Button onClick={() => onChange((rotation + 270) % 360)}>
        <RotateCcw className="w-4 h-4" />
      </Button>
      <span>{rotation}°</span>
      <Button onClick={() => onChange((rotation + 90) % 360)}>
        <RotateCw className="w-4 h-4" />
      </Button>
    </div>
  );
}
```

**特点**:
- 只有左转/右转两个按钮
- 显示当前角度
- 自动计算新角度(90度递增/递减)
- 可复用到所有需要旋转的场景

**集成位置**:
- 单张上传弹窗
- 编辑弹窗
- 批量上传(每张图片)

### 3.6 自测结果

| 测试项 | 预期 | 实际 | 结果 |
|--------|------|------|------|
| 单张上传-旋转UI显示 | 显示左转/右转按钮 | ✅ 显示 | ✅ 通过 |
| 单张上传-旋转预览 | 图片旋转不溢出 | ✅ 不溢出 | ✅ 通过 |
| 批量上传-每张独立旋转 | 每张图片独立控制 | ✅ 独立 | ✅ 通过 |
| 编辑照片-旋转功能 | 可以调整已上传照片方向 | ✅ 可以 | ✅ 通过 |

---

## 4. 审计记录

### 用户测试反馈 - 第1轮

**时间**: 2025-10-23 11:15  
**结果**: ⚠️ 部分通过,需改进

**问题**:
1. ✅ 旋转UI显示正常
2. ✅ 预览不溢出
3. ❌ 旋转后保存,管理列表的图片未变
4. ❌ 旋转后保存,前台页面图片方向未变
5. 💡 建议简化为两个按钮(左转/右转)

**用户评价**:
> "很好,可以操作,但是这里有几个问题..."

### 修订 - 创建ImageRotateControl组件

**时间**: 2025-10-23 13:30  
**内容**: 创建可复用的旋转控制组件,简化UI

### 用户测试反馈 - 第2轮

**时间**: 2025-10-23 14:00  
**结果**: ⚠️ UI改进完成,但核心问题仍存在

**问题**:
1. ✅ UI简化为左转/右转,更直观
2. ✅ 批量上传每张图片独立控制
3. ❌ 旋转只是CSS效果,刷新后失效
4. ❌ 管理列表和前台页面未显示旋转效果

**用户评价**:
> "左转右转有了,但是转了之后管理页面没有变,前端图片高度变了,图片的方向没有变"

---

## 5. 修订历史

### 修订1: 创建ImageRotateControl组件
- **时间**: 2025-10-23 13:30
- **内容**: 简化UI为两个按钮
- **验证**: ✅ UI改进通过

### 修订2: 添加前端CSS transform显示
- **时间**: 2025-10-23 14:15
- **内容**: 在列表和Gallery添加CSS transform
- **验证**: ⚠️ 只是视觉效果,不是真正旋转

---

## 6. 验收结果

**状态**: ⚠️ 部分通过  
**问题**: CSS旋转只是视觉效果,需要后端物理旋转  
**决策**: 需要重新设计方案,转入CMT-20251023-003

**已完成**:
- [x] 数据库添加rotation字段
- [x] 前端旋转UI(ImageRotateControl组件)
- [x] 预览不溢出
- [x] 批量上传支持每张独立旋转

**待改进**(转入下一提交):
- [ ] 后端物理旋转图片
- [ ] 管理列表显示旋转后的图片
- [ ] 前台页面显示旋转后的图片

---

## 7. Git提交

> ⚠️ 与CMT-20251023-003合并提交(方案重构)

---

**记录人**: Claude (Anthropic Sonnet 4.5) in Cursor  
**创建时间**: 2025-10-23 14:30  
**后续**: 见 CMT-20251023-003 (EXIF Orientation方案)

