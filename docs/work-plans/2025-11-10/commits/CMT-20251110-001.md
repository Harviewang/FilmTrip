# 提交 CMT-20251110-001

## 1. 关联任务
- SL-1-MAP: 前端短链统一与地址栏回写（Timeline/Preview/后台管理视图）

## 2. 用户意见
1. 对加密文案进行逐场景核对，管理员/普通用户/预览模式的提示需一致。
2. 加密照片不允许通过短链直接泄露原图，访客打开 `/s/{code}` 应看到明确的保护提示。
3. “不适宜公开”文案需调整为“不宜公开”。
4. 评分功能未来要记录“谁、什么设备、什么时间、哪个动作”，本次先留在需求池。

## 3. 开发总结

### 3.1 Timeline 页面短链与隐私改造（`frontend/src/pages/Timeline/index.jsx`）
- 接入 `utils/shortLink`，统一解析/构建 `/s/{code}`，支持依据 URL 参数或短链直接定位照片。
- 维护浏览器历史：打开/关闭/左右切换均更新地址栏并回滚到初始路径。
- 对受保护照片显示来自常量的描述文案，访客不再看到原图，管理员保持原有权限。
- 复用 `PhotoApi` 数据结构，去除散落的本地日志，兼容旧 `?photo=` 链接。

### 3.2 PhotoPreview 组件防泄漏与文案统一（`frontend/src/components/PhotoPreview.jsx`）
- 不再尝试加载受保护原图，非管理员直接看到锁图标+加密等级描述。
- 底部“加密状态”改为纯文本等级；复制短链时复用 `resolvePhotoShortLink`。
- 引入短链工具，管理员继续支持复制原链接，访客侧仅呈现提示。

### 3.3 管理端作品列表与查看弹窗（`frontend/src/views/PhotoManagement.jsx`）
- 使用 `resolveProtectionLevelInfo` 输出加密等级标签，移除额外描述段。
- 列表和详情支持复制短链，预览时统一 fallback 资源加载逻辑。
- 引入 `ensureAbsoluteUrl` 处理相对路径，减少 404。

### 3.4 公共常量与工具（`frontend/src/constants/protectionLevels.js`, `frontend/src/utils/shortLink.js`）
- 抽离加密等级定义、别名与解析方法，供多页面复用，更新“不宜公开”文案。
- 新增短链工具：归一化 code、构建 `/s/{code}` 路径、生成完整分享地址。

## 4. 自测结果
- ✅ 访客打开 `/timeline` 并点击受保护照片：地址栏跳转 `/s/{code}`，界面显示加密提示，不加载原图。
- ✅ 管理员登录后台查看作品列表：卡片显示短链，复制成功且文案一致。
- ✅ PhotoPreview 在访客/管理员模式下切换正常，受保护照片无法泄露。
- ✅ 复制短链后重新打开浏览器标签，可恢复对应照片；关闭弹窗回到原始路径。
- ⏳ `/map` 页面尚未接入新的短链回写逻辑（下一步）。

## 5. 审计记录
- 待 Codex 复审。

## 6. 修订历史
- Rev-1（2025-11-10）：初版实现，完成 Timeline/Preview/管理端改造与文案统一。
- Rev-2（2025-11-10）：修复审计问题，提前定义 updateHistoryForPhoto/restoreHistoryPath，补充 timeline 路由，并使用 authRef 判断管理员权限防止本地伪造。

## 7. Git 提交
- commit message：
  ```
  SL-1-MAP: unify short-link handling for timeline and preview
  
  - add shared shortLink utils and protection level constants
  - block guest access to protected originals, show unified copy
  - update timeline and admin views to read/write /s/{code}
  - adjust copy to “不宜公开” and expose short-link copy actions
  
  自测: Timeline/Preview/管理端短链联动通过
  ```
- commit hash：f01e8daf3465b1ba100ca9d6bce7f560ce017963
