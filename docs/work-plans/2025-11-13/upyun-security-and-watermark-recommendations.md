# 又拍云水印大小建议和安全优化

## 1. 水印大小建议

### 当前配置
- 缩略图（600px）：无水印
- 预览图（1024px）：带水印，32px（约3.1%）
- 大图（2048px）：带水印，48px（约2.3%）

### 详细建议

| 图片尺寸 | 当前水印 | 建议水印 | 比例 | 说明 |
|---------|---------|---------|------|------|
| 600px (thumb) | 无水印 | 无水印 | - | 列表缩略图，不需要水印 |
| 1024px (preview) | 32px | **32px** | 3.1% | 预览图，水印明显但不遮挡主体 ✅ |
| 2048px (large) | 48px | **48px** | 2.3% | 大图，水印清晰可见 ✅ |

### 推荐配置

**在又拍云控制台配置样式时，建议：**

```
preview (1024px):
- 输出格式：JPG
- 图片质量：85-90
- 高斯模糊：关闭（水印已足够）
- 水印大小：32px ✅
- 水印位置：右下角（或自定义）

large (2048px):
- 输出格式：JPG
- 图片质量：90-95
- 高斯模糊：关闭（水印已足够）
- 水印大小：48px ✅
- 水印位置：右下角（或自定义）
- 渐进式图片载入：开启（JPG）
```

## 2. 图片链接泄露问题

### 当前状态
- 所有照片（包括受保护的）都使用公开的CDN链接
- 链接格式：`http://filmtrip-dev.test.upcdn.net/dev/WEB/.../xxx.jpg!thumb`
- 任何人都可以通过链接直接访问图片

### 安全建议

#### 方案A：受保护照片使用签名URL（推荐）
- 对受保护的照片，使用签名URL（`_upt` 参数）
- 签名URL有效期：5-10分钟
- 公开照片继续使用CDN链接（性能更好）

#### 方案B：所有照片都使用签名URL（最安全但性能较差）
- 所有照片都使用签名URL
- 影响CDN缓存性能

#### 方案C：Referer防盗链（又拍云控制台配置）
- 在又拍云控制台配置Referer白名单
- 只允许来自 `filmtrip.cn` 的请求
- 但无法防止直接访问

### 实施建议

**优先实施方案A：**
1. 修改 `buildVariantUrls` 函数，对受保护照片使用 `generateSignedUrl`
2. 签名URL有效期设置为 5-10 分钟
3. 前端缓存签名URL，过期后重新获取

## 3. 缩略图数量问题

### 当前配置
- `pageSize = 20`（每页20张）
- 用户期望：36张（一个胶卷的数量）

### 建议

**方案A：修改默认pageSize**
- 将 `pageSize` 改为 36
- 优点：符合用户期望，一次加载一个胶卷的照片
- 缺点：初始加载时间可能稍长

**方案B：保持20，但优化加载**
- 保持 `pageSize = 20`
- 添加"加载更多"功能
- 每次加载20张，直到36张

**方案C：动态pageSize**
- 根据设备性能和网络状况动态调整
- 桌面端：36张
- 移动端：20张

### 实施建议

**推荐方案A：**
- 修改 `frontend/src/pages/Gallery/index.jsx` 中的 `pageSize` 为 36
- 同时检查后端是否有最大限制（当前是 `limit > 100`）

## 4. 当前显示13张的原因

### 分析
- 后端返回：20张
- 受保护被过滤：2张
- 应该显示：18张
- 实际显示：13张
- **差异：5张**

### 可能原因
1. 5张照片没有生成有效的图片URL（`thumbnail` 和 `size1024` 都为 `null`）
2. 前端 `mapPhotoRecord` 在某些情况下返回 `null`
3. 前端有其他过滤逻辑

### 建议检查
1. 检查后端日志，确认是否有照片的 `buildVariantUrls` 返回空值
2. 检查前端控制台，确认是否有照片被过滤或报错
3. 检查数据库，确认这5张照片的 `thumbnail` 和 `size1024` 是否为空

