# 2025-10-24 当日工作计划（Codex）
> 依据《docs/work-plans/README.md》制定明日协作计划。
> 当日执行与记录将以本文件为准。

---

## 1. 用户原始需求
- 处理后台“删除照片”操作返回 404 的问题，确保管理员可正常删除。
- 排查并修复 Vercel 部署版本前端无法加载数据（接口 404）的联调问题。
- MapTiler 用量已达 86%，需要评估并讨论替换/扩容方案（用户已有备选方案，需会审）。
- 其余工作从需求池/遗留事项中筛选，结合优先级安排（用户特别希望“随机浏览”相关需求全部完成），加密体验亦需补齐。
- （新增 2025-10-24 晚）暂停"002"相关事项，优先规划照片预览功能优化。确认现有逻辑基本完整：EXIF方向处理、80%/90%比例计算、旋转功能、重置机制、沉浸模式行为等都已实现，主要需要调整比例和确认实现细节。

---

## 2. 任务拆解（更新版）

| 编号 | 模块 | 任务摘要 | 负责人 | 目标状态 | 备注 |
| --- | --- | --- | --- | --- | --- |
| P0-1 | 后端 · 照片管理 | 重现 & 修复 `DELETE /api/photos/:id` 返回 404，补充测试 | Codex→AI助手 | 待完成 | 需确认数据库存在记录、检查路由/权限 |
| P0-2 | 部署 · Vercel | 调查前端 404（API 不通），同步部署策略与环境变量 | Codex→AI助手 | 待完成 | 可能涉及 CORS、Base URL、SSR 配置 |
| P0-3 | 基础设施 | 评估 MapTiler 用量 86% 的缓解方案，与用户讨论决策 | Codex | 待讨论 | 梳理现状、费用、替代方案、缓存策略 |
| P0-4 | 随机浏览 | 完成随机浏览需求池条目（B-1/B-3）：接口返回 6 张、Gallery 视图联动、前端交互补齐 | Codex→AI助手 | 待完成 | 需对照 `docs/work-plans/overview.md` 中随机任务清单 |
| P0-5 | 加密体验 | 按 `protection_level` 区分访客提示语，补齐加密相关需求（含列表过滤加密项） | Codex→AI助手 | 待完成 | 需梳理后端定义的三种类型、更新前端交互与文档 |
| P0-6 | Gallery 功能 | Gallery加密图片过滤开关：在/gallery页面添加"隐藏加密图片"开关 | Codex→AI助手 | 待完成 | ⭐ 新增：与P0-5强关联，用户体验关键 |
| P0-7 | 管理后台 | 照片列表加密过滤功能：管理后台添加加密状态过滤按钮(全部/仅加密/仅公开) | Codex→AI助手 | 待完成 | ⭐ 新增：与P0-5强关联，管理必需功能 |
| P1-1 | 文档一致性 | 核对归档文档与当前代码实现（2025-10-23遗留） | Codex→AI助手 | 待完成 | 重点关注加密、旋转相关章节 |
| P1-2 | 前端 · 上传体验 | 上传弹窗在小屏溢出问题的 UI/响应式优化 | AI助手 | 待完成 | ⭐ 提升优先级：用户反馈强烈，需准备截图 & 自测方案 |
| P1-3 | 预览模式 | 依据原始尺寸/方向，设定标准预览与沉浸预览的默认尺寸与旋转表现 | Codex→AI助手 | 待规划 | 确认现有逻辑基本完整：EXIF处理、80%/90%比例、旋转功能、重置机制等已实现；将编制 CMT-20251024-004 方案 |
| P1-4 | 预览模式 | 预览模式默认行为优化：列表点击照片默认打开标准预览模式 | Codex→AI助手 | 待规划 | ⭐ 与 P1-3 联动，确认现有逻辑已实现，主要需要调整比例和确认实现细节 |
| P1-5 | 导航体验 | A-1导航文案更新确认：`/trip`路由、`/random`下线或重定向状态核实 | Codex→AI助手 | 待确认 | ⭐ 新增：23号遗留任务，需核实仓库实现状态 |
| P2-1 | Gallery 功能 | 设计加密过滤开关逻辑与 UI 草案 | Codex→AI助手 | 待讨论 | 可与 P0-6 的"Gallery过滤开关"落地策略联动 |
| P2-2 | 运维配置 | CORS 允许域名策略复核（任务 X-1） | Codex→AI助手 | 待确认 | 与 Vercel 联调可合并处理 |

> 明日根据实际进展可细化子任务与负责人；若新增任务，须同步更新本表与需求池。

---

## 3. 验收清单（更新版）
- [ ] P0-1：删除照片接口 404 已定位并修复（含回归测试、文档记录）。
- [ ] P0-2：Vercel 部署前后端互通，页面可正常拉取数据（含配置说明）。
- [ ] P0-3：完成 MapTiler 用量方案讨论，形成结论与行动项。
- [ ] P0-4：随机浏览需求池条目全部交付（API / 前端 / 文档状态同步）。
- [ ] P0-5：加密提示按类型区分、列表过滤等需求交付（含自测与文档）。
- [ ] P0-6：Gallery加密图片过滤开关已实现，支持隐藏/显示加密图片（含状态持久化）。
- [ ] P0-7：管理后台照片列表加密过滤功能已实现，支持全部/仅加密/仅公开过滤。
- [ ] P1-1：归档文档与现有实现差异点梳理完毕，并给出修订建议。
- [ ] P1-2：上传弹窗在常见分辨率下无溢出，自测截图存档。
- [ ] P1-3：标准/沉浸预览默认尺寸与旋转逻辑基于真实宽高完成适配。
- [ ] P1-4：预览模式默认行为已优化，列表点击照片始终默认标准预览模式。
- [ ] P1-5：A-1导航文案更新状态已核实，`/trip`路由和`/random`重定向已确认。
- [ ] 需求池同步：overview/需求文档按需更新，保持任务状态一致。

---

## 4. 需求池整理结果

### 4.1 重复项整理
**已整理的需求重复项**：
- ✅ **加密过滤功能**：将分散的"照片列表加密过滤"和"Gallery加密图片过滤开关"合并为"加密与过滤功能"分类
- ✅ **预览模式优化**：将"预览模式默认行为优化"和"预览尺寸自适应优化"合并为"预览模式优化"分类
- ✅ **上传体验优化**：将"上传弹窗响应式优化"和"图片旋转交互优化"合并为"体验与性能优化"分类

### 4.2 新增任务来源
**P0-6 和 P0-7 来源**：
- 来自需求池"加密与过滤功能"分类
- 与P0-5加密体验强关联，提升用户体验和管理效率

**P1-4 和 P1-5 来源**：
- P1-4：来自需求池"预览模式优化"分类
- P1-5：来自23号遗留任务A-1导航文案更新

### 4.3 优先级调整说明
- **P1-2上传弹窗响应式优化**：从P1提升优先级，用户反馈强烈
- **P0-6/P0-7加密过滤功能**：新增P0优先级，与加密体验核心功能强关联

---

## 5. 遗留 / 风险提示
- MapTiler 若不及时处理，月底前可能停服；需在讨论后尽快落地方案。
- Vercel 部署可能牵涉 Secrets / Edge Functions，排查耗时不可低估。
- 删除照片问题若涉及权限/文件同步，需要确认是否有数据清理脚本支撑。
- 2025-10-23 的 P2 项（Gallery 优化、视图切换）暂列低优，如与随机/加密任务产生交集需同步评估范围。

---

## 6. 资料准备与协作安排
- 参考文档：`docs/work-plans/2025-10-23/summary.md`（遗留事项 & 复盘）；
  `docs/需求文档-统一版.md`（需求池条目）；`docs/troubleshooting/`（问题复盘模板）。
- 建议明日 09:30 前确认 MapTiler 方案讨论时间，输出会议纪要。
- 若需联调 Vercel，提前准备现有环境变量、日志、部署流程说明。

---

## 7. Codex 计划
- 上午：验收删除接口问题、梳理 MapTiler 方案，并更新任务状态。
- 下午：联合 AI 助手推进 Vercel 404、随机浏览与加密体验相关交付，并同步 UI/文档任务。
- 晚间：汇总当日进展，更新验收清单与需求池。

---

## 8. 提交记录

### CMT-20251024-001 ✅ 已完成
**提交内容**：P0优先级任务完成
- P0-1: 照片删除功能修复 ✅
- P0-2: Vercel部署CORS问题修复 ✅  
- P0-3: 批量上传500错误修复 ✅
- P0-4: 随机浏览功能实现 ✅
- P0-5: 加密体验优化 ✅
- P0-6: Gallery加密图片过滤开关 ✅
- P0-7: 管理后台照片列表加密过滤功能 ✅
- 组件重构：Photos到Gallery ✅
- 文档整理：知识库建立 ✅
- 文档管理规范建立 ✅

**审计状态**：✅ 已通过复审

### CMT-20251024-002 📋 计划中
**计划内容**：胶片暗盒交互功能
- 胶片暗盒交互功能实现
- 响应式设计适配
- 相关文档更新
- 进度提示：`/gallery` 随机模式已接入胶片暗盒首版交互（抽片动画、信息卡、换一卷流程雏形），待体验评估与动效细化。
- 新增需求澄清：随机模式仅保留"胶片暗盒 + 胶片带"布局，点击照片直接调用通用预览；暗盒需实现"初始/随机/确定"三态，胶片需支持"未抽出/抽出"两态，抽出后依据 EXIF 旋转统一帧尺寸。
- 开发进展：新增 `FilmCanister` / `FilmStrip` 矢量组件，重构随机模式布局，并接入筛选条件过滤（类型 / 画幅）与 EXIF 旋转逻辑。

**状态**：准备开始开发

### CMT-20251024-003 ✅ 已完成
**提交内容**：MapTiler优化完成
- ✅ **配额监控**：实现MapTiler日使用量统计和监控
- ✅ **Service Worker缓存**：7天TTL缓存，最多1000个瓦片，自动清理过期缓存
- ✅ **降级策略**：超限时自动切换到OSM，避免封禁用户
- ✅ **日重置逻辑**：跨日自动重置配额，避免永久降级
- ✅ **双重统计**：Service Worker统计API请求，前端统计UI提示
- ✅ **攻击防护**：使用clientId替代IP检测，避免误封
- ✅ **配额限制**：200次/日，150次警告阈值

**技术实现**：
- `frontend/src/pages/Map/index.jsx`：配额监控和降级逻辑
- `frontend/public/sw.js`：Service Worker缓存和配额管理
- `frontend/public/test-quota-reset.js`：测试脚本

**审计状态**：✅ 已通过复审（经过5轮Codex审计）

### CMT-20251024-004 📝 规划中
- **范围**：P1-3 / P1-4 预览模式体验优化（EXIF方向处理、80%/90%比例计算、旋转功能、重置机制、沉浸模式行为等逻辑确认与优化）。
- **当前状态**：现有逻辑基本完整，主要需要调整比例和确认实现细节，等待 Cursor 环境恢复后执行。
- **下一步**：确认当前实现的比例是否为80%/90%，验证EXIF处理和重置机制，优化上传弹窗响应式和背景设计。

---

## 8. 2025-10-22 遗留任务复核（供排期参考）

| 编号 | 描述 | 2025-10-22 状态 | 当前复核（2025-10-24） | 说明 |
| --- | --- | --- | --- | --- |
| A-1 | 导航文案更新、`/trip` 路由、`/random` 下线或重定向 | 🔄 进行中 | ⚠️ 待确认 | 仓库中出现 `frontend/src/pages/Trip/` 目录但内容为空；需核实导航与路由是否真正上线。 |
| B-3 | Gallery 随机一次返回 6 张并在卡片墙展示 | 🔄 进行中 | ⛔ 未完成 | 已纳入 P0-4，需验证 `/api/photos/random` 与前端展示联动。 |
| C-1 | 数据库新增保护字段及迁移脚本 | 🔄 进行中 | ✅ 已完成（2025-10-23） | `backend/models/db.js` 已包含 `is_protected`/`protection_level` 字段及迁移逻辑，2025-10-24 复审通过。 |
| C-2 | API 返回 `effective_protection` 并限制普通用户访问 | 🔄 进行中 | ✅ 能力具备，体验待优化 | 后端已返回字段并控制 URL，下游提示文案/过滤在 P0-5、P2-1 处理。 |
| C-3 | 前端加密展示与上传保护选项 | 未开始 | ⛔ 未完成 | 访客提示差异、列表过滤、上传表单等仍缺失。 |
| D-1 | 上传坐标解析、行政区补全与批处理脚本 | 未开始 | ⛔ 未启动 | 需确认优先级与数据来源。 |
| D-2 | 前端 `PhotoMetaGrid` 统一信息布局 | 未开始 | ⛔ 未启动 | 与 D-1 配套，暂未有实现记录。 |
| X-1 | 启用 CORS 中间件并配置允许域名 | 未开始 | ⚠️ 待处理 | 可与 P0-2 的 Vercel 联调一并推进。 |
| 文档同步 | 更新需求文档 / README / 部署指南 | 未完成 | ⚠️ 部分完成 | 加密与旋转章节已更新，导航/随机/CORS 等需待功能交付后补齐。 |

> 如明日人力允许，可优先抓取表中“未完成/待确认”项，确保与最新需求同步。
