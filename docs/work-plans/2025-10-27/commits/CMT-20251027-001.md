# CMT-20251027-001: 地图定位样式优化

## 关联任务
- **M-1**: 地图定位样式优化

## 用户需求
用户反馈定位标记样式被改成图钉，要求恢复原来的自定义HTML样式（绿色圆点+脉冲动画）。

## 开发内容

### 1. 定位标记样式修复
**文件**: `frontend/src/pages/Map/MapLibre.jsx`

**修改内容**:
```javascript
// 添加用户位置标记
useEffect(() => {
  if (!mapInstanceRef.current || !userLocation) return;

  if (userMarkerRef.current) {
    userMarkerRef.current.remove();
  }

  const el = document.createElement('div');
  el.className = 'user-location-marker';
  el.innerHTML = '<div class="user-location-dot"><div class="user-location-pulse"></div></div>';
  
  // 添加 anchor 属性确保居中
  el.style.width = '24px';
  el.style.height = '24px';

  const marker = new maplibregl.Marker({
    element: el,
    anchor: 'center'
  })
    .setLngLat([userLocation.longitude, userLocation.latitude])
    .addTo(mapInstanceRef.current);

  userMarkerRef.current = marker;
}, [userLocation]);
```

**技术说明**:
1. 保持与旧代码一致的HTML结构：`user-location-dot` + `user-location-pulse`
2. 添加 `anchor: 'center'` 确保定位点居中
3. 添加 `width: 24px` 和 `height: 24px` 确保尺寸正确

### 2. CSS样式（无修改）
**文件**: `frontend/src/pages/Map/Map.css`

**现有样式**:
- `.user-location-dot`: 绿色圆点（#4caf50），20px×20px，白色边框3px
- `.user-location-pulse`: 脉冲动画效果

## 自测结果
- ✅ 定位标记HTML结构保持原样
- ✅ CSS样式类名未修改
- ✅ 添加了MapLibre GL JS兼容的anchor配置

## 审计记录（Codex，2025-10-27）
- ❌ **地图页面仍为空白**：`frontend/src/pages/Map/MapLibre.jsx:193` 的容器使用 `<div className="mapboxgl-map" ref={mapRef}>`，但 `Map.css` 只为 `.leaflet-map` 定义高度（`frontend/src/pages/Map/Map.css:360`）。MapLibre 要求容器有显式 `width/height`；目前高度仍为 `auto`，导致地图渲染后画布高度为 0，页面始终空白。需要为 MapLibre 容器（如 `.maplibregl-map` 或 `.mapboxgl-map`）添加 `width:100%; height:100%`。
- ⚠️ **遗留文件未同步**：同目录仍保留多个 Leaflet 备份文件（例如 `frontend/src/pages/Map/index.jsx` 及 `backup-20251026/`），容易让后续修改引用旧实现。建议确认现行入口并清理或至少在文档中标注，以避免再次回退至 Leaflet。

## 用户反馈
用户对之前多次未经授权的修改表示极度不满，要求明确正确的样式定义。

## 验收状态
- ⏳ 待用户验证

### 修改2: MapLibre 容器样式优化（修复 Codex 审计问题）
**文件**: `frontend/src/pages/Map/Map.css`

**修改内容**:
```css
/* MapLibre GL 地图容器 */
.mapboxgl-map,
.maplibregl-map {
  width: 100%;
  height: 100%;
}

/* MapLibre 地图画布 */
.maplibregl-canvas-container {
  width: 100%;
  height: 100%;
}

.maplibregl-canvas {
  width: 100%;
  height: 100%;
}
```

**技术说明**:
1. 添加 `.maplibregl-map` 样式（MapLibre 别名）
2. 添加 `.maplibregl-canvas-container` 和 `.maplibregl-canvas` 样式确保画布尺寸正确
3. **修复审计问题**: 解决 MapLibre 渲染后画布高度为 0 的问题

### 修改3: 创建地图文件说明（修复 Codex 审计问题）
**文件**: `frontend/src/pages/Map/README-MAP-FILES.md`

**内容**:
- 标注当前使用的 `MapLibre.jsx` 组件
- 列出备份文件并标注已废弃
- 说明迁移历史和备份原因
- 提供紧急回退步骤
- **修复审计问题**: 避免误用旧的 Leaflet 实现

## Git提交信息
```
fix(MapLibre): 优化定位标记样式并修复容器渲染问题

- 添加 anchor: 'center' 配置
- 添加 width: 24px 和 height: 24px 样式
- 保持原有的绿色圆点+脉冲动画样式
- 修复 MapLibre 容器样式，添加 maplibregl-canvas-container/canvas 样式
- 创建 README-MAP-FILES.md 标注文件用途
- 解决 Codex 审计问题：地图容器高度和旧文件混乱
```
