# 提交记录 CMT-20251112-003

| 字段 | 内容 |
| --- | --- |
| 提交时间 | 2025-11-12 |
| 提交人 | Codex (GPT-5) |
| 关联任务 | NAMING-1, ROLL-SEC, SL-1-MAP |
| commit hash | cff7448 |

---

## 1. 关联需求 / 背景

- NAMING-1 阶段需要统一胶片品类类型、短链与对象存储命名；补充脚本与库支撑。
- SL-1-MAP 审计指出地图/时间轴仍依赖本地 `/uploads` 拼接，需复用短链与权限控制逻辑。
- 归档文档杂乱，用户要求按月份与 legacy 分层，历史 CSV 等需迁入 archive。

---

## 2. 代码改动摘要

### 后端
- 新增 `backend/utils/filmTypes.js`，实现类型枚举、别名映射、标签解析。
- `filmStockController` 支持类型归一化、校验提示、生成序列号时使用短码；接口返回 `type_label`。
- `filmRollController` 在创建/更新时自动补齐 `name` 字段（缺省回落至编号）。
- `backend/models/db.js` 增加存储相关字段（`file_hash`、`storage_variant` 等）、索引与触发器；补全地理信息字段。
- 新增脚本：
  - `2025-11-09-add-photo-storage-fields.sql`（数据库迁移）
  - `scripts/backfill-photo-identifiers.js`、`encrypt-random-photos.js`、`import-film-assets.js`、`normalize-film-types.js`、`regenerate-short-codes.js`。
- 新建 `backend/storage/namingService.js`，提供对象路径、短链生成工具（供后续 CDN 接入使用）。

### 前端
- 增加 `frontend/src/constants/filmTypes.js`，在胶片品类管理、示例页等统一展示标签。
- Map/Timeline：
  - 引入 `useScrollContainer` 判断管理员身份；访客不再加载真实图片 URL。
  - 接入短链历史（读取 `/s/:code` 路由、同步 `photo` query）。
  - Map + MapLibre 支持短链日志、历史恢复、`photoApi.getPhotoByShortCode`。
- 更新 `services/api.js` 新增短链查询方法；`config/api.js` 暴露 `SHORT_LINK_PREFIX`。
- `RandomFilmStrip`、`More` 页面体验优化。

### 文档与归档
- `docs/archive/` 目录拆分为 `2025-10/`、`2025-11/`、`legacy/`，补充 README，迁移 CSV 数据。
- 新增知识库文章：《CDN 与地图加速讨论纪要-2025-11-06》、《表单状态管理最佳实践》。
- 新建 `docs/work-plans/2025-11-09/` 计划与笔记。

---

## 3. 测试 / 验证

| 场景 | 结果 | 说明 |
| --- | --- | --- |
| Map/Timeline 访客模式 | ✅ | 不再请求 `/uploads`，仅显示锁提示。 |
| 管理员模式 | ✅ | 可通过短链打开、导航历史记录更新正常。 |
| 胶片品类 CRUD | ✅ | 类型选择使用统一枚举，编号生成正确。 |
| SQL 脚本 | ✅ | `2025-11-09-add-photo-storage-fields.sql` 在测试数据库执行通过，触发器可拦截非法变体。 |

---

## 4. 审计 / 待办

- 需在 2025-11-13 回归记录中补充地图短链截图（访客与管理员各一次）。
- 与 @planner/@devops 确认对象存储环境变量（`UPYUN_*`）与 `SHORT_LINK_PREFIX` 发布计划。

---

## 5. 资料引用

- `backend/utils/filmTypes.js`
- `frontend/src/pages/Map/index.jsx`
- `docs/archive/README.md`
- `docs/work-plans/2025-11-09/summary.md`

