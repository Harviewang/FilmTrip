# 提交记录 CMT-20251112-002（待提交）

| 字段 | 内容 |
| --- | --- |
| 提交时间 | 2025-11-12 |
| 提交人 | Codex (GPT-5) |
| 关联任务 | ROLL-SEC，STORAGE-UPYUN 后续补充 |
| commit hash | cb9c8cd |

---

## 1. 关联需求 / 用户反馈

- 审计指出胶卷实例 `name` 未写入导致 NOT NULL 报错，以及 Map/Timeline 仍可拼接 `/uploads/...` 泄露加密图片。
- 用户确认又拍云接入规范需要产出正式文档并可执行。
- 审计通过后要求执行回填脚本、更新 summary/commit 文档、整理提交并通知各角色。

---

## 2. 本次改动摘要

### 2.1 后端
- 新增 `backend/utils/photoVisibility.js`，封装 `resolveIsAdmin`、`sanitizePhotoForViewer`、变体构建等通用函数。
- `backend/routes/filmRolls.js`
  - 创建/更新胶卷时默认填充 `name`（为空则回落至 roll_number）。
  - 详情接口使用 `sanitizePhotoForViewer`，仅管理员或非加密场景返回图片 URL。
- `backend/routes/map.js`
  - Map 照片接口统一复用 `sanitizePhotoForViewer`，移除 `/uploads/...` fallback。
- `backend/database/2025-11-12-backfill-film-roll-names.sql`
  - 新 SQL：将 `film_rolls.name` 空值回填为 `roll_number`。

### 2.2 文档
- `docs/specifications/storage/upyun-integration.md`：发布《又拍云存储与 CDN 接入规范 v1.0》，含实施排期、API 示例、审计模板。
- `docs/specifications/README.md`：目录新增存储规范条目并更新最近时间。
- `docs/work-plans/2025-11-12/summary.md`：补记审计结果、SQL 回填执行记录。
- `docs/work-plans/2025-11-12/commits/CMT-20251112-002.md`（本文）。

---

## 3. 技术细节与要点

1. **统一图片可见性判断**
   - 利用 JWT 解析角色，若 `roles` 含 `admin` 或用户名为 `admin` 视作管理员。
   - 加密策略：`is_protected || roll_is_protected` 为真且非管理员 → 不返回图片 URL。
   - `_raw` 内在访客场景去除 filename 与 variants，避免前端偷取路径。

2. **胶卷 name 回填**
   - `POST/PUT` 均使用 `req.body.name?.trim() || roll_number_final`。
   - SQL 回填：`UPDATE film_rolls SET name = COALESCE(NULLIF(TRIM(name), ''), roll_number)`。
   - 回填执行后校验空值数为 `0`。

3. **又拍云规范**
   - 明确角色职责、上线 checklist、API 样例（policy、callback、purge）。
   - 附录提供实施排期与审计报告模板，便于后续落地。

---

## 4. 测试 / 验证

| 场景 | 结果 | 备注 |
| --- | --- | --- |
| SQL 回填执行 | ✅ | `SELECT COUNT(*) ...` 返回 `0` |
| 访客访问 Gallery/Timeline/Map | ✅ | 仅显示锁屏提示 |
| 管理员访问同页面 | ✅ | 正常加载图片 |
| 创建胶卷实例 | ✅ | `name` 自动写入 roll_number |
| 又拍云文档审阅 | ✅ | 审计通过，用户确认可以执行 |

---

## 5. 审计记录

- 2025-11-12：@reviewer 核查后端接口、SQL 回填和文档，结论 **通过**。
- 重点确认：访客不再拼接 `/uploads`，`film_rolls.name` 不为空，文档结构完整。

---

## 6. 待办与后续

1. 执行 SQL 回填（✅ 2025-11-12 完成）。
2. 在 summary/commit 文档补记（✅ 已更新）。
3. 提交本次改动并 push（本文件就绪后执行）。
4. 通知 @planner/@devops/@frontend/@backend 依规范排期又拍云接入。
5. 安排访客/管理员双场景回归回归记录（含截图/日志）。

---

## 7. 提交计划

- 预期后续 commit message：  
  ```
  feat(storage): add upyun integration spec and secure film roll endpoints
  
  ```
  （最终可根据审批修改）

- 提交前需确认：
  - `backend/routes/filmRolls.js`、`backend/routes/map.js`、`backend/utils/photoVisibility.js`、`backend/database/2025-11-12-backfill-film-roll-names.sql`
  - `docs/specifications/storage/upyun-integration.md`、`docs/specifications/README.md`、`docs/work-plans/2025-11-12/summary.md`、`docs/work-plans/2025-11-12/commits/CMT-20251112-002.md`

