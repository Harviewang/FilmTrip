# CMT-20251029-001: UI优化与交互改进

## 任务概述
对单张上传、批量上传、编辑表单进行UI优化，修复港澳台地址翻译，添加地图搜索功能，改进用户交互体验。

## 完成时间
2025-10-29

## 关联任务
- M-5（上传联动）的后续优化
- 交互体验改进

## 需求追溯
| 需求编号 | 需求描述 | 代码实现 | 测试验证 | 审计状态 |
|---------|---------|---------|---------|---------|
| R-001 | 批量上传布局优化 | ✅ ImageRotateControl.jsx, PhotoManagement.jsx | ✅ 已测试 | ⏳ 待审计 |
| R-002 | 地图搜索功能 | ✅ MapPicker.jsx | ✅ 已测试 | ⏳ 待审计 |
| R-003 | 港澳台地址翻译修复 | ✅ geocode.js, geocode-translations.js | ✅ 已测试 | ⏳ 待审计 |
| R-004 | 添加"解析地址"按钮 | ✅ PhotoManagement.jsx | ✅ 已测试 | ⏳ 待审计 |

## 用户意见
1. **批量上传布局太繁琐，高度占用太多**
   - 需要优化批量上传的UI布局，减少垂直空间占用
   - 照片缩略图太大，需要缩小
   - 按钮和控件过于分散

2. **地图选点需要支持搜索功能**
   - 用户要求输入地名在地图上快速跳转
   - 支持中文/英文地点搜索
   - 避免拖动地图找地方的麻烦

3. **港澳台地址翻译不正确**
   - 地址显示为英中混合格式（如"Hong Kong Hong Kong"、"香港 Hong Kong"）
   - 需要清理中英文混合文本
   - 确保所有地址都正确显示为纯中文

4. **单张上传缺少"解析地址"按钮**
   - 用户发现单张上传表单中缺少"解析地址"按钮
   - 需要为所有表单添加"解析地址"按钮
   - 按钮应始终显示，方便手动触发解析

## 完成内容

### 1. UI布局优化（响应需求1）

**问题**：批量上传布局太繁琐，高度占用太多

**解决方案**：

#### 批量上传优化
- ✅ 照片缩略图从200px缩小到100px
- ✅ 旋转按钮只显示图标，移除"左转""右转"文字
- ✅ 将标签和隐私保护移至每个照片项内（之前是全局设置）
- ✅ 优化照片项布局：图片在左，控制项在右
- ✅ 地图弹窗中"解析地址"按钮与"取消"按钮并排显示

#### 单张上传/编辑优化
- ✅ 所有 MapPicker 都添加了"解析地址"按钮
- ✅ 显示已解析地址信息
- ✅ 地图搜索功能可用

### 2. 地图搜索功能（响应需求2）

**问题**：用户要求在地图上加入搜索功能，避免拖动找地方

**解决方案**：

**实现内容**：
- ✅ 在 MapPicker 组件中添加搜索框
- ✅ 支持中文/英文地点搜索
- ✅ 使用 MapTiler Geocoding API
- ✅ 自动跳转到搜索结果位置
- ✅ 自动设置地图标记
- ✅ 搜索框位于地图上方，不影响表单布局
- ✅ 支持回车键搜索
- ✅ 搜索状态加载提示

**技术细节**：
```javascript
// 使用 MapTiler Geocoding API
const response = await fetch(
  `https://api.maptiler.com/geocoding/${encodeURIComponent(searchQuery)}.json?key=${maptilerKey}&language=zh,en`
);
// 跳转到搜索结果
map.current.flyTo({
  center: [lng, lat],
  zoom: 15,
  duration: 1000
});
```

### 3. 港澳台地址翻译修复（响应需求3）

**问题**：香港、澳门、台湾地址显示为"Hong Kong Hong Kong"、"香港 Hong Kong"等英中混合格式。

**需求来源**：用户反馈地址显示不正确，需要清理中英文混合文本

**解决方案**：
- ✅ 实现 `cleanBilingualText` 函数清理中英文混合文本
- ✅ 优先提取中文字符，移除所有英文
- ✅ 针对港澳台特殊处理：检测关键词识别地区，应用特定翻译规则
- ✅ 翻译港澳台省市区名称

**技术细节**：
```javascript
function cleanBilingualText(text) {
  if (!text) return text;
  
  // 如果包含中文，提取所有中文部分（移除所有英文）
  const chineseMatch = text.match(/[\u4e00-\u9fa5]+/g);
  if (chineseMatch) {
    return chineseMatch.join('');
  }
  
  // 如果不包含中文，尝试移除重复的英文
  return text.replace(/\b([a-zA-Z\s]+)\s+\1\b/gi, '$1').trim();
}
```

**测试结果**：
- ✅ 香港：`province: "香港"`, `district: "元朗區"`
- ✅ 澳门：正确显示中文
- ✅ 台湾：正确显示中文

### 4. 交互优化（响应需求4）

**问题**：单张上传缺少"解析地址"按钮

**解决方案**：

**修复内容**：
- ✅ 修复嵌套 form 错误（HTML `<form>` 不能是 `<form>` 的后代元素）
  - 将 MapPicker 中的 `<form>` 改为 `<div>`，使用 `onKeyDown` 捕获回车
  - 按钮改为 `type="button"`，避免表单提交
- ✅ 优化地图弹窗布局
- ✅ 简化隐私保护选项显示

**修改文件**：
- `frontend/src/views/PhotoManagement.jsx`
- `frontend/src/components/MapPicker.jsx`
- `frontend/src/components/ImageRotateControl.jsx`
- `backend/routes/geocode.js`
- `backend/routes/geocode-translations.js`

## 自测结果
- ✅ 地图搜索功能：支持中文（如"北京大学"）、英文（如"Beijing"）、混合搜索
- ✅ 港澳台地址：所有地址都正确显示为纯中文
- ✅ UI布局：批量上传更紧凑，不再浪费高度
- ✅ 交互：所有按钮正常工作，无表单嵌套错误
- ✅ 单张上传/批量上传/编辑：都可用"解析地址"功能

## 影响范围
- 用户界面：单张上传、批量上传、编辑表单
- 后端API：地址解析逻辑改进
- 无破坏性变更

## 遗留问题
- 无

## 审计记录

### 2025-10-29 Codex 第一轮审计
**状态**：❌ 未通过

**发现问题**：
- `frontend/src/components/MapPicker.jsx` 第90-94行隐藏了 attribution 元素
- 违反了 MapTiler/OSM 使用条款
- 与 10-28 的"Attribution 显示"要求冲突

**修复措施**：
- ✅ 删除隐藏 attribution 的代码（第90-94行）
- ✅ 确保所有地图都正确显示版权标识

**修订历史**：
- 2025-10-29 上午：完成 UI优化、地图搜索、港澳台翻译、交互优化
- 2025-10-29 下午：修复 attribution 隐藏问题（审计发现）
- 2025-10-29：修复 attribution 隐藏问题
- 2025-10-29：补充需求追溯表，确保需求与实现一致

**审计要点**：
1. ✅ 已删除隐藏 attribution 的代码
2. ✅ 所有地图都正确显示版权标识
3. ✅ 符合 MapTiler/OSM 使用条款
4. ✅ 需求追溯表已完成，需求与代码实现一致

### 等待第二轮审计

### 2025-10-29 Codex 第二轮审计
**状态**：✅ 通过

**审计结论**：
- ✅ MapPicker 不再隐藏 attribution 元素
- ✅ 上传/编辑/批量流程符合"Attribution 显示"要求
- ✅ 符合地图许可证使用条款
- ✅ R-001 到 R-004 的所有需求都已实现
- ✅ 未发现其他问题

**审计通过时间**：2025-10-29

## Git 提交
待执行 git commit

