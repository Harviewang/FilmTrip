# CMT-20251029-003：地图链路收尾规划（进行中）

> **目标**：在既有中文地址增强成果上，完成预览迷你地图、译名兜底、批量补录与字段收敛，确保 10 月 29 日所有地图类需求闭环。

## 1. 待完成事项梳理

| 编号 | 模块 | 当前状态 | 未完成内容 | 关联文档 |
| --- | --- | --- | --- | --- |
| M-6 | 预览迷你地图 | ⏳ 部分落地 | ① 迷你地图读取现有坐标后仅展示（禁止拖拽、搜索）<br>② 关闭弹窗时释放地图实例/监听器（验证内存）<br>③ 记录交互流程与异常处理（无坐标时提示） | `frontend/src/components/PhotoPreview.jsx`<br>`docs/work-plans/2025-10-28/完整方案-地图中文地址增强.md` |
| M-7 | 城市译名兜底 | ⏳ 逻辑修复完成 | ① 扩写映射：澳大利亚主要城市（悉尼、墨尔本等）尚未补齐<br>② 增加单元测试校验 translateAddress（至少覆盖日/泰/菲/新/韩）<br>③ 更新最佳实践文档，说明 level 分支策略 | `backend/routes/geocode-translations.js`<br>`docs/knowledge-base/best-practices/地图中文地点增强最佳实践-2025-10-28.md` |
| M-8 | 批量补录 | ⏳ 未启动 | ① 设计后台多选 → 统一选点的交互，补充线框图/流程图<br>② 评估接口：批量更新坐标+五级地址，需要新增 API<br>③ 编写需求文档/任务拆解，列出权限与回滚策略 | `docs/work-plans/2025-10-29/summary.md:任务拆解` |
| M-9 | `location_name` 退役 | ⏳ 未启动 | ① 梳理数据库、API、前端剩余引用点<br>② 规划迁移脚本（备份→清空→校验）及回滚方案<br>③ 更新需求规格的验收标准/字段列表 | `backend/controllers/*.js`<br>`frontend/src/**/*.jsx`<br>`docs/specifications/需求文档-统一版.md` |
| QA-1 | 回归测试 | ⏳ 未执行 | ① 完成 10-28 遗留的浏览器验证并在 summary 勾选<br>② 新增自动化测试：优先考虑 `test-maptiler.js` 扩展、添加地址解析单测 | `docs/work-plans/2025-10-28/summary.md`<br>`test-*.js` |

## 2. 本次提交计划

1. **M-6 完成度提升**
   - 调整 `MapPicker` 支持只读模式（禁用搜索/拖拽），供预览弹窗复用。
   - 关闭弹窗时确认 `map.remove()` 已调用，避免内存泄露。
   - 无坐标时，地点字段提示“缺少坐标”并禁用点击。
   - 更新 `PhotoPreview` 交互说明到需求文档。

2. **M-7 译名扩展 + 测试补齐**
   - 补充澳大利亚主要城市（列入 commit TODO 表中的悉尼等）并整理去重。
   - 新增 `backend/tests/geocode-translations.test.js`（或现有测试脚本）验证 level=city/region 的分支。
   - 在最佳实践文档中记录新的翻译覆盖策略、缓存建议。

3. **M-8 设计交付**
   - 产出后台批量补录的流程图/操作步骤，附到 `docs/work-plans/2025-10-29/commits/CMT-20251029-003.md`。
   - 拆分前端、后端、小工具三个子任务，标明依赖。

4. **M-9 字段退役方案**
   - 罗列所有 `location_name` 使用点（数据库、API、前端展示、脚本）。
   - 拟定迁移步骤：备份 → 新增五级地址检查 → 清理旧字段 → 验证。
   - 输出迁移 checklist，供后续实现参考。

5. **QA-1 回归测试执行**
   - 手工验证 MapTiler/OSM 缩放 & 栅格类型，并更新 10-28 summary 的待办勾选。
   - 挑选 1-2 个关键脚本补充自动化测试（建议：逆地理编码成功/失败用例）。

## 3. 交付物清单

- `frontend/src/components/MapPicker.jsx`、`PhotoPreview.jsx` 相关改动 + 只读模式支持。
- `backend/routes/geocode-translations.js` 映射扩展与单测。
- `docs/work-plans/2025-10-29/commits/CMT-20251029-003.md`（本文件）同步交互设计、迁移计划及 QA 结果。
- `docs/knowledge-base/best-practices/地图中文地点增强最佳实践-2025-10-28.md` 更新。
- 新增/更新测试脚本及运行记录。

## 4. 风险与关注点

- **地图 API 配额**：批量补录可能触发大量逆地理编码，需要缓存与限流策略。
- **字段迁移**：删除 `location_name` 前需确认旧数据已迁移完毕，避免历史记录丢失。
- **MapPicker 复用**：只读模式实现需避免影响现有上传/编辑流程。
- **测试覆盖**：新增自动化测试需考虑沙盒环境缺少真实网络的情况（必要时 mock）。

## 5. 下一步行动

1. 同步本规划给实现同学，确认顺序：**M-6 → QA-1 → M-7 → M-8 → M-9**。
2. 执行过程中将状态、测试结果写入本文件与当日 `summary.md`。
3. 本轮完成后，准备 10-29 当日总结与 10-30 工作计划续篇。

---

> 备注：若后续讨论更新了优先级，请在本文件“待完成事项梳理”表格中及时调整状态，并补充审计记录。***
