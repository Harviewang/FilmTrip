# 2025-10-29 工作计划

## 1. 用户原始需求与决策
- **地图选点解析**：上传/编辑仅支持通过地图选点或直接坐标选点，自动解析并保存 `country/province/city/district/township + latitude/longitude`，作为人类可读与地图绘制的唯一数据源。
- **预览小地图**：照片预览页在用户点击地点字段后按需加载迷你地图（默认 `zoom=12`），基于已存坐标落点，避免初始渲染带来的性能开销。
- **地图总览标点**：`/map` 页面进入后一次性根据存储坐标绘制全部标记；列表页保持无小地图，必要时可进入单条预览补充查看。
- **批量补录能力**：支持未标点的历史作品在**管理后台**批量选点补录五级中文地址与坐标；**多选图片后统一标点**。
- **地址解析策略**：沿用 MapTiler 反向地理编码，预留 Geomaply 作为备选，**优先扩展以下国家城市中文映射：泰国、菲律宾、新加坡、日本、澳大利亚、韩国**；底图中文化优先级较低，暂列为后续需求。

### 2025-10-29 上午临时变更需求
1. **批量上传布局优化**：用户反馈布局太繁琐、高度占用太多
   - 照片缩略图缩小（200px → 100px）
   - 旋转按钮只显示图标，移除文字
   - 标签和隐私保护移至每个照片项内，而不是全局
   - 地图弹窗中"解析地址"按钮与"取消"按钮并排显示
2. **地图搜索功能**：用户要求在地图上加入搜索功能，避免拖动找地方
   - 支持输入地名快速跳转
   - 支持中英文地点搜索
   - 使用 MapTiler Geocoding API
   - 搜索框位于地图上方
3. **港澳台地址翻译修复**：用户反馈地址显示不正确
   - 香港、澳门、台湾地址显示为英中混合（如"Hong Kong Hong Kong"、"香港 Hong Kong"）
   - 需要清理中英文混合文本，优先提取中文
   - 确保所有地址都正确显示为纯中文
4. **单张上传缺少"解析地址"按钮**：用户发现单张上传表单中缺少"解析地址"按钮
   - 需要为单张上传、批量上传、编辑表单都添加"解析地址"按钮
   - 按钮应始终显示，方便用户手动触发解析

### 用户决策（2025-10-29讨论结果）
1. ✅ **location_name 字段可以删掉** - M-9 需规划字段退役方案（数据库schema调整、历史数据迁移）
2. ✅ **批量补录工具放管理后台** - 多选图片后批量标点，M-8需设计批量选择与选点流程
3. ✅ **优先补充以下国家城市翻译**：泰国、菲律宾、新加坡、日本、澳大利亚、韩国 - M-7明确优先列表
4. ✅ **需要自动化回归测试** - QA-1需扩展测试范围（Mocha/Jest 或类似框架）

## 2. 任务拆解

| 编号 | 模块 | 任务摘要 | 负责人 | 目标状态 | 备注 |
| --- | --- | --- | --- | --- | --- |
| M-6 | 地图·预览 | 预览页迷你地图（点击地点后动态加载、zoom=12、使用已存坐标落点） | AI助手 | ⏳ 待开始 | 参考 `docs/work-plans/2025-10-28/完整方案-地图中文地址增强.md` |
| M-7 | 地图·译名 | 扩展城市/国家中文映射，补充 MapTiler → 中文兜底策略 | AI助手 | ⏳ 待开始 | **优先国家**：泰国、菲律宾、新加坡、日本、澳大利亚、韩国。结合 `docs/knowledge-base/best-practices/地图中文地点增强最佳实践-2025-10-28.md` |
| M-8 | 地图·批量 | 设计并实现未标点照片批量选点补录工具 | AI助手 | ⏳ 待开始 | **用户决策：放管理后台，多选图片后统一标点** - 需实现批量选择UI、MapPicker集成、批量保存逻辑 |
| M-9 | 地图·数据模型 | 明确 `location_name` 退役方案，校验后端/前端/数据库字段一致性 | AI助手 | ⏳ 待开始 | **用户决策：location_name字段可删掉** - 需规划数据库schema调整、历史数据迁移策略、前端表单移除 |
| QA-1 | 地图·回归 | 补录 10-28 遗留的浏览器验证（OSM 栅格、MapTiler PNG、缩放上限 15x） | AI助手 | ⏳ 待验证 | 完成后在 2025-10-28 summary 勾选对应清单 |

## 3. 验收清单
- [ ] M-6：预览迷你地图仅在用户点击地点字段后渲染，默认 `zoom=12`，展示地址文本与坐标落点，关闭后释放监听。
- [ ] M-6：迷你地图复用 MapPicker 的底图配置，支持按需销毁，避免主地图资源被抢占。
- [ ] M-7：MapTiler 解析结果在**泰国、菲律宾、新加坡、日本、澳大利亚、韩国**等场景均输出中文字段；若返回英文则命中本地映射或备选服务，并在最佳实践文档更新策略。
- [ ] M-8：批量补录流程覆盖批量上传与历史照片补录，抽象可复用的批量选点交互，并写入工作流文档。
- [ ] M-9：**删除 location_name 字段**（前端PhotoPreview已使用country/province/city/district/township拼接显示，上传/编辑表单已移除location_name输入），后端接口、数据库 schema 与前端表单统一采用五级地址字段 + 坐标；历史数据迁移策略明确（建议：先备份→清理→验证）。
- [ ] QA-1：**浏览器验证** - 测试 MapTiler 矢量（PBF）和栅格（PNG）都正常显示、OSM 栅格无 CORS、三地图源缩放上限均为 15 级；**自动化回归测试** - 添加 Mocha/Jest 测试套件，覆盖核心地图功能。

## 4. 遗留事项
- 底图中文化与标注聚合暂缓，待核心地图地址链路稳定后再排期。
- 需求池需新增 `location_name` 退役及批量补录相关任务编号，后续在 CMT-20251029-002 记录。
- `docs/specifications/需求文档-统一版.md` 中“地点字段统一化”章节需补充验收标准与接口清单。
- 关注 MapTiler/OSM 瓦片配额及速率限制，必要时准备 Geomaply 或代理方案。

## 5. M-8 批量选点交互设计（讨论结果）

### 两种场景的交互逻辑

**场景A：批量修改历史照片（管理后台）**
- 交互：多选照片 → 点击"修改定位"按钮 → **统一坐标选点**
- 应用：选中10张 → 一次选点 → 10张照片都更新为相同坐标
- 适用：同一地点拍摄的不同照片需要批量修正定位

**场景B：批量上传新照片（一卷在不同地点拍摄）**
- 交互：上传一卷36张 → 逐张照片独立选点
- 应用：第1-5张在日本东京 → 第6-10张在沖縄 → 第11-20张在京都...每张单独选点
- 适用：一卷胶卷在不同城市/景点拍摄的情况
- 批量上传表单：每张照片需要单独点击"选择位置"→ 独立打开MapPicker

**设计要点**：
1. 批量修改功能：多选 → 统一坐标（M-8实现）
2. 批量上传功能：每张照片独立选点（当前已支持，不需要改动）
3. 两者复用 MapPicker 组件，但调用方式不同

## 6. 提交记录

### CMT-20251029-001：UI优化与交互改进 ✅ 待审计
**关联任务**：M-5（上传联动）后续优化

**完成内容**：
- ✅ UI布局优化：批量上传布局更紧凑，照片缩略图缩小到100px
- ✅ 地图搜索功能：支持中英文地点搜索，自动跳转到目标位置
- ✅ 港澳台地址翻译修复：实现 `cleanBilingualText` 函数，所有地址正确显示为纯中文
- ✅ 交互优化：修复嵌套 form 错误，优化地图弹窗布局
- ✅ 所有上传/编辑表单都添加"解析地址"按钮

**修改文件**：
- `frontend/src/views/PhotoManagement.jsx`
- `frontend/src/components/MapPicker.jsx`
- `frontend/src/components/ImageRotateControl.jsx`
- `backend/routes/geocode.js`
- `backend/routes/geocode-translations.js`

**审计状态**：✅ Codex 第二轮审计通过（2025-10-29）

### CMT-20251029-002：M-6预览小地图与城市翻译扩展 ⏳ 待开始
**关联任务**：M-6、M-7

**计划内容**：
- ⏳ M-6：预览页迷你地图（点击地点字段弹窗显示，zoom=12）
- ⏳ M-7：扩展城市中文译名映射表（日本、泰国、菲律宾、新加坡、韩国）
- ⏳ 后续可能的：M-8（批量补录）、M-9（location_name 退役）

**状态**：等待 CMT-20251029-001 审计通过后开始

## 7. 当日工作安排

### 已完成（CMT-20251029-001）
1. ✅ UI优化：批量上传布局更紧凑
2. ✅ 地图搜索功能实现
3. ✅ 港澳台地址翻译修复
4. ✅ 交互优化：修复嵌套 form 错误

### 待完成（等待审计通过后）
1. ⏳ M-6：实现预览页迷你地图
2. ⏳ M-7：扩展城市中文译名映射
3. ⏳ 后续任务：M-8、M-9（根据优先级）

### 待审计验证
- ⏳ Codex 审计 CMT-20251029-001
- ⏳ 浏览器测试地图搜索功能
- ⏳ 验证港澳台地址翻译正确性

## 6. 参考资料
- `docs/work-plans/2025-10-28/summary.md`
- `docs/work-plans/2025-10-28/完整方案-地图中文地址增强.md`
- `docs/knowledge-base/best-practices/地图中文地点增强最佳实践-2025-10-28.md`
- `docs/specifications/需求文档-统一版.md`
