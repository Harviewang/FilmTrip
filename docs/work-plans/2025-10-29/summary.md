# 2025-10-29 工作计划

## 1. 用户原始需求与决策
- **地图选点解析**：上传/编辑仅支持通过地图选点或直接坐标选点，自动解析并保存 `country/province/city/district/township + latitude/longitude`，作为人类可读与地图绘制的唯一数据源。
- **预览小地图**：照片预览页在用户点击地点字段后按需加载迷你地图（默认 `zoom=12`），基于已存坐标落点，避免初始渲染带来的性能开销。
- **地图总览标点**：`/map` 页面进入后一次性根据存储坐标绘制全部标记；列表页保持无小地图，必要时可进入单条预览补充查看。
- **批量补录能力**：支持未标点的历史作品在**管理后台**批量选点补录五级中文地址与坐标；**多选图片后统一标点**。
- **地址解析策略**：沿用 MapTiler 反向地理编码，预留 Geomaply 作为备选，**优先扩展以下国家城市中文映射：泰国、菲律宾、新加坡、日本、澳大利亚、韩国**；底图中文化优先级较低，暂列为后续需求。

### 2025-10-29 上午临时变更需求
1. **批量上传布局优化**：用户反馈布局太繁琐、高度占用太多
   - 照片缩略图缩小（200px → 100px）
   - 旋转按钮只显示图标，移除文字
   - 标签和隐私保护移至每个照片项内，而不是全局
   - 地图弹窗中"解析地址"按钮与"取消"按钮并排显示
2. **地图搜索功能**：用户要求在地图上加入搜索功能，避免拖动找地方
   - 支持输入地名快速跳转
   - 支持中英文地点搜索
   - 使用 MapTiler Geocoding API
   - 搜索框位于地图上方
3. **港澳台地址翻译修复**：用户反馈地址显示不正确
   - 香港、澳门、台湾地址显示为英中混合（如"Hong Kong Hong Kong"、"香港 Hong Kong"）
   - 需要清理中英文混合文本，优先提取中文
   - 确保所有地址都正确显示为纯中文
4. **单张上传缺少"解析地址"按钮**：用户发现单张上传表单中缺少"解析地址"按钮
   - 需要为单张上传、批量上传、编辑表单都添加"解析地址"按钮
   - 按钮应始终显示，方便用户手动触发解析

### 用户决策（2025-10-29讨论结果）
1. ✅ **location_name 字段可以删掉** - M-9 需规划字段退役方案（数据库schema调整、历史数据迁移）
2. ✅ **批量补录工具放管理后台** - 多选图片后批量标点，M-8需设计批量选择与选点流程
3. ✅ **优先补充以下国家城市翻译**：泰国、菲律宾、新加坡、日本、澳大利亚、韩国 - M-7明确优先列表
4. ✅ **需要自动化回归测试** - QA-1需扩展测试范围（Mocha/Jest 或类似框架）

## 2. 任务拆解

| 编号 | 模块 | 任务摘要 | 负责人 | 目标状态 | 备注 |
| --- | --- | --- | --- | --- | --- |
| M-6 | 地图·预览 | 预览页迷你地图（点击地点后动态加载、zoom=12、使用已存坐标落点） | AI助手 | ✅ 已完成 | 参考 `docs/work-plans/2025-10-28/完整方案-地图中文地址增强.md` |
| M-7 | 地图·译名 | 扩展城市/国家中文映射，补充 MapTiler → 中文兜底策略 | AI助手 | ✅ 已完成 | **优先国家**：泰国、菲律宾、新加坡、日本、澳大利亚、韩国。结合 `docs/knowledge-base/best-practices/地图中文地点增强最佳实践-2025-10-28.md` |
| M-8 | 地图·批量 | 设计并实现未标点照片批量选点补录工具 | AI助手 | ⏳ 待开始 | **用户决策：放管理后台，多选图片后统一标点** - 需实现批量选择UI、MapPicker集成、批量保存逻辑 |
| M-9 | 地图·数据模型 | 明确 `location_name` 退役方案，校验后端/前端/数据库字段一致性 | AI助手 | ⏳ 待开始 | **用户决策：location_name字段可删掉** - 需规划数据库schema调整、历史数据迁移策略、前端表单移除 |
| QA-1 | 地图·回归 | 补录 10-28 遗留的浏览器验证（OSM 栅格、MapTiler PNG、缩放上限 15x） | AI助手 | ⏳ 待验证 | 完成后在 2025-10-28 summary 勾选对应清单 |

## 3. 验收清单
- [x] M-6：预览迷你地图仅在用户点击地点字段后渲染，默认 `zoom=12`，展示地址文本与坐标落点，关闭后释放监听。
- [x] M-6：迷你地图复用 MapPicker 的底图配置，支持按需销毁，避免主地图资源被抢占。
- [x] M-7：MapTiler 解析结果在**泰国、菲律宾、新加坡、日本、澳大利亚、韩国**等场景均输出中文字段；若返回英文则命中本地映射或备选服务，并在最佳实践文档更新策略。
- [ ] M-8：批量补录流程覆盖批量上传与历史照片补录，抽象可复用的批量选点交互，并写入工作流文档。
- [ ] M-9：**删除 location_name 字段**（前端PhotoPreview已使用country/province/city/district/township拼接显示，上传/编辑表单已移除location_name输入），后端接口、数据库 schema 与前端表单统一采用五级地址字段 + 坐标；历史数据迁移策略明确（建议：先备份→清理→验证）。
- [ ] QA-1：**浏览器验证** - 测试 MapTiler 矢量（PBF）和栅格（PNG）都正常显示、OSM 栅格无 CORS、三地图源缩放上限均为 15 级；**自动化回归测试** - 添加 Mocha/Jest 测试套件，覆盖核心地图功能。

## 4. 遗留事项
- 底图中文化与标注聚合暂缓，待核心地图地址链路稳定后再排期。
- 需求池需新增 `location_name` 退役及批量补录相关任务编号，后续在 CMT-20251029-002 记录。
- `docs/specifications/需求文档-统一版.md` 中“地点字段统一化”章节需补充验收标准与接口清单。
- 关注 MapTiler/OSM 瓦片配额及速率限制，必要时准备 Geomaply 或代理方案。

## 5. M-8 批量选点交互设计（讨论结果）

### 两种场景的交互逻辑

**场景A：批量修改历史照片（管理后台）**
- 交互：多选照片 → 点击"修改定位"按钮 → **统一坐标选点**
- 应用：选中10张 → 一次选点 → 10张照片都更新为相同坐标
- 适用：同一地点拍摄的不同照片需要批量修正定位

**场景B：批量上传新照片（一卷在不同地点拍摄）**
- 交互：上传一卷36张 → 逐张照片独立选点
- 应用：第1-5张在日本东京 → 第6-10张在沖縄 → 第11-20张在京都...每张单独选点
- 适用：一卷胶卷在不同城市/景点拍摄的情况
- 批量上传表单：每张照片需要单独点击"选择位置"→ 独立打开MapPicker

**设计要点**：
1. 批量修改功能：多选 → 统一坐标（M-8实现）
2. 批量上传功能：每张照片独立选点（当前已支持，不需要改动）
3. 两者复用 MapPicker 组件，但调用方式不同

## 6. 提交记录

### CMT-20251029-001：UI优化与交互改进 ✅ 待审计
**关联任务**：M-5（上传联动）后续优化

**完成内容**：
- ✅ UI布局优化：批量上传布局更紧凑，照片缩略图缩小到100px
- ✅ 地图搜索功能：支持中英文地点搜索，自动跳转到目标位置
- ✅ 港澳台地址翻译修复：实现 `cleanBilingualText` 函数，所有地址正确显示为纯中文
- ✅ 交互优化：修复嵌套 form 错误，优化地图弹窗布局
- ✅ 所有上传/编辑表单都添加"解析地址"按钮

**修改文件**：
- `frontend/src/views/PhotoManagement.jsx`
- `frontend/src/components/MapPicker.jsx`
- `frontend/src/components/ImageRotateControl.jsx`
- `backend/routes/geocode.js`
- `backend/routes/geocode-translations.js`

**审计状态**：✅ Codex 第二轮审计通过（2025-10-29）

### CMT-20251029-002：M-6预览小地图与城市翻译扩展 ✅ 已完成
**关联任务**：M-6、M-7

**完成内容**：
- ✅ M-6：预览页迷你地图（点击地点字段弹窗显示，zoom=12，只读模式，资源自动释放）
  - 实现点击地点字段弹出迷你地图
  - 使用MapPicker组件，readOnly模式，initialZoom=12
  - 支持点击遮罩层关闭，自动资源释放
  - 无坐标时显示关塔那摩坐标提示
- ✅ M-7：扩展城市中文译名映射表
  - 日本：30+城市/地区（东京、新宿、涩谷、原宿等）
  - 泰国：60+城市/景点（曼谷、苏梅岛、皮皮岛、大皇宫等）
  - 菲律宾：50+城市/景点（马尼拉、长滩岛、巴纳韦梯田等）
  - 新加坡：70+地区/景点（滨海湾、圣淘沙、鱼尾狮公园等）
  - 韩国：20+城市/区域（首尔、江南、明洞、弘大等）
  - 澳大利亚：80+城市/景点（悉尼、大堡礁、乌鲁鲁等）
  - 越南：20+城市/景点（胡志明市、河内、下龙湾等）
  - 马来西亚：20+城市/景点（吉隆坡、槟城、兰卡威等）
  - 印度尼西亚：30+城市/景点（雅加达、巴厘岛、四王群岛等）
  - 统一使用normalizeCityName函数，支持模糊匹配

**修改文件**：
- `frontend/src/components/PhotoPreview.jsx` - 迷你地图实现
- `frontend/src/components/MapPicker.jsx` - 支持initialZoom参数
- `backend/routes/geocode-translations.js` - 城市翻译映射表
- `backend/routes/geocode.js` - 添加国家代码处理

**状态**：✅ 已完成（2025-10-29）

**Git提交**：
- `7b4a23d`: M-7 扩展城市中文译名映射
- `b23eaff`: M-6 完善预览页迷你地图功能
- `145cf61`: 更新工作计划文档
- `95ec3e5`: 扩展越南/马来西亚/印度尼西亚城市翻译，移除Shift+R缓存快捷键
- `77036a9`: 大幅扩展泰国/菲律宾/新加坡/澳大利亚城市翻译映射
- `c75e78a`: 修复St. Andrew's Cathedral的引号转义问题

### CMT-20251029-003：地图标记优化与预览修复 ✅ 已完成
**关联任务**：地图UI优化、预览功能修复、权限过滤

**完成内容**：
- ✅ 地图标记样式统一为小圆点（MapLibre和MapPicker）
- ✅ 修复地图标记点击事件无法触发的问题
- ✅ 移除点击标记时的自动flyTo操作（避免干扰预览）
- ✅ 修复照片预览无法打开的问题（数据映射缺失）
- ✅ 修复加密照片预览逻辑（移除错误提示）
- ✅ 修复地图标记权限过滤（只显示可查看的照片）

**修改文件**：
- `frontend/src/pages/Map/MapLibre.jsx`
- `frontend/src/components/MapPicker.jsx`
- `frontend/src/pages/Map/Map.css`
- `frontend/src/components/PhotoPreview.jsx`
- `frontend/src/pages/Gallery/index.jsx`

**关键修复**：
1. **地图标记点击无反应**：移除过于严格的图片路径检查，恢复预览功能
2. **权限过滤**：地图只显示用户有权限查看的照片标记
   - 未登录用户：只显示不受保护的照片
   - 登录管理员：显示所有照片
   - 普通登录用户：只显示不受保护的照片

**当前问题**：
1. 加密照片在没有认证的情况下无法获取图片路径（这是后端安全策略，符合预期）
2. 地图加载大量标记时可能需要性能优化
3. 可以考虑移除调试日志（commit dbca48d）

**状态**：✅ 已完成，✅ Codex 审计通过（2025-10-29）

**详细文档**：`docs/work-plans/2025-10-29/commits/CMT-20251029-003.md`

### CMT-20251029-004：M-9与QA-1规划 + 地图Modal修复 ✅ 部分完成
**关联任务**：M-9、QA-1、地图Modal修复

**完成内容**：
- ✅ 创建M-9和QA-1的详细规划文档
- ✅ 修复Modal中地图加载不出来的问题
- ✅ 更新所有相关文档，确保文档与代码状态一致

**修改文件**：
- `docs/work-plans/2025-10-29/commits/CMT-20251029-004.md` - M-9和QA-1规划
- `frontend/src/components/MapPicker.jsx` - Modal地图加载修复

**Git提交**：
- `a66fbbf`: fix: 修复Modal中地图加载不出来的问题

**状态**：✅ 部分完成（2025-10-29）
- M-9和QA-1的代码实现待后续完成
- 地图Modal修复已完成并测试通过

**详细文档**：`docs/work-plans/2025-10-29/commits/CMT-20251029-004.md`

**审计结论**：
- ✅ 分页循环请求已实现，地图显示全部可见照片
- ✅ 标记点击事件已修复，预览弹窗正常工作
- ✅ 权限过滤通过图片路径字段保障
- ✅ 文档与代码实现一致

## 7. 当日工作安排

### 已完成（CMT-20251029-001）
1. ✅ UI优化：批量上传布局更紧凑
2. ✅ 地图搜索功能实现
3. ✅ 港澳台地址翻译修复
4. ✅ 交互优化：修复嵌套 form 错误

### 已完成（CMT-20251029-002）
1. ✅ M-6：实现预览页迷你地图（已完成，默认zoom=12，只读模式，资源自动释放）
2. ✅ M-7：扩展城市中文译名映射（已完成：9个国家/地区，总计400+城市/景点映射）

### 待完成（今日计划）
3. ⏳ M-9：location_name字段退役（清理前后端引用、数据库schema、迁移脚本）- 部分完成（文档已更新）
4. ⏳ QA-1：浏览器验证与自动化测试（地图功能回归测试）- 部分完成（文档已更新）
5. ⏳ M-8：批量选点补录工具（用户要求暂缓，后续再处理）

### 今日修复（额外完成）
6. ✅ 修复Modal中地图加载不出来的问题（a66fbbf）
   - 问题：批量上传弹窗中地图首次加载空白，需要刷新才能显示
   - 原因：Modal打开时容器尺寸为0，MapLibre需要容器有实际尺寸才能渲染
   - 修复：添加容器尺寸检查、延迟初始化、加载后调用resize()、ResizeObserver监听

### 待审计验证
- ⏳ Codex 审计 CMT-20251029-001
- ⏳ 浏览器测试地图搜索功能
- ⏳ 验证港澳台地址翻译正确性

## 6. 参考资料
- `docs/work-plans/2025-10-28/summary.md`
- `docs/work-plans/2025-10-28/完整方案-地图中文地址增强.md`
- `docs/knowledge-base/best-practices/地图中文地点增强最佳实践-2025-10-28.md`
- `docs/specifications/需求文档-统一版.md`
