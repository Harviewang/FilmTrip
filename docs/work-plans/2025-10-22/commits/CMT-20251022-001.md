# 提交 CMT-20251022-001
> PR/Commit：待补；记录日期：2025-10-22

## 1. 关联任务
- B-1：Gallery 随机按钮
- B-2：随机照片 API

## 2. 用户意见 / 背景
- 将随机浏览整合到 `/gallery` 现有视图切换中。
- 随机结果中不能包含受保护（加密）照片。

## 3. 开发总结
### 3.1 前端改动
- 在 `frontend/src/pages/Gallery/index.jsx` 中新增 🎲 按钮，保持平铺/瀑布流 icon 不变。
- `setViewMode('random')` 进入随机模式，渲染单张作品，并加入加载提示。
- 随机结果沿用现有预览组件，受保护照片显示遮罩。

### 3.2 后端改动
- 实现 `photoController.getRandomPhotos`：
  - 左连接胶卷/胶片表，附带相机、品牌等信息。
  - 过滤 `(p.is_protected = 0 OR NULL)` 与 `(fr.is_protected = 0 OR NULL)`，确保普通用户不会获取受保护图片。
  - 统一路由为 `/api/photos/random?count=1`。
- 恢复 `uploadPhoto` 响应结构 `{ success, message, data }`，移除无效 `processedPhotos` 引用。

### 3.3 自测
- `curl http://localhost:3001/api/photos/random` 多次调用，返回未受保护的随机记录。
- 本地启动前端，切换随机按钮验证 UI；管理员 token 模式下可查看原图，普通用户仅见遮罩。

## 4. 审计记录
| 时间 | 审计人 | 结果 | 说明 |
| --- | --- | --- | --- |
| 2025-10-22 09:45 | Codex | ❌ 未通过 | `uploadPhoto` 返回空对象；`getRandomPhotos` 未实现；路由注册为 `/get-random` 与前端不符。 |
| 2025-10-22 11:05 | Codex | ✅ 通过 | 响应恢复，随机 API 生效，过滤逻辑正确。 |

## 5. 修订历史
1. **2025-10-22 10:15（Windsurf）**：恢复上传返回体，删除无效 `processedPhotos`。
2. **2025-10-22 10:45（Windsurf）**：补充 `getRandomPhotos` 实现，计算保护状态、读取 EXIF。
3. **2025-10-22 10:55（Windsurf）**：调整路由顺序，增加 UUID 校验，避免 `/random` 被 `/:id` 截获。

## 6. 验收
- 2025-10-22 11:05：Codex 复审通过；summary 验收清单中 B-1、B-2 已勾选。

## 7. Git 提交
- `cbf7dc9`: fix: 恢复完整的加密照片显示逻辑 (B-1/B-2功能修复)
- `f27891c`: docs: 创建 2025-10-22 工作日志 (文档记录)

---

> 注：如后续对该提交进行追加修改，请在本文件追加新的"修订历史"与"Git 提交"条目，并更新审计记录。
