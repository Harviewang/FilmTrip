# 提交 CMT-20251022-003 （待实施）
> 记录日期：2025-10-22  
> 说明：聚合今日剩余的高优先级任务（A-1、B-3、C-1/2/3），在 CMT-20251022-002 验收通过后继续推进。完成并经 Codex 验收后方可提交 git 记录。

## 1. 关联任务
- A-1：导航路由改造（地点文案、`/trip` 入口、`/random` 重定向）
- B-3：Gallery 随机多图与界面整理
- C-1：数据库保护字段迁移（`is_protected`、`protection_level`）
- C-2：加密/保护 API 改造（上传、批量、查询、随机接口）
- C-3：前端保护显示与上传流程（遮罩、权限提示、管理员透传）

## 2. 用户意见 / 背景
- `/gallery` 应提供平铺 / 瀑布流 / 随机三种模式，随机模式需要一次返回多张作品，避免当前“随机 → 单卡片 → 再进预览”的多层操作（参考需求池：docs/需求文档-统一版.md 第 189、214 行）。
- 随机视图布局期望继承画廊 Header，与其他视图一致；可参考 camarts.cn 的随机瀑布体验。
- 保护机制需完整落地：数据库字段、后端过滤逻辑、前端遮罩与权限区分，避免受保护照片进入随机列表或被普通用户直接访问。
- 导航文案需统一（地点/旅程/随机）并遵循 `/trip` 域名策略。

## 3. 开发计划
### 3.1 A-1 导航路由
- 更新前端路由与导航菜单：`旅途` → `地点`，`/trip` 新入口（暂为建设中占位组件）。
- `/gallery` 中集成随机图标，去除单独的 `/random` 页面并加重定向 `/random -> /gallery?mode=random`。
- 管理后台导航栏统一：与前台风格保持一致，从左到右包含 logo、管理后台字样、返回首页按钮、欢迎字样、退出登录；左侧菜单保持不变。
- 校对顶部 Header / icon 与后端路由别名，补充单元自测（含刷新、深链）。

### 3.2 B-3 Gallery 随机多图
- 后端：`GET /api/photos/random` 默认 `count=6`，支持参数覆盖；过滤 `effective_protection` 为 true 的记录；返回结构保持一致。
- 前端：随机模式展示 6 张卡片，使用黑底胶卷样式（上下有齿轮格），从右往左推入动画效果；点击任意图片进入标准预览模式。
- UI 设计：类似 5-6 个框的胶卷条布局，保持 Gallery Header 统一性；提供"换一组"按钮重新随机。
- 交互：随机加载完成后，用户可点击"换一组"获取新的 6 张照片，无需返回上级页面。

### 3.3 C-1/C-2 数据库与 API
- 数据库迁移脚本：在 `photos`、`film_rolls` 新增 `is_protected`（BOOLEAN 默认 false）、`protection_level`（TEXT，可选枚举），并迁移旧 `is_encrypted` 数据。
- 后端服务：
  - 上传/批量上传：接受 `is_protected`、`protection_level`，管理员可设置。
  - 查询：返回 `effective_protection`（照片或胶卷任一标记即 true），普通用户的受保护照片 `original` URL 置空，但保留基础信息。
  - 随机/列表接口：默认过滤 `effective_protection === true` 的记录，仅管理员带 `role=admin` 时可查询完整信息。
- 自测：编写最小脚本或 Postman 集合验证上传→查询→随机流程。

### 3.4 C-3 前端保护体验
- 上传/编辑表单：新增保护开关与类型选择（肖像/敏感信息/其他），普通用户隐藏。
- 列表/预览：受保护照片展示遮罩与提示语；管理员维持原图可见，同时标记保护类型。
- 随机模式：确保展示列表中不含受保护照片，UI 显示提示“随机模式仅展示公开作品”。
- 测试：管理员/普通用户账号分别验证展示差异。

## 4. 依赖与风险
- 需确保数据库迁移与后端重启时机一致，避免上线时出现字段缺失（建议先跑迁移，再部署代码变更）。
- 新增前端状态需同步 `docs/需求文档-统一版.md` 与部署指引，避免使用旧字段 `is_encrypted`。
- 随机多图布局需兼容移动端（可先做基础响应式，再记录 TODO）。

## 5. 验收要求
1. `/gallery` 三种模式入口清晰，`/random` 访问自动跳转且无 404。
2. 随机模式默认返回 6 张公开作品，可点击“换一组”。
3. 数据库新增字段可见，旧数据迁移成功（DB 检查 + API 断言）。
4. 普通用户无法通过任何接口访问受保护原图，管理员可完整访问。
5. 前端上传/预览 UI 展示保护开关、类型、遮罩，体验一致。
6. 自测记录（命令或截图）附于提交描述或 QA 附件。

## 6. 自测结果
### A-1 导航路由改造
- ✅ 前端路由：`/trip` 页面正常显示建设中占位组件
- ✅ 导航菜单：前台"旅途"改为"地点"，文案统一
- ✅ 重定向：`/random` 访问自动跳转到 `/gallery?mode=random`
- ✅ 管理后台：导航栏添加logo、"管理后台"字样、返回首页按钮，左侧菜单保持不变
- ✅ 深链测试：直接访问 `/random`、`/`、`trip` 路由正常工作
- ✅ 响应式：移动端菜单功能正常，管理后台移动端适配保持一致
- ✅ 构建修复：补回缺失的import语句，前端应用正常启动
- ✅ 前端验证：localhost:3002正常响应，路由重定向和页面访问都正常
- ✅ 浏览器测试：页面正常加载，无JavaScript错误，导航菜单显示正确（"地点"而非"旅途"）

## 7. 验收流程
- Windsurf 完成开发 → 自测记录整理 → 更新本文件“自测结果”小节
- Codex 复核代码与自测证据 → 更新“审计记录”“验收”状态 → 通知可提交 Git

## 8. 后续文档同步
- `docs/需求文档-统一版.md`：更新随机模式、保护机制描述。
- `docs/项目文件整理指南.md` / `docs/work-plans/2025-10-22/summary.md`：同步任务状态。
- README / 部署指南：补充新环境变量与迁移说明（如需）。
