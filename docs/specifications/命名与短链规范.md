# FilmTrip 命名与短链规范（v1.4）

**最后更新**：2025-11-06  
**维护者**：产品团队 & AI 助手  
**关联讨论**：`docs/archive/临时文档/filmtrip-naming-v1.4.md`

---

## 1. 适用范围

本规范约束 FilmTrip 项目中 **胶卷品类（Film Stock）→ 胶卷实例（Film Roll）→ 照片（Photo）** 三层实体在以下方面的统一策略：

- 数据库主键与业务编号  
- Short Code 短链生成与解析  
- URL/分享链接路由规划  
- 文件命名与对象存储目录结构  
- 去重、版本管理与权限策略

规范设计目标：

1. **语义清晰**：业务编号可读、短链易记。  
2. **全局唯一**：不同层级均具备唯一短码，避免冲突。  
3. **分享友好**：统一短链入口，便于外部传播。  
4. **可扩展性**：支持数百万级文件存储与热点缓存。  
5. **安全可控**：原始文件与对外版本解耦，便于权限管理。

---

## 2. 层级与字段定义

| 层级 | 主键 | 业务编号（code） | 短码（short，Base62） | 是否人工命名 | 唯一性 | 说明 |
|------|------|------------------|------------------------|--------------|--------|------|
| **Film（胶卷品类）** | `id`（自增） | ✅ 例如 `KD-G200-135` | ✅ 2 位（例 `aZ`） | 自动生成 | 值唯一 | 品牌+系列+ISO+画幅 |
| **Roll（胶卷实例）** | `id`（自增） | ❌ | ✅ 3 位（例 `vn6`） | 自动生成 | 值唯一 | 具体一卷胶卷 |
| **Frame（照片）** | `uuid` | ❌ | ✅ 5 位（例 `aZ3kQ`） | 自动生成 | 值唯一 | 对应单张照片文件 |

> Base62 字符集为 `0-9 a-z A-Z`，短码不回收、不复用，保证历史链接永久有效。

---

## 3. 业务编号规则

### 3.1 Film 编号（code）

```
{BRAND2}-{SER1}{ISO}-{FORMAT}
```

- `BRAND2`：品牌首字母缩写（Kodak → `KD`、Fujifilm → `FJ`、Ilford → `IL` 等）。  
- `SER1`：系列首字母（Gold → `G`、Portra → `P`、HP5 → `H`）。  
- `ISO`：感光度，如 `200`、`400`。  
- `FORMAT`：画幅（135 / 120 / 220 / 4x5 / APS 等）。

示例：`KD-G200-135` → Kodak Gold 200, 135 胶卷。

### 3.2 Roll 与 Frame

- 不额外声明业务编号，统一依赖短码与主键。
- 若需要人工备注，可提供 `display_name` 字段，仅用于描述，不参与唯一性。

---

## 4. 短链与路由策略

### 4.1 统一入口

FilmTrip 的所有短链均挂载在站点根路径，根据短码长度区分层级：

| 层级 | 短码长度 | 示例短链 | 打开内容 |
|------|-----------|----------|-----------|
| Film | 2 | `/aZ` | 胶卷品类详情页 |
| Roll | 3 | `/vn6` | 该卷胶卷页面 |
| Frame | 5 | `/aZ3kQ` | 照片预览浮层 |

### 4.2 匹配与导航

1. 先匹配保留路径（`/gallery`、`/map`、`/film-rolls`、`/api/*` 等）。  
2. 其余根路径按长度进入短链解析逻辑。  
3. 各模块在进入预览模式时统一 `pushState('/{short}')`，关闭时 `popState()` 恢复原列表页。  
4. 分享按钮默认复制短链 URL；旧式 `?photo=uuid` 链接需跳转至短链。

---

## 5. 文件命名与存储

### 5.1 文件命名

- 原始文件命名：`{uuid}.{ext}`（例：`ff80c9e6-5c3e-4bdc-a0c1-c47e2a04b0bd.jpg`）。  
- 不在文件名中重复嵌入拍摄时间、标题等信息，保持唯一性与不可变性。

### 5.2 对象存储分桶

```
/storage/frames/{uu}/{id}/{prefix}/{uuid}.jpg
         ↳ 取 uuid 的前 3 组 hex 前缀分层（如 ff/80/c9）
```

- 三层目录共 16,777,216 个桶，适配百万级文件。  
- 其他版本（RAW / WEB / THUMB）按同样规则分别存放于 `/storage/raw/…`、`/storage/web/…` 等目录。
- 三层目录共 16,777,216 个桶，适配百万级文件。  
- 其他版本（RAW / WEB / THUMB）按同样规则分别存放于 `/storage/raw/…`、`/storage/web/…` 等目录。

> **上传链路原则**：后端服务只负责生成 UUID/短码、校验哈希、签发临时上传凭证并在回调时入库，不在任何环境本地落地图片文件；前端凭凭证直接将原图及各派生版本上传至对象存储（如 UpYun），并在 CDN 层完成格式转换、水印等增值能力。

### 5.3 版本管理

| 路径 | 用途 | 权限 |
|------|------|------|
| `/storage/raw/{uuid}.tif` | 原始扫描文件 | 管理员可下载 |
| `/storage/web/{uuid}.jpg` | 标准预览 | 访客可见 |
| `/storage/thumb/{uuid}.jpg` | 列表缩略图 | 访客可见 |

数据库 `frames` 表需存储版本信息：

```sql
version ENUM('RAW','WEB','THUMB')
```

---

## 6. 去重与删除策略

- 上传前计算文件 SHA256 / MD5，后端校验 `file_hash` 唯一索引。  
- 如果文件存在，复用原 `uuid` 与短码，避免重复占用存储与短链。  
- 建议字段：

```sql
file_hash CHAR(64) UNIQUE,
deleted_at DATETIME NULL
```

- 删除采用逻辑删除（`deleted_at`），保留短链与历史引用。重新上传同一文件时恢复原记录。

---

## 7. 原始临时文档差异说明

- 本规范整合自 `docs/archive/临时文档/filmtrip-naming-v1.4.md`，正式纳入规格文档。  
- 临时文档保留做补充资料；更新时以本文件为准。  
- 若后续命名策略有重大调整，请同步更新此文档并记录历史版本。

---

## 8. 未决 TODO

| 事项 | 说明 |
|------|------|
| URL Rewrite 支持 | 需要在前端路由层实现短链跳转逻辑，并更新分享按钮。 |
| 短链批量生成脚本 | 为历史数据生成短码。 |
| CDN/水印策略联动 | 根据 `frames` 版本信息返回对应短链或 CDN 地址。 |

---

> **提醒**：任何涉及短链、文件命名、版本管理的改动，都需要更新本规范、相关脚本和数据迁移方案，并在需求池登记确认。

