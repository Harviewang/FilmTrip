# FilmTrip 胶片摄影管理系统 - 需求文档

**版本**: v3.0 统一版  
**创建日期**: 2025-01-21  
**最后更新**: 2025-10-24  
**状态**: 核心功能已实现，持续优化中

---

## 🎯 项目概述

### 项目定位
FilmTrip是一个专业的胶片摄影管理系统，采用三层清晰结构设计，避免层级过深，保持逻辑简单。系统旨在帮助胶片摄影爱好者管理胶卷、照片、相机和扫描仪等资源。

### 核心价值
1. **简化管理流程**：一卷胶卷天然就是一个照片集合，无需额外相册概念
2. **完整信息记录**：从胶卷品类到具体照片的完整信息链
3. **专业摄影支持**：支持EXIF信息、地理位置、评分系统等专业功能
4. **灵活权限控制**：支持公开、私密、链接可见等多种可见性设置

### 目标用户
- **主要用户**：胶片摄影爱好者、专业摄影师
- **次要用户**：摄影工作室、胶片冲洗店
- **管理员**：系统管理员、内容审核员

---

## 🏗️ 核心设计理念

### 1. 三层清晰结构
- **胶卷品类 (Film Stock)** → **胶卷实例 (Film Roll)** → **照片 (Photo)**
- 避免层级过深，保持逻辑简单
- 每层职责明确，易于理解和维护

### 2. 继承关系
- 照片继承胶卷实例的所有属性
- 胶卷实例继承胶卷品类的所有属性
- 减少数据冗余，提高数据完整性

### 3. 实际业务导向
- 一卷胶卷天然就是一个照片集合
- 不需要额外的相册概念
- 符合胶片摄影的实际工作流程

---

## 🎨 核心功能

### 4大浏览模式 ✅ 已实现
1. **照片模式(/gallery)** - 画廊/瀑布流/随机三种查看模式，支持模式切换、下拉刷新和懒加载
2. **胶卷模式(/film-rolls)** - 时间轴 + 网格双列布局，包含年份/月度筛选、GitHub 风格热力图、胶片条沉浸浏览与状态切换
3. **地图模式(/map)** - 默认 MapTiler 矢量底图，17 级缩放（显示15x），统一 PhotoPreview 组件，自动聚合至街道级精度，支持智能降级方案
4. **更多功能(/more)** - 统计信息、关于页面等辅助功能

### 管理功能 ✅ 已实现
- **前台公开**：无需登录浏览
- **后台认证**：管理员登录，JWT认证
- **批量上传**：EXIF自动提取，多尺寸缩略图生成
- **系统管理**：照片管理、胶卷管理、相机管理
- **元数据管理**：支持编辑完整拍摄元数据（国家/省份/城市/地点、相机/镜头参数、曝光信息、分类标签、行程信息）

### 图片预览功能 ✅ 已实现
- **标准模式**：图片80%占比，EXIF信息浮动显示
- **沉浸模式**：图片100%占比，全屏体验
- **旋转功能**：支持连续旋转，每张图片独立状态
- **智能尺寸**：根据图片方向自动调整显示尺寸
- **胶片条预览**：在胶卷模式中以胶片条快速浏览照片，支持键盘导航与实时状态切换

---

## 🆕 近期更新（2025-10）
- **照片元数据增强系统**：新增地理信息、拍摄参数、分类标签、行程信息等字段，提供批量迁移脚本与前端实时编辑体验。
- **胶卷时间轴 2.0**：整合年份/月度筛选、无限滚动分页、GitHub 风格热力图、胶片条沉浸浏览与状态切换。
- **地图视图智能化**：默认使用 MapTiler 矢量样式，提供 3–17 级顺滑缩放（显示15x），统一的照片预览，支持自动降级方案（矢量→栅格→OSM），月初自动重置为最佳体验，移除手动切换按钮。
- **MapTiler配额管理**：实现智能配额检测和自动降级策略，月初自动恢复为矢量样式，Service Worker缓存机制（7天TTL，1000瓦片），配额限制为200次/日。
- **统计接口扩展**：新增 `/stats/activity/heatmap` 等 API，为前端热力图与仪表板提供数据基础。

---

## 🏗️ 技术架构

### 当前技术栈
- **前端**：React 18 + Vite + Tailwind CSS
- **后端**：Node.js + Express + SQLite
- **图片处理**：Sharp (EXIF处理、多尺寸生成)
- **部署**：Vercel + 自定义域名

### 数据模型
```
胶卷品类 (Film Stock) 1:N
    ↓
胶卷实例 (Film Roll) 1:N
    ↓  
照片 (Photo)
```

### 核心表结构
- **film_stocks**：胶卷品类信息（品牌、系列、类型、ISO、备注）
- **film_rolls**：胶卷实例信息（胶卷编号、拍摄时间范围、状态、所属行程、关联照片数）
- **photos**：照片信息与元数据（地理信息：country/province/city/location_name；拍摄参数：camera_model、lens_model、lens_focal_length、exposure_compensation、metering_mode、focus_mode；分类标签：categories；行程信息：trip_name、trip_start_date、trip_end_date）
- **cameras**：相机设备信息
- **scanners**：扫描仪设备信息
- **统计接口（派生数据）**：基于 photos/film_rolls 生成的活跃热度、趋势、仪表板统计数据

---

## ⚡ 性能要求

### 响应时间要求
- **首页加载**：<2秒（桌面端，100Mbps网络）
- **照片打开**：<1秒（单张图片，1MB以内）
- **模式切换**：<500ms
- **图片加载**：<3秒（包含所有资源）

### 并发性能要求
- **同时在线用户**：100人
- **并发操作**：50个并发请求
- **峰值处理**：支持200%的峰值负载

---

## 🎨 设计风格

### 设计原则
- **现代化UI**：简洁、美观、易用
- **一致性**：统一的视觉语言和交互模式
- **专业性**：符合摄影行业的专业感
- **中文优先**：完全中文化，符合国内用户习惯

### 响应式设计
- **桌面端**：1920x1080及以上分辨率优化
- **平板端**：768x1024分辨率适配
- **手机端**：375x667及以上分辨率适配
- **触摸友好**：支持触摸操作和手势

---

## 📱 前端页面结构与交互规则

### 页面架构设计
```
/ (根路径)
├── /gallery         # 照片浏览页面（画廊/瀑布流/随机三种模式）
├── /film-rolls      # 胶卷时间轴页面
├── /map             # 地图视图页面
├── /more            # 更多功能页面
└── /admin/*         # 管理后台（需要登录）
    ├── /admin/dashboard     # 仪表板
    ├── /admin/photos        # 照片管理
    ├── /admin/film-stocks   # 胶卷品类管理
    ├── /admin/film-rolls    # 胶卷实例管理
    ├── /admin/cameras       # 相机管理
    └── /admin/scanners      # 扫描仪管理

注意: 前端路径为/gallery, 后端API路径为/api/photos, 两者不要混淆
```

### 交互规则设计
- **照片展示**：点击照片显示浮层预览，不跳转页面
- **预览功能**：支持标准模式和沉浸模式切换
- **旋转功能**：每张图片独立保持旋转状态
- **返回导航**：保持用户的筛选条件和浏览位置

---

## ✅ 功能实现状态

### 已完成功能 ✅
- [x] 用户认证系统（JWT）
- [x] 照片上传和管理
- [x] 胶卷品类管理
- [x] 胶卷实例管理
- [x] 相机管理
- [x] 扫描仪管理
- [x] 照片预览功能（标准/沉浸模式）
- [x] 图片旋转功能
- [x] 照片元数据增强系统（地理信息、拍摄参数、分类标签、行程信息）
- [x] MapTiler 地图视图智能化（17 级缩放显示15x、统一预览、智能降级）
- [x] MapTiler 智能配额管理（自动降级、月初重置、Service Worker缓存）
- [x] 胶卷时间轴 2.0（年份筛选、热力图、胶片条状态管理）
- [x] 瀑布流布局
- [x] 画廊模式布局
- [x] 随机照片模式(已整合到/gallery)
- [x] Gallery三种查看模式(画廊/瀑布流/随机)
- [x] 照片旋转功能(EXIF Orientation方案)
- [x] 照片尺寸数据完整性(width/height/orientation)
- [x] 响应式设计
- [x] 云端部署

### 进行中功能 🔄
- [ ] 时间轴视图性能优化（移动端、预加载）
- [ ] 统计仪表板
- [ ] 性能优化

### 计划中功能 ⏳
- [ ] **Trip/主题入口**：新增一级导航入口，以旅程(Trip)或主题/标签为视角组织照片和胶卷，先上线入口(显示"建设中"),后续逐步完善内容聚合功能
- [ ] 社交分享功能（朋友圈/微博文案与样式）
- [ ] 智能推荐系统
- [ ] 高级筛选功能
- [ ] 数据统计分析
- [ ] 地图中文地理增强：上传/编辑地图选点→五级中文地址 + 坐标、预览页按需小地图、地图页批量打点、支持批量补录

### 需求池（待规划）

**MapTiler优化（已完成）** ✅
- [x] **智能自动降级方案**：实现矢量→栅格→OSM三级降级，配额耗尽自动降级，月初自动恢复
- [x] **配额智能检测**：监听地图加载错误，检测配额错误（403），自动触发降级流程
- [x] **月初自动重置**：每月1号自动重置为MapTiler矢量，清除降级记录，恢复最佳体验
- [x] **地图切换按钮移除**：无需手动干预，智能化管理地图方案
- [x] **缩放级别优化**：最大缩放调整为17级（显示15x），三种地图模式统一相同限制
- [x] **Service Worker缓存机制**：7天TTL缓存，最多1000个瓦片，自动清理过期缓存
- [x] **配额限制**：200次/日，配额耗尽自动降级，不中断用户体验

**体验与性能优化**
- [ ] **全局错误提示机制**：实现统一的错误提示组件，处理API错误、网络错误、业务逻辑错误等，提供用户友好的错误提示（如胶卷不存在时的明确提示）
- [ ] 静态资源 CDN 管理：统一配置图片/脚本分发与缓存策略
- [ ] 图片懒加载全面优化（含列表、胶片条、地图预览）
- [ ] 上传时支持手动/批量编辑图片元数据
- [ ] **上传弹窗响应式优化**：解决小屏设备上传弹窗溢出问题，使用max-h-[90vh]、overflow-y-auto、sticky底部按钮等方案
- [ ] **图片旋转交互优化**：确认现有旋转功能已完善，包括连续旋转、旋转后尺寸自适应、旋转状态重置等逻辑

**加密与过滤功能**
- [ ] **照片列表加密过滤功能**：在管理后台照片列表页添加加密状态过滤按钮(全部/仅加密/仅公开),方便批量管理加密照片
- [ ] **Gallery加密图片过滤开关**：在/gallery页面模式切换区域右侧添加"隐藏加密图片"开关
  - 默认状态：启用(隐藏加密图片)
  - 启用后：自动过滤所有受保护的图片(is_protected=1或effective_protection>0)
  - 关闭后：显示所有图片(加密图片显示锁图标)
  - 状态持久化：使用localStorage记住用户选择
  - 适用范围：画廊、瀑布流、随机三种模式均生效

**预览模式优化**
- [ ] **预览模式体验优化**：确认现有逻辑基本完整，包括EXIF方向处理、80%/90%比例计算、旋转功能、重置机制、沉浸模式行为等，主要需要调整比例和确认实现细节
  - ✅ **EXIF方向处理**：图片打开时默认加载正确方向（基于EXIF），上传时EXIF orientation会被处理
  - ✅ **尺寸计算逻辑**：标准模式最长边=显示区域80%，沉浸模式最长边=显示区域90%
  - ✅ **旋转功能**：可持续旋转（不限制360度），无反转动作，纯旋转
  - ✅ **重置机制**：切换图片和关闭预览后都重置（不做记忆，不修改方向）
  - ✅ **默认行为**：点开图片默认进入标准预览模式，不记忆上次沉浸模式状态
  - ✅ **沉浸模式**：沉浸模式下不显示多余按钮，退出沉浸模式有两种情况（退到标准预览/退出预览）
  - ✅ **预览模式逻辑**：沉浸和标准都是预览模式，使用一套逻辑，点击右上角退出预览模式需要复原
- [ ] **图片处理优化方案**（优先级：中，与水印功能一起实现）
  - 多尺寸图片生成：列表缩略图(300-400px，无水印)、标准预览图(1024-1440px，无水印)、沉浸式大图(2048px+，加水印)
  - 格式转换为WebP：压缩率提升30-50%，体积更小，支持现代浏览器，使用`<picture>`标签优雅降级
  - 原图保护：原图仅供管理员下载/归档，不对外展示
  - 防盗图策略：大图加水印 + 防盗链检查 + URL加密 + 禁用右键
  - 异步处理队列：避免上传时阻塞，后台异步生成各尺寸
  - 预期效果：页面加载速度↑30-50%，存储空间↓30-40%，防盗保护增强
- [ ] 图片加水印能力（批量/可选）
- [ ] 多版本水印策略：上传后生成带水印分享图与无水印缩略图，按场景选择加载
- [ ] 加密机制升级：新增独立加密字段与类型枚举（如肖像/敏感信息/其他），支持批量管理

**内容与筛选能力**
- [ ] **画幅兼容与筛选**：支持不同画幅作品的完整兼容
  - 数据结构：新增aspect_ratio字段（如1:1、3:2、4:3、16:9、135、120、4×5等）
  - 前端筛选：提供画幅筛选器，支持按画幅过滤照片
  - 显示逻辑：根据画幅优化瀑布流/画廊布局，方形、横构图、竖构图分别处理
  - 规则定义：明确各画幅的宽高比范围和显示规则
- [ ] **胶片类型显示格式规范**：管理后台`/admin/film-stocks`列表与表单中的类型名称存在中英文/格式不一致，需梳理枚举值并统一展示语言；同时排查规格字段（如135/35历史数据）并给出数据修复方案
- [ ] **底片类型兼容与筛选**：支持不同底片类型的分类管理
  - 类型定义：黑白片(B&W)、彩色负片(Color Negative)、反转片(Slide/Positive)
  - 数据字段：film_type或在film_stocks表中关联
  - 前端筛选：提供底片类型筛选器，支持按类型过滤照片和胶卷
  - 视觉区分：不同类型可使用不同的标识或配色（可选）
- [ ] **随机模式交互优化**：优化随机浏览的抽取逻辑
  - 当前方案：先随机选择一卷胶卷，从中抽取5张照片展示
  - 交互差异：移动端从上往下滑动切换，宽屏从左往右滑动切换
  - 待解决问题：如何实现真正的全局随机（跨胶卷），而非局限于单卷内随机
  - 方案探讨：是否需要两种随机模式（单卷内随机 vs 全局随机）供用户选择

**Bug修复（2025-10-23发现，2025-10-24修复）**
- [x] **后台删除照片报错**：管理后台删除照片时出现错误 → 已修复：添加handleDelete函数实现删除功能
- [x] **登录后跳转路径错误**：登录成功后跳转到`http://localhost:3002/admin/dashboard` → 已修复：改为跳转到`/admin/dashboard`
- [x] **地图页面导航文案更新**：地图页面右上角"旅程"已改为"地点" → 已实现

**内容与社交能力**
- [ ] 发布更新日志，记录每次发版内容
- [ ] 社交分享快捷入口与自定义分享样式（含 icon、文案）

- [ ] 分享图生成：导出包含留白、详情、二维码的图片
- [ ] 评论功能（照片/胶卷留言、回复、管理）
- [ ] 照片与胶卷评分体系（支持评分，显示平均分与评分人数）
- [ ] 短链接服务：为照片/胶卷生成 camarts.cn 样式的短链，例如 `https://camarts.cn/wx9`
- [ ] 故事/旅程视图：按旅程或标签聚合作品与胶卷，形成专题故事模式

**智能化能力**
- [ ] 人脸识别与人物聚合

**产品形态扩展**
- [ ] 胶卷全生命周期管理，每卷胶卷拥有独立主页
- [ ] H5 端体验适配与交互设计
- [ ] 小程序/移动端轻应用版本
- [ ] 跨多端音乐播放器，提供沉浸式观展体验（后续规划）

**系统维护与管理工具**
- [ ] **照片数据修复工具(Web界面)**：将`fix-photo-dimensions.js`脚本包装为后台管理功能
  - 检查阶段：扫描并汇报缺少width/height/orientation数据的照片数量和列表
  - 预览阶段：展示修复前后的数据对比(物理尺寸、EXIF Orientation、显示尺寸)
  - 确认阶段：用户确认后执行批量修复
  - 结果汇报：显示修复成功/失败的照片统计,支持导出日志
  - 定期检查：可设置定时任务自动检查数据完整性并发送通知
- [ ] **数据完整性检查面板**：统一的后台数据健康检查中心
  - 照片数据完整性(尺寸、方向、EXIF)
  - 文件完整性(数据库记录 vs 实际文件)
  - 关联关系完整性(胶卷-照片、相机-胶卷等)
  - 一键修复常见问题
- [ ] **服务状态页搭建**：构建对内/对外可用的状态页，展示CDN、HTTPS证书、MapTiler等第三方服务及自有接口的实时状态，便于快速排查故障

**知识与运营支持**
- [ ] 冲洗工艺管理模块（流程记录、参数追踪、成果复盘）
- [ ] 冲洗工艺速查手册（工艺知识库、常见问题及最佳实践）
- [ ] 曝光笔记与冲洗笔记模块（记录拍摄/冲洗过程，低优先级）

---

## 📊 验收标准

### 功能完整性
- 所有核心功能正常工作
- 用户界面友好易用
- 数据管理准确可靠

### 性能指标
- 响应时间满足要求
- 支持预期并发用户数
- 系统稳定运行

### 用户体验
- 用户操作流程顺畅
- 界面美观易用
- 功能满足用户需求

---

## 🚀 开发优先级

### P0 (必须) ✅ 已完成
- 4大核心浏览模式
- 后台管理认证
- 基础数据管理

### P1 (重要) 🔄 进行中
- 时间轴视图性能优化
- 性能优化
- 统计仪表板（含活跃热力图、胶卷进度统计）

### P2 (可选) ⏳ 计划中
- 社交分享功能
- 智能推荐系统
- 高级筛选功能

---

## 📝 相关文档

- **[开发日志](./开发日志.md)** - 开发过程记录和问题追踪
- **[部署指南](./部署指南.md)** - 部署与运维说明
- **[项目规范总览](./项目规范总览.md)** - 团队协作与代码规范
- **[地图照片分布展示方案](./archive/地图照片分布展示方案.md)** ⚠️ 已归档,需二次确认 - 地图交互与实现方案
- **[前端设计规范](./前端设计规范.md)** - UI 与组件规范

---

*本文档详细描述了业务需求、功能规格、界面要求等，为开发团队提供完整的指导。如有疑问或需要进一步细化，请联系项目负责人。*
