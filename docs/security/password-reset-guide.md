# Supabaseæ•°æ®åº“å¯†ç é‡ç½®æ“ä½œæŒ‡å—

**åˆ›å»ºæ—¥æœŸ**ï¼š2025-11-14  
**åŸå› **ï¼šæ•°æ®åº“å¯†ç åœ¨æ–‡æ¡£ä¸­æ³„éœ²  
**ä¼˜å…ˆçº§**ï¼šğŸ”´ P0 - ç«‹å³æ‰§è¡Œ

---

## ğŸš¨ ç«‹å³æ“ä½œæ­¥éª¤

### æ­¥éª¤1ï¼šåœ¨Supabaseæ§åˆ¶å°é‡ç½®æ•°æ®åº“å¯†ç 

1. **ç™»å½•Supabaseæ§åˆ¶å°**
   - è®¿é—®ï¼šhttps://app.supabase.com
   - ä½¿ç”¨æ‚¨çš„è´¦å·ç™»å½•

2. **é€‰æ‹©é¡¹ç›®**
   - é€‰æ‹©é¡¹ç›®ï¼ˆFilmTripï¼‰

3. **è¿›å…¥æ•°æ®åº“è®¾ç½®**
   - ç‚¹å‡»å·¦ä¾§èœå• **Settings** â†’ **Database**
   - æˆ–è®¿é—®ï¼šhttps://app.supabase.com/project/[PROJECT-ID]/settings/database

4. **é‡ç½®æ•°æ®åº“å¯†ç **
   - åœ¨ **Database Password** éƒ¨åˆ†
   - ç‚¹å‡» **Reset database password** æŒ‰é’®
   - ç”Ÿæˆæ–°å¯†ç ï¼ˆæˆ–æ‰‹åŠ¨è®¾ç½®å¼ºå¯†ç ï¼‰
   - âš ï¸ **é‡è¦**ï¼šå¤åˆ¶å¹¶ä¿å­˜æ–°å¯†ç åˆ°å®‰å…¨ä½ç½®

5. **è·å–æ–°çš„è¿æ¥å­—ç¬¦ä¸²**
   - åœ¨ **Connection string** éƒ¨åˆ†
   - é€‰æ‹© **URI** æ ‡ç­¾
   - å¤åˆ¶è¿æ¥å­—ç¬¦ä¸²
   - æ ¼å¼ï¼š`postgresql://postgres:[NEW-PASSWORD]@db.[PROJECT-ID].supabase.co:5432/postgres`
   - âš ï¸ **æ³¨æ„**ï¼šå¯†ç ä¸­çš„ `@` éœ€è¦URLç¼–ç ä¸º `%40`

---

### æ­¥éª¤2ï¼šæ›´æ–°Vercelç¯å¢ƒå˜é‡

#### 2.1 åç«¯é¡¹ç›®ç¯å¢ƒå˜é‡

1. **æ‰“å¼€Vercel Dashboard**
   - è®¿é—®ï¼šhttps://vercel.com/dashboard
   - æ‰¾åˆ°åç«¯é¡¹ç›®ï¼ˆä¾‹å¦‚ï¼š`filmtrip-backend` æˆ– `backend`ï¼‰

2. **è¿›å…¥ç¯å¢ƒå˜é‡è®¾ç½®**
   - ç‚¹å‡»é¡¹ç›®åç§°
   - ç‚¹å‡»é¡¶éƒ¨å¯¼èˆª **Settings**
   - ç‚¹å‡»å·¦ä¾§èœå• **Environment Variables**

3. **æ›´æ–° DATABASE_URL**
   - æ‰¾åˆ° `DATABASE_URL` ç¯å¢ƒå˜é‡
   - ç‚¹å‡»å³ä¾§çš„ **Edit**ï¼ˆé“…ç¬”å›¾æ ‡ï¼‰
   - å°† **Value** æ›´æ–°ä¸ºæ–°çš„è¿æ¥å­—ç¬¦ä¸²ï¼š
     ```
     postgresql://postgres:[NEW-PASSWORD]@db.[PROJECT-ID].supabase.co:5432/postgres
     ```
   - æ›¿æ¢ `[NEW-PASSWORD]` ä¸ºæ–°å¯†ç ï¼ˆURLç¼–ç åçš„ï¼‰
   - æ›¿æ¢ `[PROJECT-ID]` ä¸ºæ‚¨çš„é¡¹ç›®ID
   - ç¡®è®¤ **Environment** é€‰æ‹©ï¼š
     - âœ… Production
     - âœ… Preview
   - ç‚¹å‡» **Save**

4. **é‡æ–°éƒ¨ç½²åç«¯é¡¹ç›®**
   - ç‚¹å‡»é¡¶éƒ¨å¯¼èˆª **Deployments**
   - æ‰¾åˆ°æœ€æ–°çš„éƒ¨ç½²è®°å½•
   - ç‚¹å‡»å³ä¾§çš„ä¸‰ä¸ªç‚¹èœå• **...**
   - é€‰æ‹© **Redeploy**
   - é€‰æ‹© **Use existing Build Cache**
   - ç‚¹å‡» **Redeploy** ç¡®è®¤

#### 2.2 éªŒè¯ç¯å¢ƒå˜é‡æ›´æ–°

1. **æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—**
   - ç­‰å¾…éƒ¨ç½²å®Œæˆ
   - ç‚¹å‡»éƒ¨ç½²è®°å½•æŸ¥çœ‹ **Build Logs** æˆ– **Function Logs**
   - ç¡®è®¤æ²¡æœ‰æ•°æ®åº“è¿æ¥é”™è¯¯

2. **æµ‹è¯•APIç«¯ç‚¹**
   - è®¿é—®ï¼š`https://api.filmtrip.imhw.top/api/health`
   - å¦‚æœè¿”å›æ­£å¸¸æ•°æ®ï¼Œè¯´æ˜æ•°æ®åº“è¿æ¥æˆåŠŸ

---

### æ­¥éª¤3ï¼šæ›´æ–°æœ¬åœ°ç¯å¢ƒå˜é‡

#### 3.1 æ£€æŸ¥æœ¬åœ°.envæ–‡ä»¶

**åç«¯ç¯å¢ƒå˜é‡æ–‡ä»¶**ï¼š
- è·¯å¾„ï¼š`backend/.env`
- å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¤åˆ¶æ¨¡æ¿ï¼š
  ```bash
  cd backend
  cp env.example .env
  ```

#### 3.2 æ›´æ–°DATABASE_URL

ç¼–è¾‘ `backend/.env` æ–‡ä»¶ï¼š

```bash
# æ•°æ®åº“é…ç½®ï¼ˆSupabase PostgreSQLï¼‰
# âš ï¸ ä½¿ç”¨æ–°å¯†ç 
DATABASE_URL=postgresql://postgres:[NEW-PASSWORD]@db.[PROJECT-ID].supabase.co:5432/postgres
```

**âš ï¸ æ³¨æ„**ï¼š
- å°† `[NEW-PASSWORD]` æ›¿æ¢ä¸ºæ–°å¯†ç ï¼ˆå¯†ç ä¸­çš„ `@` éœ€è¦URLç¼–ç ä¸º `%40`ï¼‰
- å°† `[PROJECT-ID]` æ›¿æ¢ä¸ºæ‚¨çš„é¡¹ç›®ID
- ç¡®ä¿ `.env` æ–‡ä»¶åœ¨ `.gitignore` ä¸­ï¼ˆä¸ä¼šæäº¤åˆ°Gitï¼‰

#### 3.3 æµ‹è¯•æœ¬åœ°è¿æ¥

```bash
# è¿›å…¥åç«¯ç›®å½•
cd backend

# æµ‹è¯•PostgreSQLè¿æ¥
npm run test:pg

# æˆ–å¯åŠ¨åç«¯æœåŠ¡
npm start
```

---

### æ­¥éª¤4ï¼šæ£€æŸ¥Supabaseè®¿é—®æ—¥å¿—

1. **æŸ¥çœ‹æ•°æ®åº“è®¿é—®æ—¥å¿—**
   - åœ¨Supabase Dashboardï¼Œç‚¹å‡»å·¦ä¾§èœå• **Logs** â†’ **Database**
   - æŸ¥çœ‹æœ€è¿‘çš„è®¿é—®è®°å½•
   - ç¡®è®¤æ˜¯å¦æœ‰å¼‚å¸¸è®¿é—®

2. **æŸ¥çœ‹APIæ—¥å¿—**
   - ç‚¹å‡»å·¦ä¾§èœå• **Logs** â†’ **API**
   - æŸ¥çœ‹æœ€è¿‘çš„APIè°ƒç”¨è®°å½•

3. **æ£€æŸ¥å¼‚å¸¸æ´»åŠ¨**
   - æŸ¥çœ‹æ˜¯å¦æœ‰æ¥è‡ªæœªçŸ¥IPçš„è®¿é—®
   - æŸ¥çœ‹æ˜¯å¦æœ‰å¤§é‡å¼‚å¸¸æŸ¥è¯¢
   - å¦‚æœ‰å¼‚å¸¸ï¼Œç«‹å³é‡‡å–å®‰å…¨æªæ–½

---

## ğŸ”§ Gitå†å²æ¸…ç†ï¼ˆå¯é€‰ä½†æ¨èï¼‰

å¦‚æœåŒ…å«æ•æ„Ÿä¿¡æ¯çš„æ–‡æ¡£å·²ç»æ¨é€åˆ°GitHubï¼Œå»ºè®®æ¸…ç†Gitå†å²ã€‚

### æ–¹æ¡ˆAï¼šä½¿ç”¨BFG Repo-Cleanerï¼ˆæ¨èï¼‰

**ä¼˜ç‚¹**ï¼š
- æ¯”git filter-branchæ›´å¿«
- æ›´ç®€å•æ˜“ç”¨
- è‡ªåŠ¨æ¸…ç†æ‰€æœ‰å¼•ç”¨

**æ­¥éª¤**ï¼š

1. **å®‰è£…BFG**
   ```bash
   # macOS
   brew install bfg
   
   # æˆ–ä¸‹è½½jaræ–‡ä»¶
   # https://rtyley.github.io/bfg-repo-cleaner/
   ```

2. **å…‹éš†ä¸€ä¸ªè£¸ä»“åº“ï¼ˆbare repositoryï¼‰**
   ```bash
   cd /tmp
   git clone --mirror https://github.com/your-username/FilmTrip.git filmtrip.git
   ```

3. **ä½¿ç”¨BFGæ¸…ç†æ•æ„Ÿä¿¡æ¯**
   ```bash
   # åˆ é™¤åŒ…å«å¯†ç çš„æäº¤å†…å®¹
   bfg --replace-text passwords.txt filmtrip.git
   ```

   **åˆ›å»º `passwords.txt` æ–‡ä»¶**ï¼š
   ```
   Guluhub@2025==>***REMOVED***
   Guluhub%402025==>***REMOVED***
   xpcriheeehusrqyycdfx==>***REMOVED***
   ```

4. **æ¸…ç†å¼•ç”¨æ—¥å¿—**
   ```bash
   cd filmtrip.git
   git reflog expire --expire=now --all
   git gc --prune=now --aggressive
   ```

5. **å¼ºåˆ¶æ¨é€**
   ```bash
   git push --force
   ```

6. **âš ï¸ é‡è¦**ï¼š
   - é€šçŸ¥æ‰€æœ‰åä½œè€…é‡æ–°å…‹éš†ä»“åº“
   - æˆ–è€…åœ¨æ‰€æœ‰æœ¬åœ°ä»“åº“ä¸­æ‰§è¡Œï¼š
     ```bash
     git fetch origin
     git reset --hard origin/main
     ```

### æ–¹æ¡ˆBï¼šä½¿ç”¨git filter-branch

**æ­¥éª¤**ï¼š

1. **åˆ›å»ºæ¸…ç†è„šæœ¬**
   ```bash
   git filter-branch --force --index-filter \
     'git rm --cached --ignore-unmatch docs/deployment/vercel-supabase-config.md docs/deployment/environment-strategy.md' \
     --prune-empty --tag-name-filter cat -- --all
   ```

2. **æ¸…ç†å¼•ç”¨**
   ```bash
   rm -rf .git/refs/original/
   git reflog expire --expire=now --all
   git gc --prune=now --aggressive
   ```

3. **å¼ºåˆ¶æ¨é€**
   ```bash
   git push origin --force --all
   git push origin --force --tags
   ```

### âš ï¸ Gitå†å²æ¸…ç†æ³¨æ„äº‹é¡¹

1. **å¤‡ä»½ä»“åº“**
   - æ¸…ç†å‰å…ˆå®Œæ•´å¤‡ä»½ä»“åº“

2. **é€šçŸ¥åä½œè€…**
   - æ‰€æœ‰åä½œè€…éœ€è¦é‡æ–°å…‹éš†ä»“åº“
   - æˆ–æ›´æ–°æœ¬åœ°ä»“åº“å¼•ç”¨

3. **æ›´æ–°è¿œç¨‹ä»“åº“**
   - æ¸…ç†åéœ€è¦å¼ºåˆ¶æ¨é€
   - è¿™ä¼šå½±å“æ‰€æœ‰åˆ†æ”¯å’Œæ ‡ç­¾

4. **è€ƒè™‘å½±å“**
   - å¦‚æœæœ‰å…¶ä»–äººåœ¨ä½¿ç”¨è¯¥ä»“åº“ï¼Œéœ€è¦åè°ƒ
   - å¦‚æœæœ‰CI/CDï¼Œéœ€è¦æ›´æ–°é…ç½®

---

## âœ… éªŒè¯æ¸…å•

å®Œæˆæ‰€æœ‰æ­¥éª¤åï¼Œè¯·ç¡®è®¤ï¼š

- [ ] âœ… Supabaseæ•°æ®åº“å¯†ç å·²é‡ç½®
- [ ] âœ… æ–°å¯†ç å·²å®‰å…¨ä¿å­˜
- [ ] âœ… Vercelç¯å¢ƒå˜é‡å·²æ›´æ–°
- [ ] âœ… Vercelåç«¯é¡¹ç›®å·²é‡æ–°éƒ¨ç½²
- [ ] âœ… æœ¬åœ°.envæ–‡ä»¶å·²æ›´æ–°
- [ ] âœ… æœ¬åœ°æ•°æ®åº“è¿æ¥æµ‹è¯•é€šè¿‡
- [ ] âœ… Supabaseè®¿é—®æ—¥å¿—å·²æ£€æŸ¥ï¼ˆæ— å¼‚å¸¸ï¼‰
- [ ] âœ… Gitå†å²å·²æ¸…ç†ï¼ˆå¦‚éœ€è¦ï¼‰
- [ ] âœ… æ‰€æœ‰åä½œè€…å·²é€šçŸ¥ï¼ˆå¦‚éœ€è¦ï¼‰

---

## ğŸ“‹ æ–°å¯†ç è®°å½•

**âš ï¸ å®‰å…¨æç¤º**ï¼šå°†ä»¥ä¸‹ä¿¡æ¯å­˜å‚¨åœ¨å®‰å…¨ä½ç½®ï¼ˆå¦‚å¯†ç ç®¡ç†å™¨ï¼‰ï¼Œä¸è¦å­˜å‚¨åœ¨ä»£ç ä»“åº“ä¸­ã€‚

```
é¡¹ç›®ï¼šFilmTrip - Supabase PostgreSQL
æ•°æ®åº“å¯†ç ï¼š[æ–°å¯†ç ]
é¡¹ç›®IDï¼š[é¡¹ç›®ID]
è¿æ¥å­—ç¬¦ä¸²ï¼špostgresql://postgres:[NEW-PASSWORD]@db.[PROJECT-ID].supabase.co:5432/postgres
é‡ç½®æ—¥æœŸï¼š2025-11-14
é‡ç½®åŸå› ï¼šå¯†ç åœ¨æ–‡æ¡£ä¸­æ³„éœ²
```

---

## ğŸ†˜ é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼šVerceléƒ¨ç½²åæ•°æ®åº“è¿æ¥å¤±è´¥

**å¯èƒ½åŸå› **ï¼š
- ç¯å¢ƒå˜é‡æ ¼å¼é”™è¯¯
- å¯†ç URLç¼–ç é”™è¯¯
- Supabaseé˜²ç«å¢™è®¾ç½®

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ç¯å¢ƒå˜é‡æ ¼å¼æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤å¯†ç ä¸­çš„ `@` å·²ç¼–ç ä¸º `%40`
3. æ£€æŸ¥Supabase Dashboardçš„é˜²ç«å¢™è®¾ç½®
4. æŸ¥çœ‹Verceléƒ¨ç½²æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯

### é—®é¢˜2ï¼šæœ¬åœ°è¿æ¥æµ‹è¯•å¤±è´¥

**å¯èƒ½åŸå› **ï¼š
- .envæ–‡ä»¶æ ¼å¼é”™è¯¯
- å¯†ç æœªæ­£ç¡®æ›´æ–°
- ç½‘ç»œé—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥.envæ–‡ä»¶æ ¼å¼
2. ç¡®è®¤å¯†ç å·²æ›´æ–°
3. æµ‹è¯•ç½‘ç»œè¿æ¥
4. æ£€æŸ¥Supabaseé¡¹ç›®çŠ¶æ€

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Supabaseå®˜æ–¹æ–‡æ¡£](https://supabase.com/docs)
- [Vercelç¯å¢ƒå˜é‡æ–‡æ¡£](https://vercel.com/docs/concepts/projects/environment-variables)
- [Gitå†å²æ¸…ç†æŒ‡å—](../guides/git-history-cleanup.md)ï¼ˆå¾…åˆ›å»ºï¼‰
- [å®‰å…¨å®¡è®¡æŠ¥å‘Š](./security-audit-2025-11-14.md)

---

**æœ€åæ›´æ–°**ï¼š2025-11-14  
**çŠ¶æ€**ï¼šå¾…æ‰§è¡Œ


