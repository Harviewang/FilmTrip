# 地图中文地点增强最佳实践

**创建日期**：2025-10-28  
**适用范围**：FilmTrip 项目中与中文地址解析、地图选点、预览小地图相关的开发

## 背景与目标
- 上传/编辑照片时，通过地图选点自动生成五级中文地址（country/province/city/district/township）与坐标。  
- 照片预览页按需加载迷你地图，仅在用户点击地址字段时显示。  
- 地图总览页依据坐标打点，后续支持批量补录。  
- 底图中文化、点聚合等能力不是本阶段目标。

## 设计原则
1. **字段结构一致**：存储字段固定为 `country/province/city/district/township/location_name` + `latitude/longitude`；展示时再拼成完整中文地址。
2. **统一解析服务**：后端暴露正向/逆向解析接口，前端只传座标或触发选点事件，不直接操作第三方 API。
3. **按需加载地图**：PhotoPreview 和迷你地图仅在用户点击时加载 MapLibre 资源，关闭弹窗后销毁实例。
4. **国内外可用**：以 MapTiler API 为主，若返回内容为英文且存在 `country_code`，使用内置映射表或第三方翻译作为兜底；预留 Geomaply 作为备选数据源。
5. **缓存与兜底**：缓存用户确认过的 `关键字 ↔ 坐标 ↔ 中文地址` 映射；第三方 API 失败时允许手动输入确认。

## 实现步骤（推荐流程）
1. **地址解析服务（M-4）**  
   - 写后端 `/api/geocode`（正向）与 `/api/geocode/reverse`（逆向），调用 MapTiler。  
   - 解析结果统一映射为五级字段 + 坐标；对英文文本根据 `country_code` 替换为中文。  
   - 维护城市、国家翻译表；必要时调用第三方翻译接口。

2. **上传 / 编辑联动（M-5）**  
   - 上传/批量上传表单：用户点击“在地图上标点”→ 选择坐标 → 调用解析接口 → 回填字段 → 用户确认 → 写入数据库。  
   - 编辑页：允许重新选点并覆盖原有字段。  
   - 若解析失败，提示用户手动输入并记录日志。

3. **预览小地图（M-6）**  
   - PhotoPreview 中点击省/市/区字段才加载 MapLibre，并以 `zoom = 12` 初始化迷你地图。  
   - 标记点显示中文地址信息，可放大/缩小，无需跳转主地图。  
   - 列表视图保持纯文本展示。

4. **地图总览打点（中期）**  
   - `/map` 页依据坐标批量打点，数量较大时再评估聚合。  
   - 未标点照片在后台提供批量补录入口。

## 翻译与数据源建议
- **首选 MapTiler**：全球可用、结构统一，包含 `country_code`。  
- **备选 Geomaply**：文档中说明为后续补充方案，可在离线或 MapTiler 限制时启用。  
- **翻译策略**：先使用 API 返回的中文；若仍为英文且带 `country_code`，使用内置映射表（国家、常见州/省），必要时调用第三方翻译 API。

## 相关文档
- `docs/work-plans/2025-10-28/summary.md`
- `docs/work-plans/2025-10-28/commits/CMT-20251028-002.md`
- `docs/specifications/需求文档-统一版.md`

---
*保持上述流程，可确保地图中文地点增强开发与维护一致性，方便后续扩展。*
