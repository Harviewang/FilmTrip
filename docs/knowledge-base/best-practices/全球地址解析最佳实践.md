# 全球地址解析最佳实践

## 问题背景

在FilmTrip项目中，需要将任意坐标（国内外）解析为统一的结构化地址，并展示中文。

## 设计原则

### 1. 统一优于混合

❌ **错误做法**：
```javascript
if (isChinaCoordinate(lat, lng)) {
  return await queryAmap(lat, lng);  // 国内用高德
} else {
  return await queryMapTiler(lat, lng);  // 国外用MapTiler
}
```

✅ **正确做法**：
```javascript
// 统一使用MapTiler API（支持全球）
return await queryMapTiler(lat, lng);
```

**原因**：
- 避免复杂的判断逻辑
- 统一接口更易维护
- MapTiler覆盖全球

### 2. 适配优于强制

不是让API适应我们，而是我们适配API的数据结构。

✅ **适配MapTiler的context数组**：
```javascript
// MapTiler的数据结构
context: [
  { id: "county.3556", text: "深圳市", country_code: "cn" },
  { id: "joint_municipality.10486", text: "南山区" }
]

// 根据实际结构判断层级
if (tempData.city && tempData.jointMunicipality) {
  // 多层结构：深圳市→city, 南山区→district
} else if (tempData.jointMunicipality && !tempData.city) {
  // 直辖市结构：东城区→city
}
```

### 3. 翻译优于原文

国外地址自动翻译为中文，提升用户体验。

✅ **使用country_code进行翻译**：
```javascript
if (countryCode !== 'cn') {
  country = getCountryTranslation(countryCode);
  province = translateAddress(countryCode, province, 'province');
}
```

## 核心技术点

### 1. MapTiler的context结构

```
ID格式说明：
- country.XXX → 国家
- region.XXX → 州/省（designation="state"）
- subregion.XXX → 州/省
- county.XXX → 市（designation="city"）
- joint_municipality.XXX → 区/市
- municipality.XXX → 街道（designation="suburb"）
- neighbourhood.XXX → 社区
```

### 2. 层级判断逻辑

```javascript
// 中国多层结构（深圳）
county(深圳市) → city
joint_municipality(南山区) → district

// 中国直辖市（北京）
subregion(北京市) → province
joint_municipality(东城区) → city

// 国外（纽约）
region(New York) → province
joint_municipality(Manhattan) → city
```

### 3. 翻译映射表

```javascript
const translations = {
  country: { 'us': '美国', 'jp': '日本', ... },
  usStates: { 'New York': '纽约州', ... },
  ukRegions: { 'England': '英格兰', ... },
  jpRegions: { '東京都': '东京都', ... }
};
```

## 实现细节

### API接口

**Endpoint**: `POST /api/geocode/reverse`

**Request**:
```json
{
  "latitude": 22.5431,
  "longitude": 113.9344
}
```

**Response**:
```json
{
  "success": true,
  "data": {
    "country": "中国",
    "province": "广东省",
    "city": "深圳市",
    "district": "南山区",
    "township": "粤海街道",
    "formatted_address": "深大北天橋, 518060 粤海街道, 中国",
    "latitude": 22.5431,
    "longitude": 113.9344,
    "source": "maptiler"
  }
}
```

### 关键函数

1. **parseMapTilerContext(context)** - 解析context数组
2. **translateAddress(countryCode, region, level)** - 翻译地区名
3. **getCountryTranslation(countryCode)** - 翻译国家名

## 注意事项

### ⚠️ 常见坑点

1. **context顺序是倒序**：从详细到宏观，需要正序遍历
2. **designation可能为空**：优先使用id前缀判断
3. **国外district经常为空**：可接受，保持city层级即可
4. **直辖市特殊处理**：北京、上海等层级与其他城市不同

### ✅ 最佳实践

1. **先收集所有数据**：使用tempData对象存储
2. **后判断层级结构**：根据存在与否决定city/district
3. **最后应用翻译**：避免重复翻译
4. **保持结构一致**：无论国内外，返回格式统一

## 测试建议

### 测试用例覆盖

- ✅ **国内多层**：深圳（省/市/区/街道）
- ✅ **国内直辖市**：北京（市/区/街道）
- ✅ **美国**：纽约（州/区）
- ✅ **欧洲**：伦敦（国家/地区/市）
- ✅ **日本**：东京（国家/都/区）

### 验证要点

1. **5级字段完整性**：country/province/city/district/township
2. **中文翻译准确性**：国外地点应翻译为中文
3. **层级合理性**：深圳city=深圳市（不是区）
4. **空字段处理**：district可为空，无需强制填充

## 相关文档

- [MapTiler API文档](https://www.maptiler.com/api-documentation/)
- [地址解析测试报告](../problem-solving/MapTiler地址解析经验.md)
- [代码实现](../backend/routes/geocode.js)

