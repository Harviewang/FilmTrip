# FilmTrip CDN 与地图加速讨论纪要（2025-11-06）

**分类**：最佳实践 / 需求澄清  
**相关人员**：王海伟、AI 助手  
**来源文档**：`docs/archive/临时文档/FilmTrip_2025-11-06_讨论纪要.md`

---

## 1. 讨论背景

- FilmTrip v1.0 准备上线，需要在有限的 CDN 免费额度下完成图片展示、水印保护、地图聚合、社交分享体验闭环。  
- 需要明确：CDN 接入范围、上传与水印策略、文件查重方案、地图聚合与缩放流程、分享体验、整体性能优化路线。

---

## 2. 关键结论

### 2.1 CDN 接入策略
- **环境区分**：本地/调试阶段只使用本地文件，避免消耗 CDN；生产环境接入优拍云。  
- **接入范围**：首版仅对图片与地图瓦片启用 CDN；静态页面暂不接入整站加速。  
- **额度管理**：现有免费额度约 15GB（存储+流量），后续视访问量评估升级方案。

### 2.2 水印与文件版本
- **首选方案**：利用 CDN 图片处理能力进行动态水印，原图保持纯净。  
- **备选方案**：上传阶段生成带水印副本，命名为 `<hash>_wm.jpg`，用于分享。  
- **权限隔离**：原图仅管理员可访问，对外展示使用处理后的标准图或分享图。

### 2.3 MD5 去重与文件唯一性
- CDN 不提供内容去重，需要系统侧实现。  
- 上传前前端计算 MD5，提交后端校验 `file_hash` 唯一索引；存在时复用原文件和短码。  
- 文件存储表字段建议：`id (uuid)`、`md5`、`cdn_url`、`created_at`、`deleted_at`。

### 2.4 地图按视野聚合
- **短期方案（v1.0）**：动态网格聚合 + 视野加载（viewport-based loading）。  
- **缩放层级建议**：

| Zoom | 聚合层级 | 说明 |
|------|-----------|------|
| 3–5  | 国家级 | 显示国家概览 |
| 6–8  | 省级 | 按省份聚合 |
| 9–12 | 城市级 | 城市聚合 |
| 13–15| 街道级 | 展示实际标记点 |

- **后续方向**：结合行政区划聚合、时间轴/轨迹动画等进阶展示。

### 2.5 分享体验
- 分享入口应默认引用带水印的分享图，并附带模板化说明文案。  
- 示例文案：`📷 拍摄于 {city}，来自 FilmTrip 胶片计划。`  
- 支持用户选择是否附加水印或说明文字。

### 2.6 性能与多供应商备援
- 地图底图策略：`MapTiler (主)` → `GeoMaply (备)` → `OSM (兜底)`。  
- 仅加载当前视口瓦片，热门区域可预加载并缓存。  
- 图片与瓦片均走 CDN，主站接口保持独立，便于排查流量消耗。

---

## 3. 后续行动（需求池建议条目）

| 编号 | 事项 | 备注 |
|------|------|------|
| CDN-01 | 构建环境感知的文件/图片访问层（本地/生产自动切换） |  |
| CDN-02 | 接入优拍云图片处理，封装动态水印参数 |  |
| CDN-03 | 上传流程增加 MD5 校验与去重逻辑 |  |
| MAP-01 | 实现基于视野的照片聚合接口与前端渲染 |  |
| MAP-02 | 配置 MapTiler → GeoMaply → OSM 的降级策略 |  |
| SHARE-01 | 上传阶段生成可分享的水印版本并支持文案模板 |  |
| PERF-01 | 统计并监控 CDN 流量、瓦片请求量，作为后续缓存策略依据 |  |

---

## 4. 相关文档与链接

- [`docs/specifications/命名与短链规范.md`](../../specifications/命名与短链规范.md)：短链与文件结构规范。  
- [`docs/specifications/需求文档-统一版.md`](../../specifications/需求文档-统一版.md)：需求池条目集中管理位置。  
- `docs/archive/临时文档/FilmTrip_2025-11-06_讨论纪要.md`：原始详细记录。

---

> **维护说明**：若 CDN、地图或水印策略后续有更新，请同步更新本纪要与需求池条目，保持规范与实现的一致性。

