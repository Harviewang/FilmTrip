
# 懒加载与下拉刷新交互功能需求文档（终版）

## 📌 功能概述

本模块实现统一的懒加载与下拉刷新体验，具备以下特性：

- **拖动页面任意空白处或图片**均可上下滑动；
- 滚轮和拖动行为一致；
- **仅在滚动到顶/底时，才能触发刷新/加载动作**；
- 拖动释放才触发，未达阈值自动回弹；
- 拖动图片时不应触发图片原生“拖出”行为；
- **刷新/加载不影响当前筛选、排序、已有图片数据或顺序**；
- **禁止左右滑动触发刷新或加载**；
- 无需加载时保持正常拖动体验。

---

## ✨ 用户交互规则

| 操作                        | 是否允许 | 说明                                                                 |
|-----------------------------|-----------|----------------------------------------------------------------------|
| 页面上下滚动（滚轮）        | ✅        | 常规滚动，滚动到顶/底不会自动触发刷新/加载                         |
| 拖动图片或空白处上下滑动    | ✅        | 等同页面滚动行为；不会拖出图片，不触发图片拖拽                      |
| 拖动未达阈值释放            | ✅        | 页面回弹，**不触发刷新/加载**                                       |
| 拖动到阈值后释放（顶部）    | ✅        | **仅当页面已滚动到最顶部时**，触发下拉刷新                          |
| 拖动到阈值后释放（底部）    | ✅        | **仅当页面已滚动到底部时**，触发上拉懒加载                          |
| 拖动图片触发图片原生拖动    | ❌        | 必须禁止 `<img>` 被拖出页面                                         |
| 横向拖动滑动行为            | ❌        | 不支持左右滑动触发刷新或加载                                        |

---

## 🔄 刷新 / 加载行为说明

### 下拉刷新（Pull to Refresh）

- **前提：页面已滚动至顶部**
- 拖动向下超过阈值（如 60px）后释放，触发刷新
- 刷新行为：
  - 重新加载第一页数据
  - **保留排序/筛选逻辑**
  - **替换当前展示数据**
  - 不重复加载已有数据
  - 显示“刷新成功”提示
  - 页面自动回弹至顶部

### 上拉懒加载（Infinite Scroll）

- **前提：页面已滚动到底部**
- 拖动向上超过阈值后释放，触发加载
- 加载行为：
  - 加载下一页数据
  - **不重复已有数据**
  - **不打乱当前顺序**
  - 加载完成后自动回弹
  - 若已无更多数据，显示“已加载全部”

---

## 🎯 滚动与拖动判定逻辑

### 滚轮行为（mousewheel / scroll）

- 允许上下滑动页面
- 不会触发刷新或加载
- 到顶/底后必须通过**拖动释放**触发刷新/加载

### 拖动行为（touch / mouse）

- 拖动起点：任意区域，包括图片
- 拖动图片时需禁止 `<img draggable="true">` 默认行为
- 拖动方向限制：仅纵向
- 拖动释放动作由滚动位置 + 拖动距离联合判断

---

## 🧭 交互反馈说明

| 状态            | 视觉表现                          |
|-----------------|-----------------------------------|
| 正在拖动        | 展示提示文字：“继续下拉刷新...” 或 “继续上拉加载...” |
| 达到阈值        | 提示变为：“释放立即刷新” 或 “释放加载更多”         |
| 加载中 / 刷新中 | 显示 loading 图标 + 文案                       |
| 加载完成        | 提示“加载完成” / “刷新成功”                     |
| 无更多数据      | 显示灰色提示“已加载全部”                         |
| 拖动未达阈值    | 页面回弹，提示隐藏，无任何数据请求                |

---

## 🛠️ 开发注意事项

1. **必须阻止 `<img>` 被原生拖拽行为**
   ```html
   <img src="xxx.jpg" draggable="false" />
   ```

2. 拖动判定必须结合：
   - 滚动位置 = `scrollTop === 0` 或 `scrollHeight - scrollTop === clientHeight`
   - 拖动方向 + 拖动距离 > 阈值

3. 拖动释放才触发刷新/加载，不能在滑动过程中直接触发。

4. 不得因刷新/加载改变已有数据或打乱原顺序。

5. 所有行为写入统一交互组件或 Hook，确保复用与一致性。

6. 若处于加载中，禁止再次触发新的加载/刷新，防止并发冲突。

---

## 💡 示例代码（可直接保存为 .html 运行）

```html
<!-- 以下为完整 HTML 示例 -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>懒加载与下拉刷新示例</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
    }
    #container {
      height: 100%;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      background: #f0f0f0;
      position: relative;
    }
    .pull-indicator, .load-indicator {
      text-align: center;
      padding: 10px;
      color: #666;
    }
    .image-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 10px;
    }
    .image-list img {
      width: 100%;
      max-height: 200px;
      object-fit: cover;
      pointer-events: none;
      user-drag: none;
    }
  </style>
</head>
<body>
<div id="container">
  <div class="pull-indicator" id="pull-indicator">下拉刷新</div>
  <div class="image-list" id="image-list"></div>
  <div class="load-indicator" id="load-indicator">上拉加载</div>
</div>

<script>
  const container = document.getElementById('container');
  const imageList = document.getElementById('image-list');
  const pullIndicator = document.getElementById('pull-indicator');
  const loadIndicator = document.getElementById('load-indicator');

  let isLoading = false;
  let isRefreshing = false;
  let startY = 0;
  let distance = 0;
  const THRESHOLD = 60;

  function loadImages(count = 10) {
    for (let i = 0; i < count; i++) {
      const img = document.createElement('img');
      img.src = `https://picsum.photos/400/200?random=${Date.now() + Math.random()}`;
      img.setAttribute('draggable', 'false');
      imageList.appendChild(img);
    }
  }

  function refresh() {
    if (isRefreshing) return;
    isRefreshing = true;
    pullIndicator.innerText = '刷新中...';
    setTimeout(() => {
      imageList.innerHTML = '';
      loadImages();
      pullIndicator.innerText = '刷新成功';
      setTimeout(() => pullIndicator.innerText = '下拉刷新', 1000);
      isRefreshing = false;
    }, 1000);
  }

  function lazyLoad() {
    if (isLoading) return;
    isLoading = true;
    loadIndicator.innerText = '加载中...';
    setTimeout(() => {
      loadImages();
      loadIndicator.innerText = '上拉加载';
      isLoading = false;
    }, 1000);
  }

  container.addEventListener('touchstart', e => {
    if (container.scrollTop === 0 || container.scrollTop + container.clientHeight >= container.scrollHeight) {
      startY = e.touches[0].clientY;
    }
  });

  container.addEventListener('touchmove', e => {
    const currentY = e.touches[0].clientY;
    distance = currentY - startY;

    if (container.scrollTop === 0 && distance > 0) {
      e.preventDefault();
      pullIndicator.innerText = distance > THRESHOLD ? '释放刷新' : '下拉刷新';
    }
    if (container.scrollTop + container.clientHeight >= container.scrollHeight && distance < 0) {
      e.preventDefault();
      loadIndicator.innerText = Math.abs(distance) > THRESHOLD ? '释放加载更多' : '上拉加载';
    }
  });

  container.addEventListener('touchend', () => {
    if (distance > THRESHOLD && container.scrollTop === 0) {
      refresh();
    } else if (Math.abs(distance) > THRESHOLD && container.scrollTop + container.clientHeight >= container.scrollHeight) {
      lazyLoad();
    }
    distance = 0;
  });

  container.addEventListener('scroll', () => {
    if (container.scrollTop + container.clientHeight >= container.scrollHeight - 5) {
      lazyLoad();
    }
  });

  loadImages();
</script>
</body>
</html>
```
