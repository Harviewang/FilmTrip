# FilmTrip 开发规范

## 🤖 团队协作规则

### Agent角色定义

#### @architect - 系统架构师
- **职责**: 整体架构设计、技术选型、代码审查、性能优化
- **专长**: 系统设计、架构模式、设计原则、技术选型
- **工作方式**: 提供架构建议、代码审查、性能优化建议

#### @backend - 后端开发工程师  
- **职责**: API开发、数据库设计、业务逻辑、中间件开发
- **专长**: Node.js、Express、SQLite、REST API、认证授权
- **工作方式**: 实现后端功能、编写API文档、处理业务逻辑

#### @frontend - 前端开发工程师
- **职责**: UI组件开发、状态管理、用户体验、响应式设计
- **专长**: React、Tailwind CSS、状态管理、组件设计、用户交互
- **工作方式**: 创建React组件、优化用户体验、实现响应式布局

#### @database - 数据库工程师
- **职责**: 数据建模、查询优化、数据迁移、性能调优
- **专长**: SQLite、数据建模、SQL优化、数据完整性、索引设计
- **工作方式**: 设计数据库结构、优化查询性能、管理数据迁移

#### @tester - 测试工程师
- **职责**: 单元测试、集成测试、端到端测试、质量保证
- **专长**: Jest、API测试、前端测试、测试策略、自动化测试
- **工作方式**: 编写测试用例、执行测试、报告问题、质量监控

#### @devops - 运维工程师
- **职责**: 部署配置、环境管理、监控告警、性能优化
- **专长**: 部署脚本、环境配置、日志监控、性能分析
- **工作方式**: 配置部署环境、监控服务状态、优化性能

#### @reviewer - 代码评审专家
- **职责**: 代码质量审查、功能完整性检查、跨模块一致性验证、遗漏检测
- **专长**: 代码规范、设计模式、用户体验、性能优化、安全审计
- **工作方式**: 交叉检查各模块开发、发现潜在问题、提供改进建议、确保质量标准

### 协作工作流

#### 1. 功能开发流程
```
主Agent: 我们需要开发新功能X
@architect: 设计整体架构和技术方案
@backend: 实现后端API和业务逻辑
@frontend: 开发前端界面和交互
@database: 设计数据结构和查询
@tester: 编写测试用例并验证
@devops: 配置部署和监控
```

#### 2. 代码审查流程
```
@reviewer: 统筹代码质量审查和完整性检查
@architect: 审查架构设计和代码结构
@backend: 审查后端代码质量和性能
@frontend: 审查前端代码和用户体验
@database: 审查数据库设计和查询
@tester: 审查测试覆盖率和质量
```

#### 3. 问题排查流程
```
@tester: 发现并报告问题
@reviewer: 交叉验证问题范围和影响
@architect: 分析问题根因和影响范围
@backend/@frontend: 定位和修复代码问题
@database: 检查数据相关问题
@devops: 检查环境和部署问题
```

### 使用技巧

#### 1. 明确指定Agent
```
@backend 请帮我优化这个API的性能
@frontend 这个组件需要支持移动端
@database 这个查询太慢了，请优化
```

#### 2. 多Agent协作
```
@architect @backend @frontend 我们一起来设计用户权限系统
@database @tester 请协作完成数据迁移的测试
```

---

## 🚀 开发启动流程

### 1. 服务启动规范
```bash
# 后端启动 (端口3001)
cd backend
npm start

# 前端启动 (端口3002) - 必须指定端口！
cd frontend
npx vite --port 3002 --host  # 不要用 npm run dev (默认5173端口)
```

### 2. 端口配置规范
- **后端**: 3001端口
- **前端**: 3002端口 (必须明确指定)
- **数据库**: SQLite文件在 `data/filmtrip.db`

### 3. 启动验证规范
```bash
# 验证后端
curl http://localhost:3001/api/photos

# 验证前端
curl http://localhost:3002
```

## 🔍 问题排查规范

### 1. 前端页面打不开
**检查顺序**：
1. 检查端口占用: `lsof -i :3002`
2. 检查进程状态: `ps aux | grep vite`
3. 检查端口配置: 确保使用 `--port 3002`
4. 检查服务日志: 查看启动错误

### 2. 缩略图不显示
**检查顺序**：
1. 检查后端API: `curl /api/photos`
2. 检查文件路径: `uploads/Film_roll/roll_XXX/thumbnails/`
3. 检查数据库: `filename` 字段是否匹配
4. 检查前端代码: 图片src路径是否正确

### 3. 高度自适应问题
**检查顺序**：
1. 检查CSS类: `h-screen overflow-hidden`
2. 检查容器: `h-full overflow-y-auto`
3. 检查Tailwind配置: 自定义高度类

## 📁 目录结构规范

### 1. 上传文件结构
```
uploads/
├── Film_roll/
│   ├── roll_001/
│   │   ├── photos/          # 原图
│   │   └── thumbnails/      # 缩略图
│   └── roll_002/
├── Film_stocks/             # 胶卷类型
└── camera/                  # 相机信息
```

### 2. 文件命名规范
- **照片**: `photo_XXX.jpg` (XXX为序号)
- **胶卷**: `roll_XXX` (XXX为胶卷ID)
- **缩略图**: 与原图同名，放在thumbnails目录

## 🛠️ 开发工具规范

### 1. 脚本使用
```bash
# 启动脚本
./start-smart.sh          # 智能启动
./start-dev-tabs.sh       # 多标签启动
./stop-services.sh        # 停止服务

# 数据库脚本
backend/scripts/          # 数据创建和修复脚本
```

### 2. 调试工具
```bash
# 检查缩略图
node backend/scripts/check-thumbnails.js

# 生成缩略图
node backend/scripts/ensure-thumbnails.js

# 修复文件名
node backend/scripts/fix-photo-filenames.js
```

## 🔧 代码规范

### 1. 前端组件
- 使用 `AdaptiveLayout`, `AdaptiveGrid`, `AdaptiveCard` 组件
- 图片路径: `http://localhost:3001${photo.thumbnail}`
- 高度自适应: `h-screen overflow-hidden` + `h-full overflow-y-auto`

### 2. 后端API
- 照片API: `/api/photos` 返回 `{data: [...]}`
- 胶卷API: `/api/filmRolls` 返回 `{data: [...]}`
- 胶卷类型API: `/api/filmStocks` 返回 `{data: [...]}`

### 3. 数据库操作
- 使用 `models/db.js` 中的 `query`, `insert`, `update`, `deleteRecord`
- 外键约束: 删除前先删除引用数据

## 📋 开发检查清单

### 启动前检查
- [ ] 确认端口3001和3002未被占用
- [ ] 确认数据库文件存在
- [ ] 确认uploads目录结构正确

### 开发中检查
- [ ] 前端页面能正常访问
- [ ] 后端API能正常响应
- [ ] 缩略图能正常显示
- [ ] 高度自适应正常工作

### 提交前检查
- [ ] 所有功能正常工作
- [ ] 无控制台错误
- [ ] 响应式设计正常
- [ ] 性能符合要求

## 🚨 常见错误及解决方案

### 1. "npm run dev" 端口错误
**错误**: 前端启动在5173端口而不是3002
**解决**: 使用 `npx vite --port 3002 --host`

### 2. "photos.map is not a function"
**错误**: API返回格式不正确
**解决**: 检查API返回结构，确保是数组

### 3. "Cannot read properties of null"
**错误**: DOM元素不存在
**解决**: 添加null检查 `e.target.nextSibling?.style`

### 4. 缩略图404
**错误**: 文件路径不匹配
**解决**: 运行 `fix-photo-filenames.js` 脚本

## 📚 相关文档
- `docs/前端设计规范.md` - 前端设计标准
- `docs/数据库设计.md` - 数据库结构
- `docs/问题追踪.md` - 已知问题和解决方案

---

**重要提醒**: 每次开发前必须阅读此规范，避免重复问题！

## 🚨 用户核心规则 (必须遵守)

### 1. 会话不阻断规则
- **禁止**: 执行命令时阻断用户会话
- **要求**: 所有命令必须使用 `&` 或 `nohup` 在后台运行
- **原则**: 用户永远不应该等待命令执行完成

### 2. 全屏自适应规则
- **禁止**: 出现全局滚动条
- **要求**: 所有页面必须使用 `h-screen overflow-hidden` + `h-full overflow-y-auto`
- **原则**: 页面内容必须在视窗范围内，不产生全局滚动

### 3. AI角色分工规则
- **禁止**: 单一角色包揽所有工作
- **要求**: 必须调用多个AI角色分工协作
- **原则**: 每个角色专注自己的专业领域

### 4. 测试和审计规则
- **禁止**: 站在开发者角度自说自话
- **要求**: 必须站在用户角度验证需求是否被满足
- **原则**: 用户需求是唯一标准，不是技术实现

## 🔄 执行流程规范

### 命令执行规范
```bash
# ✅ 正确 - 后台执行，不阻断会话
nohup npm start > /dev/null 2>&1 &
npx vite --port 3002 --host &

# ❌ 错误 - 会阻断会话
npm start
npx vite --port 3002
```

### 样式调整规范
```css
/* ✅ 正确 - 全屏自适应 */
.adaptive-layout {
  @apply h-screen overflow-hidden;
}
.content-container {
  @apply h-full overflow-y-auto;
}

/* ❌ 错误 - 会产生全局滚动条 */
.page {
  @apply min-h-screen;
}
```

### AI角色调用规范
```
@architect: 设计架构方案
@backend: 实现后端功能
@frontend: 开发前端界面
@tester: 验证功能完整性
@reviewer: 检查代码质量
@auditor: 确保用户需求满足
```
