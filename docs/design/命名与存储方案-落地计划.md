# FilmTrip 文件命名与存储方案 - 落地计划

## 1. 背景与目标

- 当前上传流程仍在后端本地生成多尺寸图片并落盘，违背“后端不持久化图片”的新要求。
- `docs/specifications/命名与短链规范.md` 已定义 UUID 命名、三层哈希目录、短链和哈希去重策略，但尚未在代码与数据库层面落地。
- CDN（UpYun）接入前，需要先建立统一的命名/路径/元数据体系，确保后续可直接切换到对象存储。

**阶段目标**
1. （阶段一）完成命名与存储基础设施改造：数据库结构升级、哈希去重、路径生成、短链能力、前后端字段对齐。
2. （阶段二）在阶段一基础上导入 UpYun 直传/回调链路，实现“前端直传 + 后端协调”并扩展到多版本(水印/WebP)。

## 2. 改动方案

### 2.1 阶段一：命名与存储基础能力

- **数据库层**
  - 表 `photos` 新增字段：`file_hash (CHAR(64))`、`storage_variant (ENUM)`、`short_code (VARCHAR)`、`deleted_at (DATETIME NULL)`、`origin_bucket (VARCHAR)`、`origin_path (VARCHAR)`。
  - 设计唯一索引 `(file_hash, storage_variant)`；`short_code` 设唯一索引；保持历史记录通过 `deleted_at`。
  - `storage_variant` 取值建议：`RAW`（原始文件）、`WEB`（标准预览）、`THUMB`（缩略图）、`SHARE`（带水印分享版），必要时可扩展，如需新增必须同步更新枚举与文档。
  - `short_code` 规则：Base62 编码、长度 6~8 字符，冲突重试次数 ≥3；对外展示统一前缀 `https://filmtrip.app/s/{short_code}`。
  - 若需要区分 RAW / WEB / THUMB，可将现有 `photos` 拆分为主表（元数据）+ 版本表，或直接在单表以 `storage_variant` 记录。
  - 数据迁移策略：新增列默认 NULL，批量回写旧文件的哈希/路径，逐步填充 `short_code`。
  - **历史数据治理**：对 `is_protected`、`effective_protection` 等字段执行一次性清洗，将 `0`/`1`/`'0'`/`'1'` 等值统一转换为布尔或 ENUM；同步修正导入脚本，避免再次写入非规范值。

- **后端服务**
  - 新建工具模块 `storage/namingService.js`：
    - 生成 UUID、三层哈希目录、构造 `{env}/{variant}/{prefix}/{uuid}.{ext}`。
    - 负责 Base62 短码生成与冲突重试。
    - 提供 `calcHashes(buffer)` 返回 `sha256` / `md5`。
  - 上传流程调整：
    1. 接收上传请求 → 读取文件 Buffer → 计算哈希 → 查询去重。
    2. 若重复，直接返回已有记录的短链与资源信息。
    3. 保存数据库记录（暂指向本地或 mock 存储路径）。
    4. 生成任务队列消息（为阶段二预留），例如 `image.process`。
  - 输出结构调整：`{ shortCode, storageVariant, bucket, objectPath, hashes }`。

- **前端**
  - 上传组件（`frontend/src/views/FilmStockManagement.jsx` 等）适配新的响应结构，展示短链/版本信息。
  - 若前端后续需要直接上传，在阶段一可模拟：先上传到后端，再由后端提供将被 UpYun 使用的路径，以便结构一致。

- **工具链与文档**
  - 更新 `docs/specifications/命名与短链规范.md`（已补充上传链路原则）。
  - 在 `docs/work-plans/2025-11-07/summary.md` 记录阶段一排期与验收标准。
  - 准备数据迁移脚本说明文档。
  - 暂时仍写本地磁盘时，`origin_bucket` 统一填 `local-dev`，`origin_path` 使用 `{env}/{variant}/{prefix}/{uuid}.{ext}`，确保迁移脚本可以直接替换根路径。

### 2.2 阶段二：CDN/UpYun 直传（第二步）

- 前端通过后端 API 获取临时上传凭证、目标路径、Policy 等信息。
- 前端直传 UpYun，上传完成后触发 UpYun 回调 → 后端校验签名 → 更新数据库记录（写入最终 URL、状态）。
- 对象存储侧配置自动生成多版本（原图/WEB/THUMB/WebP/水印），或由离线任务调用 UpYun 图片处理接口生成。
- 分享相关接口默认返回水印版本 URL，仅管理员接口返回原图。
- 在 CDN 阶段技术文档中补充 UpYun 图片处理参数示例（如 `!/format/webp`、`!/watermark/text/...`）与免费额度说明（基础包含 15GB/月，满足当前需求）。

## 3. 关联改动点

- **数据库**：`backend/models/db.js` 迁移脚本、Schema 定义、索引；必要时同步更新 `docs/design/数据库设计.md`。
- **后端控制器**：`backend/controllers/photoController.js`、`backend/routes/uploads.js`（如存在）、后续新增 `storage/namingService.js`。
- **公共库**：若存在 `utils/file.js` 等工具需升级。
- **前端**：上传入口（后台管理、用户上传页面）、任何依赖旧字段的展示组件。
- **配置**：`.env` 或 `config/*.js` 新增 `STORAGE_ENV`、`DEFAULT_BUCKET` 等。
- **CI/CD**：数据库迁移命令、环境变量同步、回滚脚本。

## 4. 任务清单

| 编号 | 描述 | 负责角色 | 依赖 |
|------|------|----------|------|
| NAMING-1 | 梳理现有上传/存储流程，输出详细差异清单 | @architect | 无 |
| NAMING-2 | 设计数据库迁移方案并提交脚本（含回滚） | @backend | NAMING-1 |
| NAMING-3 | 实现 `namingService`、哈希去重、短链生成 | @backend | NAMING-2 |
| NAMING-4 | 调整上传 API 输出、更新文档 | @backend、@documenter | NAMING-3 |
| NAMING-5 | 前端适配新字段与短链展示 | @frontend | NAMING-4 |
| NAMING-6 | 数据迁移执行与校验 | @devops、@tester | NAMING-2 |
| NAMING-7 | 命名规范阶段性验收（代码审查+文档对比） | @reviewer | NAMING-1..6 |
| CDN-1 | UpYun 直传方案设计与凭证签发 | @architect、@backend | NAMING 阶段完成 |
| CDN-2 | UpYun 前端直传与回调落地 | @frontend、@backend | CDN-1 |
| CDN-3 | 水印/多版本交付与分享链路 | @frontend、@backend | CDN-2 |

## 5. 测试用例

### 5.1 阶段一（命名与存储）

- **去重测试**
  - 上传相同文件两次 → 返回同一 `shortCode`、`file_hash`，仅记录一次。
  - 上传原图 + 缩略图（不同内容） → `file_hash` 不同，可分别入库。
- **短链唯一性**
  - 批量上传 10,000 张模拟文件，确保 `short_code` 无冲突；构造冲突时自动重试成功。
- **版本区分**
  - 同一 `photo_id` 下 `storage_variant` 正确区分 RAW/WEB/THUMB；读取接口返回对应 URL。
- **逻辑删除**
  - 标记 `deleted_at` 后，资源在前端列表隐藏，但保留短链查询能力（用于分享历史）。
- **迁移兼容**
  - 迁移后旧记录在未生成短链时能正常读取，且后台提醒执行补齐任务。

### 5.2 阶段二（UpYun，后续执行）

- **凭证签发**
  - 在网络离线/凭证过期时，前端能捕获错误并提示重新获取。
- **直传链路**
  - 上传大文件（>50MB）仍能完成；断点续传或失败重试策略验证。
- **回调校验**
  - 伪造回调请求被拒绝；合法回调写入 DB 且写入的哈希与上传前一致。
- **多版本生成**
  - 检查 UpYun 任务完成后，各版本 URL 可用；分享接口默认返回水印版。

## 6. 风险与回退策略

- **风险**
  - 数据迁移错误导致旧照片无法访问 → 需要灰度与备份。
  - 哈希去重逻辑若实现不当会误判不同文件为重复。
  - 短链冲突处理需确保高并发下稳定。
- **回退**
  - 保持旧上传接口及字段若迁移失败可快速切回；数据库迁移提供 `DOWN` 脚本。
  - 阶段一完成但阶段二延迟时，仍可继续使用旧的本地存储作为临时方案（只对开发环境保留）。

## 7. 验收标准

1. 所有上传记录均具备 `file_hash`、`storage_variant`、`short_code` 字段，并与规范一致。
2. 前端上传与展示流程可正常工作，短链可访问对应资源。
3. 迁移脚本执行日志、回滚脚本、测试报告入库。
4. 通过 @reviewer 的交叉审查，并在 `docs/work-plans/2025-11-07/summary.md` 更新验收结论。
5. 完成后再启动 UpYun 接入（CDN-阶段），以此文档作为后续任务的基线。

---

> **备注**：阶段二（UpYun 直传及水印/多格式生成）将在命名规范落地后立即启动，相关细节将追加在另行的 CDN 技术方案文档中，并引用此文档作为先决条件。

