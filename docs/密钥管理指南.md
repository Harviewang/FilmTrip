# FilmTrip 密钥管理指南

## 📖 概述

本文档说明FilmTrip项目的密钥管理体系，包括密钥存储、使用方法和安全规范。

## 🗂️ 密钥存储位置

所有敏感密钥统一存储在：
```
project/credentials/
├── secrets.conf        # 主密钥配置文件
├── load-secrets.sh     # 密钥加载脚本  
├── README.md           # 详细使用说明
└── .gitignore          # 确保不会被Git追踪
```

⚠️ **重要**: 此目录已添加到`.gitignore`，不会被提交到Git仓库。

## 🔑 包含的密钥类型

### 云服务商
- **阿里云**: AccessKey用于DNS管理、ECS服务器、域名操作
- **Vercel**: Token用于自动部署
- **又拍云**: 操作员账号用于CDN和存储
- **Cloudflare**: API Token用于CDN和DNS管理

### 应用密钥
- JWT密钥
- 数据库连接字符串
- 第三方API密钥
- 支付密钥

## 📝 使用方法

### 1. 加载密钥到环境变量

```bash
# 在项目根目录执行
source project/credentials/load-secrets.sh
```

### 2. 在脚本中使用密钥

```bash
# 示例: 配置DNS
ALIYUN_ACCESS_KEY_ID=$ALIYUN_ACCESS_KEY_ID \
ALIYUN_ACCESS_KEY_SECRET=$ALIYUN_ACCESS_KEY_SECRET \
node setup-aliyun-dns.js
```

### 3. Node.js项目中读取

方式1 - 从环境变量读取（推荐）:
```javascript
const config = {
  accessKeyId: process.env.ALIYUN_ACCESS_KEY_ID,
  accessKeySecret: process.env.ALIYUN_ACCESS_KEY_SECRET
};
```

方式2 - 使用专门的配置加载函数:
```javascript
// 在项目启动时
if (process.env.NODE_ENV === 'production') {
  require('./project/credentials/load-secrets')();
}
```

## 🛡️ 安全规范

### ✅ 必须遵守

1. **永远不要将密钥提交到Git**
   - 已配置`.gitignore`保护
   - 提交前检查`git status`

2. **定期轮换密钥**
   - 生产环境密钥每3-6个月更换
   - 发现泄露立即更换

3. **使用最小权限原则**
   - 为每个服务创建独立的子账号
   - 只授予必要的权限
   - 开发/测试/生产环境使用不同密钥

4. **启用多因素认证**
   - 云服务主账号必须启用MFA
   - API密钥设置IP白名单

### ❌ 绝对禁止

1. 在代码中硬编码密钥
2. 通过聊天工具发送密钥
3. 截图包含密钥的内容
4. 在公共网络环境使用
5. 保存在云笔记或在线文档

## 🔧 密钥获取指南

### 阿里云AccessKey

1. 登录 [RAM控制台](https://ram.console.aliyun.com/users)
2. 创建RAM用户（不要用主账号）
3. 授予权限:
   - `AliyunDNSFullAccess` - DNS管理
   - `AliyunECSReadOnlyAccess` - ECS查看
4. 创建AccessKey并保存

### Vercel Token

1. 登录 [Vercel Account Tokens](https://vercel.com/account/tokens)
2. 点击 "Create Token"
3. 设置权限和过期时间
4. 复制Token立即保存（只显示一次）

### Cloudflare API Token

1. 登录 [Cloudflare API Tokens](https://dash.cloudflare.com/profile/api-tokens)
2. 点击 "Create Token"
3. 选择模板或自定义权限
4. 设置IP过滤（可选）
5. 保存Token

## 🆘 密钥泄露应急流程

如果密钥不慎泄露，立即执行：

1. **停用泄露的密钥**（优先级最高）
   - 登录对应服务控制台
   - 删除或禁用密钥

2. **生成新密钥**
   - 创建新的密钥对
   - 更新`secrets.conf`

3. **重新部署服务**
   - 使用新密钥重新部署
   - 验证服务正常

4. **检查影响范围**
   - 查看API调用日志
   - 检查是否有异常操作

5. **记录和总结**
   - 记录泄露事件
   - 分析原因
   - 改进流程

## 📋 密钥清单

| 服务 | 密钥类型 | 用途 | 重要性 | 最后更新 |
|------|---------|------|--------|---------|
| 阿里云 | AccessKey | DNS/ECS/域名 | 🔴高 | 2025-10-24 |
| Vercel | Token | 自动部署 | 🟡中 | 待配置 |
| 又拍云 | 账号密码 | CDN/存储 | 🟡中 | 待配置 |
| Cloudflare | API Token | CDN/DNS | 🟡中 | 待配置 |

## 🔗 相关文档

- [project/credentials/README.md](../project/credentials/README.md) - 详细的密钥管理文档
- [setup-aliyun-dns.js](../setup-aliyun-dns.js) - 阿里云DNS配置示例
- [project/scripts/check-vercel-access.js](../project/scripts/check-vercel-access.js) - Vercel访问检查工具

## 📞 支持与反馈

如有问题或建议，请联系项目负责人。

---

**最后更新**: 2025-10-24  
**文档版本**: v1.0  
**维护人员**: Harview

